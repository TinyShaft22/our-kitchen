---
phase: 14-meal-images
plan: 02
type: execute
---

<objective>
Add image editing to EditMealModal and display images on MealCard.

Purpose: Complete the meal images feature by enabling edit/replace of images and showing them on meal cards.
Output: EditMealModal supports image upload/replace, MealCard displays meal image thumbnails.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/14-meal-images/14-01-SUMMARY.md

# Key files to modify:
@src/components/meals/EditMealModal.tsx
@src/components/meals/MealCard.tsx

**Tech stack available:** React, TypeScript, Tailwind, Firebase Storage
**Established patterns:**
- Image upload with compression from 14-01
- Modal from bottom pattern for data entry
- Expandable section pattern on MealCard (from Phase 13)

**Constraining decisions:**
- Phase 14-01: Image compression helper, Firebase Storage path structure
- Phase 13: Optional field approach, expandable sections on MealCard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image editing to EditMealModal</name>
  <files>src/components/meals/EditMealModal.tsx</files>
  <action>
Mirror the image upload functionality from AddMealModal:

1. Add imports at top:
   - `import { ref, uploadBytes, getDownloadURL, deleteObject } from 'firebase/storage'`
   - `import { storage } from '../../config/firebase'`

2. Add state for image handling:
   - `const [imageFile, setImageFile] = useState<File | null>(null)`
   - `const [imagePreview, setImagePreview] = useState<string | null>(meal.imageUrl || null)`
   - `const [removeImage, setRemoveImage] = useState(false)` (track if user wants to remove existing image)

3. Copy the compressImage helper from AddMealModal (or extract to a shared util later)

4. Add image selection handler (same as AddMealModal):
   ```typescript
   const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
     const file = e.target.files?.[0];
     if (file) {
       setImageFile(file);
       setImagePreview(URL.createObjectURL(file));
       setRemoveImage(false);
     }
   };
   ```

5. Add image removal handler:
   ```typescript
   const handleRemoveImage = () => {
     setImageFile(null);
     setImagePreview(null);
     setRemoveImage(true); // Mark for deletion on save
   };
   ```

6. Add image upload section in form (same placement as AddMealModal - after Baking Toggle, before Instructions):
   - Show current image preview if imagePreview exists
   - "Change Photo" button to select new image
   - "Remove Photo" button to clear image (only if imagePreview exists)

7. Update useEffect to sync imagePreview with meal.imageUrl when meal changes:
   ```typescript
   setImagePreview(meal.imageUrl || null);
   setRemoveImage(false);
   setImageFile(null);
   ```

8. Modify handleSave logic:
   - If imageFile exists (new image selected):
     - Compress and upload to Storage
     - Include new imageUrl in onSave
   - If removeImage is true (user cleared the image):
     - Include `imageUrl: undefined` in onSave (to remove from Firestore)
     - Optionally delete old image from Storage (if meal.imageUrl existed)
   - If neither (no change to image):
     - Keep existing meal.imageUrl in onSave
  </action>
  <verify>npm run build passes, can edit a meal and change/remove its image</verify>
  <done>EditMealModal supports viewing, changing, and removing meal images</done>
</task>

<task type="auto">
  <name>Task 2: Display image on MealCard</name>
  <files>src/components/meals/MealCard.tsx</files>
  <action>
Add meal image display to MealCard:

1. Modify the card structure to show image when present:
   - If meal.imageUrl exists, show image at top of card
   - Image should be: w-full h-32 object-cover rounded-t-soft
   - Adjust card structure so content sits below image

2. Update the card JSX:
   ```tsx
   <div className="bg-white rounded-soft shadow-soft overflow-hidden">
     {/* Image thumbnail at top */}
     {meal.imageUrl && (
       <img
         src={meal.imageUrl}
         alt={meal.name}
         className="w-full h-32 object-cover"
       />
     )}

     {/* Existing card content */}
     <div className="p-4">
       {/* ... existing name, servings, edit/delete buttons ... */}
     </div>

     {/* Existing expandable instructions section */}
     {/* ... */}
   </div>
   ```

3. Ensure cards without images look unchanged (no empty space or broken image)

4. Loading state consideration: The image URL is a Firebase Storage URL that loads asynchronously.
   - Consider adding a subtle loading state or placeholder, OR
   - Simply let the browser handle it naturally (image loads when available)
  </action>
  <verify>npm run dev, view meals with images showing thumbnail at top of card, meals without images look normal</verify>
  <done>MealCard displays image thumbnail when meal has imageUrl, unchanged appearance for meals without images</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` works, app loads
- [ ] Can edit existing meal and add/change/remove image
- [ ] MealCard shows image thumbnail at top when meal has image
- [ ] MealCard without image looks normal (no broken image or extra space)
- [ ] Image changes persist after save (reload page to confirm)
</verification>

<success_criteria>

- EditMealModal supports image upload, replace, and removal
- MealCard displays meal images as thumbnails
- Existing meals without images display correctly
- No TypeScript errors or build warnings
- Phase 14 complete - full meal images feature working
</success_criteria>

<output>
After completion, create `.planning/phases/14-meal-images/14-02-SUMMARY.md`
</output>

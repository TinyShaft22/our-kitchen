---
phase: 14-meal-images
plan: 01
type: execute
---

<objective>
Set up Firebase Storage and add image upload capability to meals.

Purpose: Allow Nick and Bella to attach photos to meals for visual reference when cooking and meal planning.
Output: Firebase Storage initialized, Meal type has imageUrl field, AddMealModal supports image upload.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (meal patterns established):
@.planning/phases/04-meal-library/04-02-SUMMARY.md
@.planning/phases/13-recipe-instructions/13-01-SUMMARY.md

# Key files to modify:
@src/config/firebase.ts
@src/types/index.ts
@src/components/meals/AddMealModal.tsx

**Tech stack available:** React, TypeScript, Tailwind, Firebase (Firestore, Functions, Storage)
**Established patterns:**
- Modal from bottom pattern for data entry (AddMealModal, EditMealModal)
- Optional fields on Meal type (like instructions) for backwards compatibility
- Firebase config already has storageBucket env var

**Constraining decisions:**
- Phase 13: Optional field approach to support existing meals without migration
- Phase 4: Modal patterns for meal CRUD established

**Design notes:**
- imageUrl is optional (existing meals won't have images)
- Store images in Firebase Storage under `meals/{householdCode}/{mealId}/{filename}`
- Compress images client-side before upload (max 800px width, JPEG quality 0.8)
- Use HTML5 file input with accept="image/*" for camera/gallery access on mobile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Firebase Storage and add imageUrl to Meal type</name>
  <files>src/config/firebase.ts, src/types/index.ts</files>
  <action>
1. In src/config/firebase.ts:
   - Import `getStorage` from 'firebase/storage'
   - Initialize storage: `const storage = getStorage(app)`
   - Export storage alongside app, db, functions

2. In src/types/index.ts:
   - Add `imageUrl?: string` field to Meal interface (optional to support existing meals)
   - Place it after `instructions` field
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>Firebase Storage exported from config, Meal type has optional imageUrl field</done>
</task>

<task type="auto">
  <name>Task 2: Add image upload to AddMealModal</name>
  <files>src/components/meals/AddMealModal.tsx</files>
  <action>
Add image capture/upload capability to AddMealModal:

1. Add imports at top:
   - `import { ref, uploadBytes, getDownloadURL } from 'firebase/storage'`
   - `import { storage } from '../../config/firebase'`

2. Add state for image handling:
   - `const [imageFile, setImageFile] = useState<File | null>(null)`
   - `const [imagePreview, setImagePreview] = useState<string | null>(null)`

3. Add helper function for image compression (before upload):
   ```typescript
   const compressImage = async (file: File): Promise<Blob> => {
     return new Promise((resolve, reject) => {
       const img = new Image();
       img.onload = () => {
         const canvas = document.createElement('canvas');
         const maxWidth = 800;
         let width = img.width;
         let height = img.height;

         if (width > maxWidth) {
           height = (height * maxWidth) / width;
           width = maxWidth;
         }

         canvas.width = width;
         canvas.height = height;
         const ctx = canvas.getContext('2d');
         ctx?.drawImage(img, 0, 0, width, height);
         canvas.toBlob(
           (blob) => blob ? resolve(blob) : reject(new Error('Failed to compress')),
           'image/jpeg',
           0.8
         );
       };
       img.onerror = reject;
       img.src = URL.createObjectURL(file);
     });
   };
   ```

4. Add image selection handler:
   ```typescript
   const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
     const file = e.target.files?.[0];
     if (file) {
       setImageFile(file);
       setImagePreview(URL.createObjectURL(file));
     }
   };
   ```

5. Add image upload section in form (after Baking Toggle, before Instructions):
   - Label: "Photo (optional)"
   - Hidden file input: `<input type="file" accept="image/*" capture="environment" />`
   - Visible button: "Add Photo" or "Change Photo" if preview exists
   - Show image preview (max-h-48, rounded-soft) if imagePreview is set
   - Add "Remove" button to clear image

6. Modify handleSave to upload image if selected:
   - If imageFile exists:
     - Generate unique filename: `${Date.now()}.jpg`
     - Compress the image using compressImage helper
     - Upload to Storage: `meals/{householdCode}/{mealId}/{filename}` (use placeholder mealId for now, or generate UUID)
     - Get download URL
     - Include `imageUrl` in onSave call
   - If no imageFile, omit imageUrl (don't pass undefined explicitly)

7. Update resetForm to clear imageFile and imagePreview, revoke object URL if exists
  </action>
  <verify>npm run build passes, npm run dev works, can select image from camera/gallery and see preview in modal</verify>
  <done>AddMealModal has image upload with preview, compressed images ready to upload to Firebase Storage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` works, app loads
- [ ] Firebase Storage is exported from config
- [ ] Meal type has optional imageUrl field
- [ ] AddMealModal shows "Add Photo" button
- [ ] Selecting image shows preview in modal
- [ ] Can remove selected image before saving
</verification>

<success_criteria>

- Firebase Storage initialized and exported
- Meal type extended with optional imageUrl field
- AddMealModal has working image selection with preview
- Image compression helper ready for upload
- No TypeScript errors or build warnings
</success_criteria>

<output>
After completion, create `.planning/phases/14-meal-images/14-01-SUMMARY.md`
</output>

---
phase: 33-secure-api-keys
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/config.ts
  - functions/src/index.ts
  - functions/src/alexa/index.ts
  - functions/src/alexa/verifyPin.ts
  - functions/src/alexa/meals.ts
  - functions/src/alexa/recipe.ts
  - functions/src/alexa/groceryList.ts
  - functions/src/alexa/addGroceryItem.ts
  - functions/src/alexa/removeGroceryItem.ts
  - functions/src/alexa/checkDuplicateGrocery.ts
  - functions/src/alexa/lookupHouseholdItem.ts
  - our-kitchen-alexa/lambda/api/firebaseClient.js
autonomous: true

must_haves:
  truths:
    - "API key is not visible in source code"
    - "Cloud Functions authenticate requests using environment variable"
    - "Lambda authenticates requests using environment variable"
    - "Deployed functions work identically to before"
  artifacts:
    - path: "functions/src/config.ts"
      provides: "Centralized config access for API key"
      exports: ["getApiKey"]
    - path: "functions/.env"
      provides: "Local development environment variables"
      contains: "ALEXA_API_KEY"
  key_links:
    - from: "functions/src/alexa/*.ts"
      to: "functions/src/config.ts"
      via: "import getApiKey"
      pattern: "import.*getApiKey.*from.*config"
    - from: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      to: "process.env.ALEXA_API_KEY"
      via: "environment variable"
      pattern: "process\\.env\\.ALEXA_API_KEY"
---

<objective>
Remove hardcoded API key (`ourkitchen2024`) from all source files and replace with environment variables.

Purpose: Secure API authentication by moving secrets out of version control. Prepares codebase for certification and production deployment.

Output: All Cloud Functions and Lambda code reads API key from environment variables instead of hardcoded strings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v2.1-ROADMAP.md

@functions/src/index.ts
@functions/src/alexa/verifyPin.ts
@our-kitchen-alexa/lambda/api/firebaseClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared config module and update Cloud Functions</name>
  <files>
    functions/src/config.ts
    functions/src/index.ts
    functions/src/alexa/index.ts
    functions/src/alexa/verifyPin.ts
    functions/src/alexa/meals.ts
    functions/src/alexa/recipe.ts
    functions/src/alexa/groceryList.ts
    functions/src/alexa/addGroceryItem.ts
    functions/src/alexa/removeGroceryItem.ts
    functions/src/alexa/checkDuplicateGrocery.ts
    functions/src/alexa/lookupHouseholdItem.ts
    functions/.env
    functions/.env.example
  </files>
  <action>
    1. Create `functions/src/config.ts` with centralized config access:
       - Export `getApiKey()` function that reads from `process.env.ALEXA_API_KEY`
       - Throw clear error if env var is missing (fail fast)
       - Use Firebase Functions v2 pattern (env vars via process.env)

    2. Create `functions/.env` for local development:
       - Add `ALEXA_API_KEY=ourkitchen2024` (local dev value)
       - This file is gitignored and not committed

    3. Create `functions/.env.example` as template:
       - Add `ALEXA_API_KEY=your-api-key-here`
       - This IS committed to show required variables

    4. Update `functions/src/index.ts`:
       - Import `getApiKey` from `./config`
       - Replace `const API_KEY = "ourkitchen2024"` with `const API_KEY = getApiKey()`
       - Move call to after function definition to avoid initialization order issues

    5. Update all 8 alexa endpoint files (`verifyPin.ts`, `meals.ts`, `recipe.ts`, `groceryList.ts`, `addGroceryItem.ts`, `removeGroceryItem.ts`, `checkDuplicateGrocery.ts`, `lookupHouseholdItem.ts`):
       - Import `getApiKey` from `../config`
       - Replace `const API_KEY = "ourkitchen2024"` with lazy evaluation in handler
       - Use `const apiKeyFromEnv = getApiKey()` inside handler function (not at module level)
       - Compare against `apiKeyFromEnv` instead of `API_KEY`

    6. Update `functions/src/alexa/index.ts`:
       - Remove the comment mentioning the hardcoded key value
       - Change to "All endpoints require X-API-Key header with valid API key"

    Why lazy evaluation: Firebase Functions v2 loads env vars at runtime. Module-level constants evaluated at import time may not have env vars available yet. Reading inside handler ensures env is loaded.
  </action>
  <verify>
    - `grep -r "ourkitchen2024" functions/src/` returns no matches
    - `cat functions/src/config.ts` shows getApiKey function
    - `cat functions/.env.example` shows ALEXA_API_KEY placeholder
    - TypeScript compiles: `cd functions && npm run build`
  </verify>
  <done>
    No hardcoded API key strings in Cloud Functions source. All endpoints read from ALEXA_API_KEY environment variable via shared config module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Lambda to use environment variable</name>
  <files>
    our-kitchen-alexa/lambda/api/firebaseClient.js
  </files>
  <action>
    1. Update `firebaseClient.js`:
       - Replace `const API_KEY = 'ourkitchen2024'` with `const API_KEY = process.env.ALEXA_API_KEY`
       - Add validation: throw error if env var is missing
       - Update the axios client creation to handle missing key gracefully

    2. Document the Lambda environment variable requirement:
       - The Alexa-Hosted Skill environment variable is set via ASK CLI or Developer Console
       - Add comment in firebaseClient.js explaining setup

    Note: Alexa-Hosted Skills support environment variables via the Lambda configuration in the Developer Console (Build > Code > Lambda environment variables).
  </action>
  <verify>
    - `grep "ourkitchen2024" our-kitchen-alexa/lambda/api/firebaseClient.js` returns no matches
    - `grep "process.env.ALEXA_API_KEY" our-kitchen-alexa/lambda/api/firebaseClient.js` returns match
  </verify>
  <done>
    Lambda reads API key from ALEXA_API_KEY environment variable. No hardcoded secrets in Lambda code.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document deployment process and verify gitignore</name>
  <files>
    functions/.gitignore
    .planning/phases/33-secure-api-keys/DEPLOYMENT.md
  </files>
  <action>
    1. Verify `functions/.gitignore` includes `.env`:
       - Check if `.env` is already in gitignore
       - Add it if missing

    2. Create `DEPLOYMENT.md` in phase directory documenting:
       - How to set ALEXA_API_KEY for Cloud Functions deployment:
         - Firebase Functions v2 uses `--set-env-vars` flag or `.env` file in functions directory
         - Command: `firebase deploy --only functions` (reads from functions/.env)
         - For production: Set via Firebase Console or `firebase functions:secrets:set`
       - How to set ALEXA_API_KEY for Lambda:
         - Alexa Developer Console > Build > Code > Environment Variables
         - Or via ASK CLI: `ask smapi update-skill-manifest`
       - Include rollback steps if deployment fails

    3. Verify no secrets will be committed:
       - Check `git status` shows `.env` as untracked (if created)
       - Confirm `.env.example` will be tracked
  </action>
  <verify>
    - `grep ".env" functions/.gitignore` shows .env is ignored
    - `cat .planning/phases/33-secure-api-keys/DEPLOYMENT.md` shows deployment instructions
    - `git status functions/.env` shows file as untracked or ignored
  </verify>
  <done>
    Deployment process documented. Local .env file is gitignored. Team knows how to set API key in both Cloud Functions and Lambda environments.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **No hardcoded secrets:**
   ```bash
   grep -r "ourkitchen2024" functions/src/ our-kitchen-alexa/lambda/
   # Should return no matches
   ```

2. **Cloud Functions build:**
   ```bash
   cd functions && npm run build
   # Should complete without errors
   ```

3. **Config module exists:**
   ```bash
   cat functions/src/config.ts
   # Should show getApiKey function
   ```

4. **Environment template exists:**
   ```bash
   cat functions/.env.example
   # Should show ALEXA_API_KEY=your-api-key-here
   ```
</verification>

<success_criteria>
- Zero occurrences of "ourkitchen2024" in source code
- All Cloud Functions import and use getApiKey() from config module
- Lambda reads from process.env.ALEXA_API_KEY
- functions/.env is gitignored
- functions/.env.example is committed with placeholder
- Deployment documentation exists
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-secure-api-keys/33-01-SUMMARY.md` using the summary template.

Include:
- Files modified (10 Cloud Functions files + 1 Lambda file)
- Config pattern used (lazy evaluation for Firebase Functions v2)
- Deployment instructions location
</output>

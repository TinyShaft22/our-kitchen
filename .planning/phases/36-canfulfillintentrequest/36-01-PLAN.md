# Phase 36-01: CanFulfillIntentRequest Handler

---
phase: 36-canfulfillintentrequest
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - our-kitchen-alexa/lambda/handlers/CanFulfillHandler.js
  - our-kitchen-alexa/lambda/index.js
  - our-kitchen-alexa/skill-package/skill.json
  - our-kitchen-alexa/test-cfir-request.json
autonomous: true

must_haves:
  truths:
    - "CFIR returns YES for BrowseMealsIntent"
    - "CFIR returns YES for GetRecipeIntent"
    - "CFIR returns YES for BrowseCategoryIntent"
    - "CFIR returns YES for ReadGroceryListIntent"
    - "CFIR returns YES for AddGroceryIntent"
    - "CFIR returns YES for MarkAsLowIntent"
    - "CFIR returns YES for StartCookingIntent"
    - "CFIR returns YES for RemoveGroceryIntent"
    - "CFIR returns YES for CheckOffGroceryIntent"
    - "CFIR returns NO for AMAZON.* built-in intents"
    - "CFIR returns NO for unrecognized intents"
  artifacts:
    - path: "our-kitchen-alexa/lambda/handlers/CanFulfillHandler.js"
      provides: "CanFulfillIntentRequestHandler"
      exports: ["CanFulfillIntentRequestHandler"]
    - path: "our-kitchen-alexa/skill-package/skill.json"
      provides: "CAN_FULFILL_INTENT_REQUEST interface declaration"
      contains: "CAN_FULFILL_INTENT_REQUEST"
  key_links:
    - from: "our-kitchen-alexa/lambda/index.js"
      to: "CanFulfillHandler.js"
      via: "require and addRequestHandlers"
      pattern: "CanFulfillIntentRequestHandler"
---

## Objective

Implement CanFulfillIntentRequest handler for Name-Free Interaction (NFI) so Alexa can query whether Our Kitchen can handle specific user requests without explicit skill invocation.

## Context

NFI allows users to speak naturally without saying "Alexa, ask Our Kitchen...". When a user says something like "what's for dinner", Alexa queries multiple skills via CanFulfillIntentRequest to determine which can handle the request. The handler must be fast (no Firebase calls), stateless, and return YES for our supported intents, NO for everything else.

Per the research (36-RESEARCH.md), the implementation requires:
1. A Lambda handler that responds to `CanFulfillIntentRequest` request type
2. Manifest update to declare `CAN_FULFILL_INTENT_REQUEST` interface
3. Handler must NOT make external API calls or modify any state

## Tasks

<task id="1" type="auto">
  <name>Create CanFulfillHandler.js</name>
  <files>our-kitchen-alexa/lambda/handlers/CanFulfillHandler.js</files>
  <action>
Create a new handler file with CanFulfillIntentRequestHandler that:

1. canHandle: Returns true when request type is 'CanFulfillIntentRequest'

2. handle:
   - Extract intent name using `Alexa.getIntentName()`
   - Define supported intents array:
     - BrowseMealsIntent
     - GetRecipeIntent
     - BrowseCategoryIntent
     - ReadGroceryListIntent
     - AddGroceryIntent
     - MarkAsLowIntent
     - StartCookingIntent
     - RemoveGroceryIntent
     - CheckOffGroceryIntent
     - UndoGroceryIntent
   - Return `{ canFulfill: 'YES' }` for supported intents
   - Return `{ canFulfill: 'NO' }` for all others (AMAZON.* intents, unknown intents)
   - Include slot responses if slots present (canUnderstand: YES if value exists, MAYBE otherwise; canFulfill: YES)
   - Use `responseBuilder.withCanFulfillIntent()` to build response

Critical constraints from research:
- NO Firebase calls (CFIR must respond in under 2 seconds)
- NO state modifications (read-only query)
- NO audio or visual output

Add logging: `console.log('CFIR received for intent:', intentName)` and `console.log('CFIR response:', JSON.stringify(response))`

Export: `module.exports = { CanFulfillIntentRequestHandler };`
  </action>
  <verify>
File exists at `our-kitchen-alexa/lambda/handlers/CanFulfillHandler.js` with exported CanFulfillIntentRequestHandler.
Handler has canHandle checking for 'CanFulfillIntentRequest' request type.
Supported intents array contains all 10 custom intents.
  </verify>
  <done>
CanFulfillHandler.js exists with correct handler implementation that returns YES for supported intents and NO for others.
  </done>
</task>

<task id="2" type="auto">
  <name>Update skill.json manifest</name>
  <files>our-kitchen-alexa/skill-package/skill.json</files>
  <action>
Add CAN_FULFILL_INTENT_REQUEST to the interfaces array in skill.json.

In `manifest.apis.custom.interfaces`, add a new object:
```json
{
  "type": "CAN_FULFILL_INTENT_REQUEST"
}
```

The interfaces array already has ALEXA_PRESENTATION_APL, so add this as a second item.

Do NOT modify any other parts of skill.json.
  </action>
  <verify>
`grep -c "CAN_FULFILL_INTENT_REQUEST" our-kitchen-alexa/skill-package/skill.json` returns 1.
skill.json is valid JSON (use `node -e "require('./our-kitchen-alexa/skill-package/skill.json')"`).
  </verify>
  <done>
skill.json contains CAN_FULFILL_INTENT_REQUEST interface declaration and remains valid JSON.
  </done>
</task>

<task id="3" type="auto">
  <name>Register handler and deploy</name>
  <files>our-kitchen-alexa/lambda/index.js, our-kitchen-alexa/test-cfir-request.json</files>
  <action>
1. Update index.js:
   - Add import: `const { CanFulfillIntentRequestHandler } = require('./handlers/CanFulfillHandler');`
   - Add handler to addRequestHandlers() - place it FIRST in the list (before LaunchRequestHandler) so it catches CFIR before other handlers

2. Create test-cfir-request.json for ASK CLI testing:
```json
{
  "version": "1.0",
  "session": {},
  "context": {
    "System": {
      "application": {
        "applicationId": "amzn1.ask.skill.xxx"
      }
    }
  },
  "request": {
    "type": "CanFulfillIntentRequest",
    "requestId": "test-request-id",
    "intent": {
      "name": "AddGroceryIntent",
      "slots": {
        "GroceryItem": {
          "name": "GroceryItem",
          "value": "milk"
        }
      }
    },
    "locale": "en-US"
  }
}
```

3. Deploy to Alexa:
   - `cd our-kitchen-alexa && git add . && git commit -m "feat(36): add CanFulfillIntentRequest handler for NFI" && git push`
  </action>
  <verify>
index.js imports CanFulfillHandler and registers CanFulfillIntentRequestHandler as first handler.
test-cfir-request.json exists and is valid JSON.
Git push completes successfully (triggers Alexa-Hosted deployment).
  </verify>
  <done>
Handler registered in index.js, test file created, changes deployed to Alexa-Hosted skill.
  </done>
</task>

## Verification

After all tasks complete:

- [ ] `grep "CanFulfillIntentRequestHandler" our-kitchen-alexa/lambda/index.js` shows import and registration
- [ ] `grep "CAN_FULFILL_INTENT_REQUEST" our-kitchen-alexa/skill-package/skill.json` returns match
- [ ] Handler file exists: `ls our-kitchen-alexa/lambda/handlers/CanFulfillHandler.js`
- [ ] Test file exists: `ls our-kitchen-alexa/test-cfir-request.json`
- [ ] Git status shows committed changes
- [ ] No syntax errors: `cd our-kitchen-alexa/lambda && node -e "require('./index.js')"`

## Success Criteria

- CanFulfillIntentRequestHandler responds to CanFulfillIntentRequest type
- Returns YES for 10 supported custom intents (BrowseMeals, GetRecipe, BrowseCategory, ReadGroceryList, AddGrocery, MarkAsLow, StartCooking, RemoveGrocery, CheckOffGrocery, UndoGrocery)
- Returns NO for built-in AMAZON.* intents and unknown intents
- skill.json declares CAN_FULFILL_INTENT_REQUEST interface
- Handler registered as first in chain (catches CFIR before other handlers)
- Changes deployed to Alexa-Hosted skill

## Output

After completion, create `.planning/phases/36-canfulfillintentrequest/36-01-SUMMARY.md` using the summary template.

---
phase: 28-cooking-mode
plan: 03
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - our-kitchen-alexa/lambda/apl/recipe-detail.json
  - our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
  - our-kitchen-alexa/lambda/apl/recipe-detail-data.js
  - our-kitchen-alexa/lambda/index.js
autonomous: true

must_haves:
  truths:
    - "Recipe detail screen shows a 'Start Cooking' button"
    - "Tapping 'Start Cooking' button enters cooking mode at Step 0"
    - "Swiping steps in cooking mode updates session state"
    - "Tapping 'Exit' or back button returns to recipe detail"
  artifacts:
    - path: "our-kitchen-alexa/lambda/apl/recipe-detail.json"
      provides: "Updated APL with Start Cooking button"
      contains: "StartCooking"
    - path: "our-kitchen-alexa/lambda/handlers/AplEventHandlers.js"
      provides: "APL event handlers for cooking mode touch"
      exports: ["StartCookingEventHandler", "StepChangedEventHandler", "ExitCookingModeEventHandler"]
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/AplEventHandlers.js"
      to: "apl/cooking-step.json"
      via: "RenderDocument in StartCookingEventHandler"
      pattern: "cookingStepToken"
    - from: "our-kitchen-alexa/lambda/apl/recipe-detail.json"
      to: "AplEventHandlers.js"
      via: "SendEvent StartCooking"
      pattern: "SendEvent.*StartCooking"
---

<objective>
Add touch controls for cooking mode: Start Cooking button on recipe detail and APL event handlers for touch navigation.

Purpose: Enable touch-based entry to cooking mode from recipe detail screen. Users can tap "Start Cooking" instead of saying the command, and swipe through steps on the pager.

Output:
- Updated recipe-detail.json with Start Cooking button
- APL event handlers for StartCooking, StepChanged, ExitCookingMode
- Updated index.js with new event handlers
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-cooking-mode/28-CONTEXT.md
@.planning/phases/28-cooking-mode/28-01-SUMMARY.md (after Plan 01 completes)
@our-kitchen-alexa/lambda/apl/recipe-detail.json
@our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
@our-kitchen-alexa/lambda/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Start Cooking button to recipe-detail.json</name>
  <files>
    our-kitchen-alexa/lambda/apl/recipe-detail.json
  </files>
  <action>
Update recipe-detail.json to add a "Start Cooking" button that triggers cooking mode.

**Changes to our-kitchen-alexa/lambda/apl/recipe-detail.json:**

Add a button container at the bottom of the layout, after the instructions section but inside the main content container.

**Add this as a new item in the main Container's items array (after the row/column for ingredients/instructions):**

```json
{
  "type": "Container",
  "width": "100%",
  "alignItems": "center",
  "paddingTop": "@spacingMedium",
  "paddingBottom": "@spacingMedium",
  "items": [
    {
      "type": "TouchWrapper",
      "id": "startCookingButton",
      "onPress": {
        "type": "SendEvent",
        "arguments": ["StartCooking", "${recipeDetailData.mealId}"]
      },
      "items": [
        {
          "type": "Frame",
          "backgroundColor": "@colorAccent",
          "borderRadius": "8dp",
          "paddingLeft": "@spacingLarge",
          "paddingRight": "@spacingLarge",
          "paddingTop": "@spacingSmall",
          "paddingBottom": "@spacingSmall",
          "items": [
            {
              "type": "Text",
              "text": "Start Cooking",
              "style": "textStyleBody",
              "fontWeight": "bold",
              "color": "#FFFFFF"
            }
          ]
        }
      ]
    }
  ]
}
```

**Also update the datasource binding** - the recipe-detail-data.js needs to pass mealId. But first check if it already does (it should have the recipe object which has id).

Actually, since recipe-detail-data.js only passes mealName, imageUrl, ingredients, instructions - we need to also pass the mealId.

**Update recipe-detail-data.js** to include mealId:
```javascript
// Add to the return object in buildRecipeDetailDataSource:
mealId: recipe.id || '',
```

**Full recipe-detail.json structure after changes:**
The main Container items array should be:
1. AlexaHeader (existing)
2. Container with row/column for ingredients + instructions (existing)
3. NEW: Container with centered Start Cooking button

Place the button container as the last item in the main vertical Container, so it appears at the bottom of the recipe view.
  </action>
  <verify>
Verify APL JSON is valid and has button:
```bash
cd our-kitchen-alexa/lambda && node -e "
const doc = JSON.parse(require('fs').readFileSync('./apl/recipe-detail.json'));
console.log('Has StartCooking:', JSON.stringify(doc).includes('StartCooking'));
console.log('Has TouchWrapper:', JSON.stringify(doc).includes('TouchWrapper'));
"
```
  </verify>
  <done>Recipe detail APL has Start Cooking button that triggers SendEvent</done>
</task>

<task type="auto">
  <name>Task 2: Add APL event handlers for cooking mode touch</name>
  <files>
    our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
    our-kitchen-alexa/lambda/apl/recipe-detail-data.js
  </files>
  <action>
Update AplEventHandlers.js to handle cooking mode touch events.

**First, update recipe-detail-data.js** to include mealId:

```javascript
// In buildRecipeDetailDataSource function, add to return object:
mealId: recipe.id || '',
```

**Then add these handlers to AplEventHandlers.js:**

**Required imports at top of file:**

```javascript
const { parseInstructionsToSteps } = require('../util/stepParser');
const cookingStepDocument = require('../apl/cooking-step.json');
const { buildCookingStepDataSource } = require('../apl/cooking-step-data');
const recipeDetailDocument = require('../apl/recipe-detail.json');
const { buildRecipeDetailDataSource } = require('../apl/recipe-detail-data');
```

**1. StartCookingEventHandler**

Handles touch on "Start Cooking" button from recipe detail.

```javascript
const StartCookingEventHandler = {
  canHandle(handlerInput) {
    const request = handlerInput.requestEnvelope.request;
    return request.type === 'Alexa.Presentation.APL.UserEvent'
      && request.arguments
      && request.arguments[0] === 'StartCooking';
  },
  async handle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();

    // Get recipe from session (set when viewing recipe detail)
    const recipe = sessionAttributes.currentRecipe;
    if (!recipe || !recipe.name) {
      return handlerInput.responseBuilder
        .speak("I'm not sure which recipe to cook. Try selecting a recipe first.")
        .reprompt("What recipe would you like to cook?")
        .getResponse();
    }

    // Parse steps
    const steps = parseInstructionsToSteps(recipe.instructions || '', recipe.ingredients || []);

    // Store cooking mode state
    sessionAttributes.cookingMode = true;
    sessionAttributes.cookingSteps = steps;
    sessionAttributes.cookingStep = 0;
    sessionAttributes.cookingRecipe = recipe;
    handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

    // Build voice output for Step 0 (ingredients)
    const ingredientList = (recipe.ingredients || []).map(i => i.name).join(', ');
    const speakOutput = `Let's make ${recipe.name}. First, gather your ingredients: ${ingredientList}. Swipe right or say 'next step' when ready.`;

    // Add APL cooking view
    handlerInput.responseBuilder.addDirective({
      type: 'Alexa.Presentation.APL.RenderDocument',
      token: 'cookingStepToken',
      document: cookingStepDocument,
      datasources: buildCookingStepDataSource(recipe, 0)
    });

    return handlerInput.responseBuilder
      .speak(speakOutput)
      .reprompt("Say 'next step' to continue, or 'stop' to exit.")
      .getResponse();
  }
};
```

**2. StepChangedEventHandler**

Handles swipe navigation on the step pager.

```javascript
const StepChangedEventHandler = {
  canHandle(handlerInput) {
    const request = handlerInput.requestEnvelope.request;
    return request.type === 'Alexa.Presentation.APL.UserEvent'
      && request.arguments
      && request.arguments[0] === 'StepChanged';
  },
  handle(handlerInput) {
    const args = handlerInput.requestEnvelope.request.arguments;
    const newPageIndex = args[1]; // Page index from Pager onPageChanged

    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const steps = sessionAttributes.cookingSteps || [];

    // Update current step
    sessionAttributes.cookingStep = newPageIndex;
    handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

    const step = steps[newPageIndex];
    if (!step) {
      return handlerInput.responseBuilder
        .speak("Something went wrong. Say 'repeat' to try again.")
        .reprompt("What would you like to do?")
        .getResponse();
    }

    const isLastStep = newPageIndex === steps.length - 1;
    let speakOutput;

    if (isLastStep && !step.isIngredients) {
      speakOutput = `${step.content} <break time="500ms"/> You're done! Enjoy your meal.`;
    } else {
      speakOutput = `${step.title}. ${step.content}`;
    }

    return handlerInput.responseBuilder
      .speak(speakOutput)
      .reprompt("Say 'next step', 'previous step', or 'repeat'.")
      .getResponse();
  }
};
```

**3. ExitCookingModeEventHandler**

Handles back button press from cooking mode to return to recipe detail.

**IMPORTANT:** This handler needs imports for recipeDetailDocument and buildRecipeDetailDataSource to render the recipe detail view when exiting.

```javascript
const ExitCookingModeEventHandler = {
  canHandle(handlerInput) {
    const request = handlerInput.requestEnvelope.request;
    return request.type === 'Alexa.Presentation.APL.UserEvent'
      && request.arguments
      && request.arguments[0] === 'ExitCookingMode';
  },
  handle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const recipe = sessionAttributes.cookingRecipe || sessionAttributes.currentRecipe;

    // Clear cooking mode state
    sessionAttributes.cookingMode = false;
    sessionAttributes.cookingSteps = null;
    sessionAttributes.cookingStep = 0;
    handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

    // If we have recipe, return to recipe detail
    if (recipe) {
      const speakOutput = `Back to ${recipe.name}. Would you like me to read the ingredients, read the instructions, or start cooking mode?`;

      // Uses recipeDetailDocument and buildRecipeDetailDataSource (imported at top)
      handlerInput.responseBuilder.addDirective({
        type: 'Alexa.Presentation.APL.RenderDocument',
        token: 'recipeDetailToken',
        document: recipeDetailDocument,
        datasources: buildRecipeDetailDataSource(recipe)
      });

      return handlerInput.responseBuilder
        .speak(speakOutput)
        .reprompt("What would you like to do?")
        .getResponse();
    }

    return handlerInput.responseBuilder
      .speak("You've exited cooking mode. What would you like to do?")
      .reprompt("Try asking what's for dinner.")
      .getResponse();
  }
};
```

**Update exports:**
```javascript
module.exports = {
  MealSelectedEventHandler,
  StartCookingEventHandler,
  StepChangedEventHandler,
  ExitCookingModeEventHandler
};
```
  </action>
  <verify>
Verify AplEventHandlers loads:
```bash
cd our-kitchen-alexa/lambda && node -e "
const h = require('./handlers/AplEventHandlers');
console.log('Exports:', Object.keys(h).join(', '));
"
```
  </verify>
  <done>APL event handlers handle Start Cooking touch, step swipe, and exit</done>
</task>

<task type="auto">
  <name>Task 3: Update index.js to register new APL event handlers</name>
  <files>
    our-kitchen-alexa/lambda/index.js
  </files>
  <action>
Update index.js to import and register the new APL event handlers.

**Changes to our-kitchen-alexa/lambda/index.js:**

1. Update the import from AplEventHandlers to include new handlers:
```javascript
const {
  MealSelectedEventHandler,
  StartCookingEventHandler,
  StepChangedEventHandler,
  ExitCookingModeEventHandler
} = require('./handlers/AplEventHandlers');
```

2. Add the new handlers to addRequestHandlers().

Place them near MealSelectedEventHandler (after it):
```javascript
.addRequestHandlers(
    // ... existing handlers ...
    MealSelectedEventHandler,
    StartCookingEventHandler,     // NEW
    StepChangedEventHandler,      // NEW
    ExitCookingModeEventHandler,  // NEW
    HelloWorldIntentHandler,
    // ... rest of handlers ...
)
```
  </action>
  <verify>
Verify full Lambda loads:
```bash
cd our-kitchen-alexa/lambda && node -e "
require('./index.js');
console.log('Lambda loaded successfully');
"
```
  </verify>
  <done>APL event handlers registered in index.js</done>
</task>

</tasks>

<verification>
All touch navigation components integrated:

1. recipe-detail.json has Start Cooking button:
```bash
grep "StartCooking" our-kitchen-alexa/lambda/apl/recipe-detail.json
```

2. AplEventHandlers exports all handlers:
```bash
cd our-kitchen-alexa/lambda && node -e "
const h = require('./handlers/AplEventHandlers');
console.log('StartCooking:', typeof h.StartCookingEventHandler);
console.log('StepChanged:', typeof h.StepChangedEventHandler);
console.log('ExitCooking:', typeof h.ExitCookingModeEventHandler);
"
```

3. index.js imports and registers handlers:
```bash
grep "StartCookingEventHandler" our-kitchen-alexa/lambda/index.js
grep "StepChangedEventHandler" our-kitchen-alexa/lambda/index.js
```

4. Full Lambda validation:
```bash
cd our-kitchen-alexa/lambda && node -e "require('./index.js')"
```
</verification>

<success_criteria>
- Recipe detail screen shows "Start Cooking" button
- Tapping button enters cooking mode at Step 0 with APL pager
- Swiping pager updates session state and reads step aloud
- Back button from cooking mode returns to recipe detail
- Lambda loads successfully
</success_criteria>

<output>
After completion, create `.planning/phases/28-cooking-mode/28-03-SUMMARY.md`
</output>

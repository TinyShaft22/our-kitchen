---
phase: 28-cooking-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - our-kitchen-alexa/lambda/util/stepParser.js
  - our-kitchen-alexa/lambda/apl/cooking-step.json
  - our-kitchen-alexa/lambda/apl/cooking-step-data.js
autonomous: true

must_haves:
  truths:
    - "Instructions markdown is parsed into discrete numbered steps"
    - "Ingredients are shown as Step 0 before cooking begins"
    - "Echo Show displays a single step at a time in a pager format"
    - "Current step number and total steps are visible"
  artifacts:
    - path: "our-kitchen-alexa/lambda/util/stepParser.js"
      provides: "Step parsing utility for markdown instructions"
      exports: ["parseInstructionsToSteps"]
    - path: "our-kitchen-alexa/lambda/apl/cooking-step.json"
      provides: "APL document for step-by-step cooking display"
      contains: "Pager"
    - path: "our-kitchen-alexa/lambda/apl/cooking-step-data.js"
      provides: "DataSource builder for cooking steps"
      exports: ["buildCookingStepDataSource"]
  key_links:
    - from: "our-kitchen-alexa/lambda/apl/cooking-step-data.js"
      to: "util/stepParser.js"
      via: "uses parseInstructionsToSteps"
      pattern: "parseInstructionsToSteps"
---

<objective>
Create foundation for cooking mode: step parser utility and APL document with datasource builder.

Purpose: Enable hands-free step-by-step recipe navigation on Echo Show. Users see one step at a time with ingredients as "Step 0" before cooking begins.

Output:
- Step parser utility that splits markdown instructions into discrete steps
- APL document with pager for step-by-step display
- DataSource builder that formats steps for APL
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-cooking-mode/28-CONTEXT.md
@.planning/phases/27-apl-recipe-detail/27-01-SUMMARY.md
@our-kitchen-alexa/lambda/apl/recipe-detail.json
@our-kitchen-alexa/lambda/apl/recipe-detail-data.js
</context>

<notes>
**Deferred per CONTEXT.md (Claude's discretion):**
- Auto-splitting long steps into sub-steps (A, B, C parts) - implement if obviously needed during execution, otherwise skip for MVP
- Sub-step splitting threshold determination

**Deferred to Phase 30:**
- In-skill timers ("Set timer for 10 minutes")
</notes>

<tasks>

<task type="auto">
  <name>Task 1: Create step parser utility</name>
  <files>
    our-kitchen-alexa/lambda/util/stepParser.js
  </files>
  <action>
Create a step parser utility that converts markdown recipe instructions into discrete steps.

**File: our-kitchen-alexa/lambda/util/stepParser.js**

Export function `parseInstructionsToSteps(instructions, ingredients)`:
- Input: instructions (string, markdown), ingredients (array of {name})
- Output: array of step objects {number, title, content, isIngredients}

**Step parsing logic:**

1. Create Step 0 (ingredients):
   - number: 0
   - title: "Ingredients"
   - content: formatted bullet list of ingredient names
   - isIngredients: true

2. Parse instructions into steps using these strategies (in priority order):
   a. **Numbered list format** - If instructions contain "1." or "1)" patterns:
      - Split by numbered patterns (1., 2., etc. or 1), 2), etc.)
      - Each numbered item becomes a step
   b. **Paragraph format** - If no numbered patterns found:
      - Split by double newlines (paragraphs)
      - Each non-empty paragraph becomes a step
   c. **Fallback** - If still only one block:
      - Treat entire instructions as single "Step 1"

3. Number steps starting from 1 (after ingredients at 0)

4. Step titles: "Step 1", "Step 2", etc.

5. Handle edge cases:
   - Empty/null instructions: return just ingredients step
   - Very short instructions (< 20 chars): single step
   - Remove markdown headers (## lines) as they're usually titles

**Example:**
```javascript
parseInstructionsToSteps(
  "1. Preheat oven to 350.\n2. Mix ingredients.\n3. Bake 25 min.",
  [{name: "flour"}, {name: "sugar"}]
)
// Returns:
// [
//   {number: 0, title: "Ingredients", content: "- flour\n- sugar", isIngredients: true},
//   {number: 1, title: "Step 1", content: "Preheat oven to 350.", isIngredients: false},
//   {number: 2, title: "Step 2", content: "Mix ingredients.", isIngredients: false},
//   {number: 3, title: "Step 3", content: "Bake 25 min.", isIngredients: false}
// ]
```
  </action>
  <verify>
Test the parser:
```bash
cd our-kitchen-alexa/lambda && node -e "
const {parseInstructionsToSteps} = require('./util/stepParser');

// Test numbered list
const steps1 = parseInstructionsToSteps('1. Preheat oven.\n2. Mix dry.\n3. Bake.', [{name:'flour'}]);
console.log('Numbered:', steps1.length, 'steps');

// Test paragraphs
const steps2 = parseInstructionsToSteps('First do this.\n\nThen do that.\n\nFinally serve.', []);
console.log('Paragraphs:', steps2.length, 'steps');

// Test empty
const steps3 = parseInstructionsToSteps('', [{name:'butter'}]);
console.log('Empty:', steps3.length, 'steps');
"
```
  </verify>
  <done>Step parser correctly splits instructions into discrete steps with ingredients as Step 0</done>
</task>

<task type="auto">
  <name>Task 2: Create APL document for cooking step pager</name>
  <files>
    our-kitchen-alexa/lambda/apl/cooking-step.json
  </files>
  <action>
Create an APL document for step-by-step cooking mode display.

**File: our-kitchen-alexa/lambda/apl/cooking-step.json**

Design requirements:
- APL version 2024.3
- Import alexa-layouts 1.7.0 and alexa-viewport-profiles 1.6.0
- Same custom colors as recipe-detail.json (dark theme #1A1A1A, terracotta accent #C4704B)
- Use Pager component for swipeable step navigation
- Display one step at a time with large readable text

**Layout structure:**

```
AlexaHeader (title: recipe name, subtitle: "Step X of Y")
  |
Pager (id: "stepPager", data: steps array)
  |
  +-- Container (for each step)
        |
        +-- Text: Step title (large, accent color)
        +-- ScrollView: Step content (body text, scrollable for long steps)
        +-- TouchWrapper (optional): Nav hints at bottom
```

**Key properties:**

1. AlexaHeader:
   - headerTitle: "${cookingData.mealName}"
   - headerSubtitle: "Step ${cookingData.currentStep + 1} of ${cookingData.totalSteps}"
   - headerBackButton: true (exits cooking mode)
   - headerBackButtonCommand: SendEvent["ExitCookingMode"]

2. Pager:
   - id: "stepPager"
   - initialPage: "${cookingData.currentStep}"
   - data: "${cookingData.steps}"
   - onPageChanged: SendEvent["StepChanged", event.source.page]
   - navigation: "normal" (allows swipe)

3. Step container (repeated for each step):
   - Step title: large text with accent color
   - Step content: body text in ScrollView (long steps may scroll)
   - Use padding for readability

4. Navigation hints (optional, at bottom):
   - "Swipe or say 'next step'"

**Touch navigation:**
- Swipe left/right on Pager handles navigation
- Back button exits cooking mode
- Page changes trigger SendEvent to update session state
  </action>
  <verify>
Validate APL JSON:
```bash
cd our-kitchen-alexa/lambda && node -e "
const doc = JSON.parse(require('fs').readFileSync('./apl/cooking-step.json'));
console.log('Type:', doc.type);
console.log('Version:', doc.version);
console.log('Imports:', doc.import.map(i => i.name).join(', '));
console.log('Has Pager:', JSON.stringify(doc).includes('Pager'));
"
```
  </verify>
  <done>APL document displays steps in a pager with header showing current step progress</done>
</task>

<task type="auto">
  <name>Task 3: Create datasource builder for cooking steps</name>
  <files>
    our-kitchen-alexa/lambda/apl/cooking-step-data.js
  </files>
  <action>
Create a datasource builder that transforms recipe data into cooking mode APL format.

**File: our-kitchen-alexa/lambda/apl/cooking-step-data.js**

Export function `buildCookingStepDataSource(recipe, currentStep = 0)`:
- Input: recipe object (from Firebase), currentStep index
- Output: APL datasource object

**Implementation:**

```javascript
const { parseInstructionsToSteps } = require('../util/stepParser');

function buildCookingStepDataSource(recipe, currentStep = 0) {
  // Parse instructions into steps
  const steps = parseInstructionsToSteps(
    recipe.instructions || '',
    recipe.ingredients || []
  );

  return {
    cookingData: {
      type: 'object',
      objectId: 'cookingStepDS',
      mealName: recipe.name || 'Recipe',
      currentStep: Math.max(0, Math.min(currentStep, steps.length - 1)),
      totalSteps: steps.length,
      steps: steps.map(step => ({
        number: step.number,
        title: step.title,
        content: step.content,
        isIngredients: step.isIngredients
      }))
    }
  };
}

module.exports = { buildCookingStepDataSource };
```

**Key features:**
- Uses stepParser utility for consistent parsing
- Clamps currentStep to valid range
- Provides totalSteps for progress display
- Each step has number, title, content, isIngredients flag
  </action>
  <verify>
Test datasource builder:
```bash
cd our-kitchen-alexa/lambda && node -e "
const {buildCookingStepDataSource} = require('./apl/cooking-step-data');

const recipe = {
  name: 'Test Cookies',
  ingredients: [{name: 'flour'}, {name: 'sugar'}, {name: 'butter'}],
  instructions: '1. Mix dry ingredients.\n2. Add wet ingredients.\n3. Form cookies.\n4. Bake at 350 for 12 min.'
};

const ds = buildCookingStepDataSource(recipe, 0);
console.log('Meal:', ds.cookingData.mealName);
console.log('Total steps:', ds.cookingData.totalSteps);
console.log('Steps:', ds.cookingData.steps.map(s => s.title));
"
```
  </verify>
  <done>DataSource builder transforms recipe into cooking steps with progress tracking</done>
</task>

</tasks>

<verification>
All cooking mode foundation components exist:

1. Step parser utility:
   - node -e "require('./our-kitchen-alexa/lambda/util/stepParser')"

2. APL cooking step document:
   - ls our-kitchen-alexa/lambda/apl/cooking-step.json

3. DataSource builder:
   - node -e "require('./our-kitchen-alexa/lambda/apl/cooking-step-data')"

4. Integration test:
```bash
cd our-kitchen-alexa/lambda && node -e "
const {buildCookingStepDataSource} = require('./apl/cooking-step-data');
const recipe = {
  name: 'Test',
  ingredients: [{name: 'a'}],
  instructions: '1. First step.\n2. Second step.'
};
const ds = buildCookingStepDataSource(recipe);
console.log('OK - Steps:', ds.cookingData.steps.length);
"
```
</verification>

<success_criteria>
- Step parser splits markdown into discrete steps
- Ingredients shown as Step 0
- APL document uses Pager for swipeable navigation
- Header shows "Step X of Y" progress
- DataSource builder integrates parser output
- All files load without errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-cooking-mode/28-01-SUMMARY.md`
</output>

---
phase: 32-household-items
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - functions/src/alexa/lookupHouseholdItem.ts
  - functions/src/alexa/index.ts
  - functions/src/index.ts
  - our-kitchen-alexa/lambda/api/firebaseClient.js
  - our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
autonomous: true

must_haves:
  truths:
    - "Alexa can lookup saved household items by name"
    - "When user says 'add paper towels', saved item's store/category are used"
    - "Items not in household library get default pantry/safeway assignment"
    - "Case-insensitive matching works for voice input"
  artifacts:
    - path: "functions/src/alexa/lookupHouseholdItem.ts"
      provides: "Cloud Function to lookup household item by name"
      exports: ["lookupHouseholdItem"]
    - path: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      provides: "Client function for household item lookup"
      contains: "lookupHouseholdItem"
    - path: "our-kitchen-alexa/lambda/handlers/GroceryHandlers.js"
      provides: "Enhanced AddGroceryIntentHandler with lookup"
      contains: "lookupHouseholdItem"
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/GroceryHandlers.js"
      to: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      via: "lookupHouseholdItem import"
      pattern: "lookupHouseholdItem"
    - from: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      to: "Cloud Functions"
      via: "HTTP GET request"
      pattern: "client.get.*lookupHouseholdItem"
---

<objective>
Add Alexa integration for household items - lookup saved items by voice and use their defaults when adding to grocery list.

Purpose: When user says "add paper towels", Alexa looks up if "paper towels" exists in their household items library. If found, uses the saved store/category. If not found, uses default pantry/safeway. This makes voice adds smarter for frequently-purchased items.

Output: lookupHouseholdItem Cloud Function, firebaseClient integration, enhanced AddGroceryIntentHandler.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-household-items/32-RESEARCH.md
@.planning/phases/32-household-items/32-01-SUMMARY.md

Reference patterns:
@functions/src/alexa/addGroceryItem.ts (Cloud Function pattern)
@functions/src/alexa/index.ts (exports pattern)
@our-kitchen-alexa/lambda/api/firebaseClient.js (client pattern)
@our-kitchen-alexa/lambda/handlers/GroceryHandlers.js (AddGroceryIntentHandler to enhance)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lookupHouseholdItem Cloud Function</name>
  <files>
    functions/src/alexa/lookupHouseholdItem.ts
    functions/src/alexa/index.ts
    functions/src/index.ts
  </files>
  <action>
Create the Cloud Function following the pattern in addGroceryItem.ts:

**functions/src/alexa/lookupHouseholdItem.ts:**
```typescript
import { onRequest } from "firebase-functions/v2/https";
import { getApps, initializeApp } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore";

function ensureInitialized() {
  if (getApps().length === 0) {
    initializeApp();
  }
}

const API_KEY = "ourkitchen2024";

/**
 * GET /lookupHouseholdItem - Lookup a saved household item by name
 *
 * Query params: { householdCode: string, item: string }
 * Response: { found: boolean, item?: { name, store, category, brand?, notes? } }
 *
 * Uses nameLower field for case-insensitive matching.
 */
export const lookupHouseholdItem = onRequest({ cors: true, invoker: "public" }, async (req, res) => {
  ensureInitialized();

  // CORS headers
  res.set("Access-Control-Allow-Origin", "*");
  res.set("Access-Control-Allow-Methods", "GET, OPTIONS");
  res.set("Access-Control-Allow-Headers", "Content-Type, X-API-Key");

  if (req.method === "OPTIONS") {
    res.status(204).send("");
    return;
  }

  if (req.method !== "GET") {
    res.status(405).json({ found: false, error: "Method not allowed" });
    return;
  }

  // Check API key
  const apiKey = req.headers["x-api-key"] || req.query.apiKey;
  if (apiKey !== API_KEY) {
    res.status(401).json({ found: false, error: "Invalid API key" });
    return;
  }

  try {
    const householdCode = req.query.householdCode as string;
    const itemName = req.query.item as string;

    if (!householdCode || !itemName) {
      res.status(400).json({ found: false, error: "Missing householdCode or item" });
      return;
    }

    const db = getFirestore();
    const normalizedName = itemName.trim().toLowerCase();

    // Query by nameLower for case-insensitive match
    const snapshot = await db.collection("householdItems")
      .where("householdCode", "==", householdCode)
      .where("nameLower", "==", normalizedName)
      .limit(1)
      .get();

    if (snapshot.empty) {
      res.status(200).json({ found: false });
      return;
    }

    const doc = snapshot.docs[0];
    const data = doc.data();

    res.status(200).json({
      found: true,
      item: {
        id: doc.id,
        name: data.name,
        store: data.store,
        category: data.category,
        brand: data.brand || null,
        notes: data.notes || null
      }
    });
  } catch (error) {
    console.error("lookupHouseholdItem error:", error);
    res.status(500).json({ found: false, error: "Internal server error" });
  }
});
```

**Update functions/src/alexa/index.ts:**
Add export: `export { lookupHouseholdItem } from "./lookupHouseholdItem";`

**Update functions/src/index.ts:**
The alexa exports should already re-export everything from alexa/index.ts. Verify lookupHouseholdItem is accessible.
  </action>
  <verify>
1. File exists: `ls functions/src/alexa/lookupHouseholdItem.ts`
2. Exported from index: `grep -n "lookupHouseholdItem" functions/src/alexa/index.ts`
3. Functions build: `cd functions && npm run build 2>&1 | tail -10`
  </verify>
  <done>lookupHouseholdItem Cloud Function exists and exports from functions/src/alexa/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add lookupHouseholdItem to firebaseClient.js</name>
  <files>our-kitchen-alexa/lambda/api/firebaseClient.js</files>
  <action>
Add the lookupHouseholdItem function to the Lambda's Firebase client:

```javascript
async function lookupHouseholdItem(householdCode, item) {
  const response = await client.get('/lookupHouseholdItem', {
    params: { householdCode, item }
  });
  return response.data;
}
```

Add to module.exports: `lookupHouseholdItem`
  </action>
  <verify>
1. Function exists: `grep -n "async function lookupHouseholdItem" our-kitchen-alexa/lambda/api/firebaseClient.js`
2. Exported: `grep -n "lookupHouseholdItem" our-kitchen-alexa/lambda/api/firebaseClient.js | grep "module.exports"`
  </verify>
  <done>firebaseClient.js exports lookupHouseholdItem function</done>
</task>

<task type="auto">
  <name>Task 3: Enhance AddGroceryIntentHandler with household lookup</name>
  <files>our-kitchen-alexa/lambda/handlers/GroceryHandlers.js</files>
  <action>
Modify AddGroceryIntentHandler to lookup saved household items before adding:

1. Import lookupHouseholdItem in the require statement at top
2. In handle() method, after getting the item name from slots:

```javascript
// Lookup saved household item first
let savedItem = null;
try {
  const lookup = await lookupHouseholdItem(householdCode, item);
  if (lookup.found) {
    savedItem = lookup.item;
  }
} catch (lookupError) {
  // Lookup failed, proceed with defaults
  console.log('Household item lookup failed, using defaults:', lookupError.message);
}

// Use saved item name if found (preserves proper capitalization)
const itemName = savedItem ? savedItem.name : item;
```

3. Modify the duplicate check to use itemName: `await checkDuplicateGrocery(householdCode, itemName);`

4. Modify the addGroceryItem call to pass store/category if saved:

```javascript
// Add item - use saved defaults if found
let result;
if (savedItem) {
  result = await addGroceryItemWithDefaults(
    householdCode,
    savedItem.name,
    quantity,
    savedItem.store,
    savedItem.category
  );
} else {
  result = await addGroceryItem(householdCode, item, quantity);
}
```

5. Add addGroceryItemWithDefaults to firebaseClient.js:
```javascript
async function addGroceryItemWithDefaults(householdCode, item, quantity, store, category) {
  const response = await client.post('/addGroceryItem', {
    householdCode,
    item,
    quantity,
    store,     // Override default
    category   // Override default
  });
  return response.data;
}
```

6. Update functions/src/alexa/addGroceryItem.ts to accept optional store/category:
```typescript
const { householdCode, item, quantity, store, category } = req.body;
// ...
const groceryData = {
  name: item.trim(),
  householdCode,
  category: category || "pantry",  // Use provided or default
  store: store || "safeway",       // Use provided or default
  // ... rest unchanged
};
```

Note: If store/category are passed in the request body, use them. Otherwise fall back to defaults.
  </action>
  <verify>
1. Handler imports lookupHouseholdItem: `grep -n "lookupHouseholdItem" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js | head -3`
2. Handler calls lookup: `grep -n "await lookupHouseholdItem" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js`
3. addGroceryItemWithDefaults exists: `grep -n "addGroceryItemWithDefaults" our-kitchen-alexa/lambda/api/firebaseClient.js`
4. Cloud Function accepts store/category: `grep -n "store.*category" functions/src/alexa/addGroceryItem.ts`
  </verify>
  <done>AddGroceryIntentHandler looks up saved household items and uses their store/category when adding to grocery list</done>
</task>

</tasks>

<verification>
1. Cloud Functions build without errors
2. lookupHouseholdItem returns { found: true, item: {...} } for saved items
3. lookupHouseholdItem returns { found: false } for unknown items
4. AddGroceryIntentHandler uses saved store/category when item found
5. AddGroceryIntentHandler uses pantry/safeway defaults when item not found
</verification>

<success_criteria>
- lookupHouseholdItem Cloud Function deployed and working
- Lambda can lookup household items via firebaseClient
- "Add paper towels" uses saved store/category if paper towels is saved
- "Add random thing" uses default pantry/safeway since not saved
- Case-insensitive matching works (Paper Towels = paper towels = PAPER TOWELS)
</success_criteria>

<output>
After completion, create `.planning/phases/32-household-items/32-03-SUMMARY.md`
</output>

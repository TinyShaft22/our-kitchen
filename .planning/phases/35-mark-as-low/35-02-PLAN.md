---
phase: 35-mark-as-low
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json
  - our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js
  - our-kitchen-alexa/lambda/index.js
autonomous: true

must_haves:
  truths:
    - "User can say 'we're low on flour' to mark item as low"
    - "User can say 'mark flour as low' as alternative"
    - "Single match marks item and confirms"
    - "Multiple matches asks user to choose"
    - "Item not found offers to add to grocery anyway"
    - "Can optionally add item to grocery after marking low"
  artifacts:
    - path: "our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json"
      provides: "MarkAsLowIntent with slots and utterances"
      contains: "MarkAsLowIntent"
    - path: "our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js"
      provides: "Handler for mark as low intent and disambiguation"
      exports: ["MarkAsLowIntentHandler", "MarkAsLowDisambiguationHandler", "AddUnknownToGroceryHandler"]
    - path: "our-kitchen-alexa/lambda/index.js"
      provides: "Handler registration"
      contains: "MarkAsLowIntentHandler"
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js"
      to: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      via: "markAsLow import"
      pattern: "markAsLow"
    - from: "our-kitchen-alexa/lambda/index.js"
      to: "our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js"
      via: "handler import and registration"
      pattern: "MarkAsLowIntentHandler"
---

<objective>
Create the MarkAsLowIntent interaction model and Lambda handler for voice commands like "we're low on flour".

Purpose: Enable natural voice commands to mark baking/household items as low stock. Handles disambiguation when multiple items match (e.g., "flour" matches "all-purpose flour", "bread flour"), offers to add unknown items to grocery, and provides option to add marked items to shopping list.

Output: MarkAsLowIntent in interaction model, MarkAsLowHandlers.js with intent/disambiguation/add handlers, index.js registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-mark-as-low/35-CONTEXT.md
@.planning/phases/35-mark-as-low/35-01-SUMMARY.md

Reference patterns:
@our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json (intent pattern)
@our-kitchen-alexa/lambda/handlers/GroceryHandlers.js (handler pattern, disambiguation flow)
@our-kitchen-alexa/lambda/index.js (handler registration)
@our-kitchen-alexa/lambda/api/firebaseClient.js (markAsLow function from 35-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MarkAsLowIntent to interaction model</name>
  <files>our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json</files>
  <action>
Add MarkAsLowIntent to the intents array in the interaction model.

**Add this intent object after CheckOffGroceryIntent:**

```json
{
  "name": "MarkAsLowIntent",
  "slots": [
    {
      "name": "Item",
      "type": "AMAZON.Food"
    }
  ],
  "samples": [
    "we're low on {Item}",
    "we are low on {Item}",
    "mark {Item} as low",
    "{Item} is running low",
    "{Item} is low",
    "we're almost out of {Item}",
    "we are almost out of {Item}",
    "we're out of {Item}",
    "we are out of {Item}",
    "we need more {Item}",
    "running low on {Item}",
    "getting low on {Item}",
    "almost out of {Item}",
    "low on {Item}",
    "{Item} needs restocking"
  ]
}
```

Note: Using AMAZON.Food slot type which handles common food/ingredient names well. The backend does contains matching so "flour" will match "all-purpose flour", "bread flour", etc.
  </action>
  <verify>
1. Intent exists: `grep -n "MarkAsLowIntent" our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json`
2. Has Item slot: `grep -A5 "MarkAsLowIntent" our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json | grep "Item"`
3. JSON is valid: `node -e "JSON.parse(require('fs').readFileSync('our-kitchen-alexa/skill-package/interactionModels/custom/en-US.json'))"`
  </verify>
  <done>MarkAsLowIntent added to interaction model with Item slot and 15 sample utterances</done>
</task>

<task type="auto">
  <name>Task 2: Create MarkAsLowHandlers.js</name>
  <files>our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js</files>
  <action>
Create the handler file following GroceryHandlers.js pattern:

```javascript
/**
 * Mark As Low Handlers
 * Handle "we're low on {item}" voice commands
 * Searches baking inventory first, then household items
 * Handles disambiguation for multiple matches
 */
const Alexa = require('ask-sdk-core');
const { markAsLow, addGroceryItem, addGroceryItemWithDefaults } = require('../api/firebaseClient');
const { isLinked, getHouseholdCode } = require('../util/sessionHelper');
const { createPinPromptResponse } = require('./HouseholdHandlers');

/**
 * MarkAsLowIntentHandler
 * "We're low on flour" / "Mark butter as low" / "We're out of sugar"
 *
 * Flow:
 * 1. Search baking inventory (contains match)
 * 2. Single match -> mark as low, ask about adding to grocery
 * 3. Multiple matches -> ask to disambiguate
 * 4. No baking match -> search household items
 * 5. Household match -> confirm found, ask about adding to grocery
 * 6. No match -> offer to add to grocery anyway
 */
const MarkAsLowIntentHandler = {
  canHandle(handlerInput) {
    return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
      && Alexa.getIntentName(handlerInput.requestEnvelope) === 'MarkAsLowIntent';
  },

  async handle(handlerInput) {
    // Check if linked
    if (!isLinked(handlerInput)) {
      return createPinPromptResponse(handlerInput, 'MarkAsLow');
    }

    const householdCode = getHouseholdCode(handlerInput);
    const slots = handlerInput.requestEnvelope.request.intent.slots;
    const item = slots.Item?.value;

    if (!item) {
      return handlerInput.responseBuilder
        .speak("What item are you low on?")
        .reprompt("Say the name of the item you're running low on.")
        .getResponse();
    }

    try {
      const result = await markAsLow(householdCode, item);

      // Handle disambiguation needed
      if (result.needsDisambiguation) {
        const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
        sessionAttributes.pendingMarkAsLow = {
          originalItem: item,
          matches: result.matches
        };
        handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

        const matchNames = result.matches.map(m => m.name);
        const options = formatOptions(matchNames);

        return handlerInput.responseBuilder
          .speak(`I found ${matchNames.length} types of ${item}. Did you mean ${options}?`)
          .reprompt(`Which one? ${options}?`)
          .getResponse();
      }

      // Handle single match found
      if (result.success) {
        const markedItem = result.markedItem;
        const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();

        // Store for potential grocery add
        sessionAttributes.pendingGroceryFromLow = {
          name: markedItem.name,
          store: markedItem.store,
          category: markedItem.category || 'baking'
        };
        handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

        const sourceNote = result.source === 'baking' ? " in your baking supplies" : "";
        return handlerInput.responseBuilder
          .speak(`${markedItem.name} is marked as low${sourceNote}. Would you like me to add it to your shopping list?`)
          .reprompt("Should I add it to your grocery list?")
          .getResponse();
      }

      // Not found in baking or household items
      const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
      sessionAttributes.pendingUnknownItem = {
        name: item,
        store: 'safeway',
        category: 'pantry'
      };
      handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

      return handlerInput.responseBuilder
        .speak(`I don't have ${item} saved in your inventory. Would you like me to add it to your grocery list anyway?`)
        .reprompt("Say yes to add it to your shopping list, or no to cancel.")
        .getResponse();

    } catch (error) {
      console.log('Mark as low error:', error.message);
      return handlerInput.responseBuilder
        .speak("I'm having trouble checking your inventory right now. Try again in a moment.")
        .reprompt("What would you like to do?")
        .getResponse();
    }
  }
};

/**
 * MarkAsLowDisambiguationHandler
 * Handles user selection when multiple items match
 * Triggers on AMAZON.SearchQuery or specific item name after disambiguation prompt
 */
const MarkAsLowDisambiguationHandler = {
  canHandle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
      && sessionAttributes.pendingMarkAsLow
      && sessionAttributes.pendingMarkAsLow.matches;
  },

  async handle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const pending = sessionAttributes.pendingMarkAsLow;
    const householdCode = getHouseholdCode(handlerInput);

    // Try to extract what the user said
    let userChoice = null;

    // Check for direct slot value if using a specific intent
    const request = handlerInput.requestEnvelope.request;
    if (request.intent?.slots) {
      // Look for any slot that might have a value
      for (const slotName of Object.keys(request.intent.slots)) {
        if (request.intent.slots[slotName]?.value) {
          userChoice = request.intent.slots[slotName].value.toLowerCase();
          break;
        }
      }
    }

    // Match user choice against available options
    let selectedMatch = null;
    if (userChoice) {
      selectedMatch = pending.matches.find(m =>
        m.name.toLowerCase().includes(userChoice) ||
        userChoice.includes(m.name.toLowerCase())
      );
    }

    // If no match found and user said a number, try index
    if (!selectedMatch && userChoice) {
      const numberMatch = userChoice.match(/first|second|third|1|2|3|one|two|three/i);
      if (numberMatch) {
        const indexMap = { 'first': 0, '1': 0, 'one': 0, 'second': 1, '2': 1, 'two': 1, 'third': 2, '3': 2, 'three': 2 };
        const index = indexMap[numberMatch[0].toLowerCase()];
        if (index !== undefined && index < pending.matches.length) {
          selectedMatch = pending.matches[index];
        }
      }
    }

    if (!selectedMatch) {
      const matchNames = pending.matches.map(m => m.name);
      const options = formatOptions(matchNames);
      return handlerInput.responseBuilder
        .speak(`I didn't catch that. Which one: ${options}?`)
        .reprompt(`Please choose: ${options}`)
        .getResponse();
    }

    // Clear disambiguation state
    sessionAttributes.pendingMarkAsLow = null;

    try {
      // Mark the specific item
      const result = await markAsLow(householdCode, selectedMatch.name, selectedMatch.id);

      if (result.success) {
        // Store for potential grocery add
        sessionAttributes.pendingGroceryFromLow = {
          name: result.markedItem.name,
          store: result.markedItem.store,
          category: result.markedItem.category || 'baking'
        };
        handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

        return handlerInput.responseBuilder
          .speak(`${result.markedItem.name} is marked as low. Would you like me to add it to your shopping list?`)
          .reprompt("Should I add it to your grocery list?")
          .getResponse();
      }
    } catch (error) {
      console.log('Disambiguation mark error:', error.message);
    }

    return handlerInput.responseBuilder
      .speak("I couldn't mark that item. Try again.")
      .reprompt("What would you like to do?")
      .getResponse();
  }
};

/**
 * ConfirmAddFromLowHandler
 * Handles Yes/No response after marking item as low
 * Adds item to grocery list if confirmed
 */
const ConfirmAddFromLowHandler = {
  canHandle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const hasPendingLow = sessionAttributes.pendingGroceryFromLow || sessionAttributes.pendingUnknownItem;

    return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
      && (Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.YesIntent'
          || Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.NoIntent')
      && hasPendingLow;
  },

  async handle(handlerInput) {
    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const pendingItem = sessionAttributes.pendingGroceryFromLow || sessionAttributes.pendingUnknownItem;
    const isYes = Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.YesIntent';

    // Clear pending state
    sessionAttributes.pendingGroceryFromLow = null;
    sessionAttributes.pendingUnknownItem = null;
    handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

    if (!isYes) {
      return handlerInput.responseBuilder
        .speak("Okay. Anything else?")
        .reprompt("What would you like to do?")
        .getResponse();
    }

    // Add to grocery list
    const householdCode = getHouseholdCode(handlerInput);

    try {
      const result = await addGroceryItemWithDefaults(
        householdCode,
        pendingItem.name,
        null, // no quantity
        pendingItem.store,
        pendingItem.category
      );

      if (result.success) {
        return handlerInput.responseBuilder
          .speak(`Added ${pendingItem.name} to your grocery list. Anything else?`)
          .reprompt("What else would you like to do?")
          .getResponse();
      }
    } catch (error) {
      console.log('Add from low error:', error.message);
    }

    return handlerInput.responseBuilder
      .speak(`I couldn't add ${pendingItem.name} right now. Try again.`)
      .reprompt("What would you like to do?")
      .getResponse();
  }
};

/**
 * Format options for natural speech
 * ["a", "b", "c"] -> "a, b, or c"
 */
function formatOptions(items) {
  if (items.length === 0) return '';
  if (items.length === 1) return items[0];
  if (items.length === 2) return `${items[0]} or ${items[1]}`;
  const last = items[items.length - 1];
  const rest = items.slice(0, -1);
  return `${rest.join(', ')}, or ${last}`;
}

module.exports = {
  MarkAsLowIntentHandler,
  MarkAsLowDisambiguationHandler,
  ConfirmAddFromLowHandler
};
```
  </action>
  <verify>
1. File exists: `ls our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js`
2. All handlers exported: `grep "module.exports" our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js`
3. Imports markAsLow: `grep "markAsLow" our-kitchen-alexa/lambda/handlers/MarkAsLowHandlers.js | head -3`
  </verify>
  <done>MarkAsLowHandlers.js created with MarkAsLowIntentHandler, MarkAsLowDisambiguationHandler, and ConfirmAddFromLowHandler</done>
</task>

<task type="auto">
  <name>Task 3: Register handlers in index.js</name>
  <files>our-kitchen-alexa/lambda/index.js</files>
  <action>
1. Add import for MarkAsLowHandlers at the top with other handler imports:

```javascript
const {
  MarkAsLowIntentHandler,
  MarkAsLowDisambiguationHandler,
  ConfirmAddFromLowHandler
} = require('./handlers/MarkAsLowHandlers');
```

2. Add handlers to the addRequestHandlers chain. Place them:
   - MarkAsLowIntentHandler after CheckOffGroceryIntentHandler
   - MarkAsLowDisambiguationHandler right after MarkAsLowIntentHandler (before generic Yes/No handlers would trigger)
   - ConfirmAddFromLowHandler right after MarkAsLowDisambiguationHandler

The order matters because MarkAsLowDisambiguationHandler and ConfirmAddFromLowHandler use session state to determine if they should handle - they need to be registered before any fallback handlers.

Updated handler registration section should look like:
```javascript
.addRequestHandlers(
    LaunchRequestHandler,
    ResumeCookingIntentHandler,
    LinkHouseholdIntentHandler,
    BrowseMealsIntentHandler,
    GetRecipeIntentHandler,
    BrowseCategoryIntentHandler,
    StartCookingIntentHandler,
    NextStepIntentHandler,
    PreviousStepIntentHandler,
    RepeatStepIntentHandler,
    ExitCookingIntentHandler,
    ReadGroceryListIntentHandler,
    AddGroceryIntentHandler,
    ConfirmDuplicateIntentHandler,
    UndoGroceryIntentHandler,
    RemoveGroceryIntentHandler,
    CheckOffGroceryIntentHandler,
    MarkAsLowIntentHandler,              // New
    MarkAsLowDisambiguationHandler,      // New - handles selection after disambiguation
    ConfirmAddFromLowHandler,            // New - handles Yes/No after mark as low
    MealSelectedEventHandler,
    // ... rest of handlers
)
```
  </action>
  <verify>
1. Import exists: `grep -n "MarkAsLowHandlers" our-kitchen-alexa/lambda/index.js`
2. Handlers registered: `grep -n "MarkAsLowIntentHandler" our-kitchen-alexa/lambda/index.js`
3. No syntax errors: `node -e "require('./our-kitchen-alexa/lambda/index.js')" 2>&1 | head -5`
  </verify>
  <done>MarkAsLow handlers imported and registered in correct order in index.js</done>
</task>

</tasks>

<verification>
1. Interaction model has MarkAsLowIntent with Item slot and 15+ utterances
2. Interaction model JSON is valid
3. MarkAsLowIntentHandler handles "we're low on flour" correctly
4. Disambiguation works when "flour" matches multiple items
5. Confirmation flow asks about adding to grocery list
6. Unknown items offer to add to grocery anyway
7. All handlers registered in index.js in correct order
</verification>

<success_criteria>
- "We're low on flour" triggers MarkAsLowIntent and marks item
- Single baking match: "All-purpose flour is marked as low. Want me to add it to your shopping list?"
- Multiple matches: "I found 3 types of flour. Did you mean all-purpose flour, bread flour, or cake flour?"
- Not found: "I don't have flour saved. Would you like me to add it to your grocery list anyway?"
- Yes response adds item to grocery with saved store/category
- No response acknowledges and asks what's next
</success_criteria>

<output>
After completion, create `.planning/phases/35-mark-as-low/35-02-SUMMARY.md`
</output>

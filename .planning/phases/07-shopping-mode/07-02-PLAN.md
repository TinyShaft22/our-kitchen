---
phase: 07-shopping-mode
plan: 02
type: execute
---

<objective>
Add shopping progress tracking and trip completion to finalize shopping mode.

Purpose: Show progress while shopping and allow completing a trip (clearing purchased items).
Output: Progress indicator, "Complete Trip" button, and batch completion logic.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/07-shopping-mode/07-01-SUMMARY.md

# Key source files:
@src/pages/GroceryListPage.tsx
@src/hooks/useGroceryList.ts
@src/types/index.ts

**Tech stack available:** React, Tailwind v4, Firebase/Firestore, writeBatch
**Established patterns:**
- FAB for primary actions
- ConfirmDialog for destructive actions
- writeBatch for atomic operations

**Constraining decisions:**
- Phase 07-01: Store filtering with selectedStore state
- Phase 07-01: In-cart toggle via updateStatus
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shopping progress indicator</name>
  <files>src/pages/GroceryListPage.tsx</files>
  <action>
Add progress indicator showing in-cart vs total items for current filter:

1. Calculate progress from filtered items:
   ```tsx
   const filteredItems = useMemo(() => {
     if (selectedStore === 'all') return items;
     return items.filter(item => item.store === selectedStore);
   }, [items, selectedStore]);

   const inCartCount = filteredItems.filter(item => item.status === 'in-cart').length;
   const totalCount = filteredItems.length;
   ```

2. Add progress bar below filter pills (only show when store selected, not "All"):
   - Container: `mt-4 mb-2` (only render if selectedStore !== 'all' && totalCount > 0)
   - Progress text: `text-sm text-charcoal/70 mb-1` showing "{inCartCount} of {totalCount} in cart"
   - Progress bar container: `h-2 bg-charcoal/10 rounded-full overflow-hidden`
   - Progress fill: `h-full bg-sage transition-all duration-300` with width percentage

3. Keep progress bar simple - just visual feedback while shopping.
  </action>
  <verify>
npm run build succeeds.
Manual: Progress bar updates as items are tapped in-cart.
  </verify>
  <done>
- Progress bar shows when store filter active
- Count and bar update in real-time as items toggled
- Bar animates smoothly on changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Complete Trip" button with batch completion</name>
  <files>src/pages/GroceryListPage.tsx, src/hooks/useGroceryList.ts</files>
  <action>
Add "Complete Trip" button that removes all in-cart items for the selected store:

1. In useGroceryList.ts, add `completeTrip` method:
   ```tsx
   const completeTrip = useCallback(async (store?: Store): Promise<number> => {
     if (!householdCode) throw new Error('No household code');

     const groceryRef = collection(db, 'groceryList');
     let q = query(
       groceryRef,
       where('householdCode', '==', householdCode),
       where('status', '==', 'in-cart')
     );

     // If store specified, add store filter
     // Note: Firestore requires index for compound where clauses
     // For simplicity, fetch all in-cart and filter client-side
     const snapshot = await getDocs(q);
     const toDelete = store
       ? snapshot.docs.filter(d => d.data().store === store)
       : snapshot.docs;

     if (toDelete.length === 0) return 0;

     const batch = writeBatch(db);
     toDelete.forEach(docSnap => batch.delete(docSnap.ref));
     await batch.commit();

     return toDelete.length;
   }, [householdCode]);
   ```
   Add to return object.

2. In GroceryListPage.tsx:
   - Add `completing` state for loading UI
   - Add "Complete Trip" button (only visible when selectedStore !== 'all' AND inCartCount > 0):
     - Position: Fixed bottom, above the generate FAB area OR replace FAB when in shopping mode
     - Style: `fixed bottom-24 left-4 right-4 bg-sage text-white py-3 rounded-soft font-semibold shadow-lg`
     - Text: "Complete Trip ({inCartCount} items)"
     - Disabled state while completing

   - On click handler:
     ```tsx
     const handleCompleteTrip = async () => {
       if (selectedStore === 'all') return;
       setCompleting(true);
       try {
         const count = await completeTrip(selectedStore);
         // Items will disappear via real-time listener
       } catch (err) {
         console.error('Failed to complete trip:', err);
       } finally {
         setCompleting(false);
       }
     };
     ```

3. Hide generate FAB when in shopping mode (selectedStore !== 'all') to avoid button collision.
  </action>
  <verify>
npm run build succeeds.
Manual: Complete Trip button removes in-cart items.
  </verify>
  <done>
- "Complete Trip" button appears when store selected and items in cart
- Button shows count of items to complete
- Tapping removes all in-cart items for that store
- Generate FAB hidden during shopping mode
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete shopping mode with store filtering, in-cart tracking, and trip completion</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173/grocery
    3. Generate grocery list from weekly meals (if empty)
    4. Test store filtering:
       - Tap "Costco" filter - only Costco items show
       - Tap "All" - all items show
    5. Test shopping flow:
       - Select a store (e.g., "Costco")
       - Tap items to mark in-cart (should show checkmark, strikethrough)
       - Progress bar should update
       - "Complete Trip" button should appear with count
    6. Complete a trip:
       - Tap "Complete Trip"
       - In-cart items should disappear
       - Progress resets
    7. Verify persistence:
       - Mark some items in-cart
       - Refresh page
       - Items should still show in-cart status
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Store filtering works correctly
- [ ] In-cart toggle persists to Firestore
- [ ] Progress bar updates in real-time
- [ ] Complete Trip removes only in-cart items for selected store
- [ ] Generate FAB hidden during shopping mode
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Full shopping flow works: filter → tap items → complete trip
- Phase 7 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-shopping-mode/07-02-SUMMARY.md`
</output>

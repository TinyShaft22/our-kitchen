---
phase: 22.1-paste-image-url
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/meals/AddMealModal.tsx
  - src/components/meals/EditMealModal.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between file upload and paste URL modes in Add Meal modal"
    - "User can toggle between file upload and paste URL modes in Edit Meal modal"
    - "User can paste an external image URL and see a preview"
    - "URL validation shows error for invalid URLs"
    - "Pasted URL saves directly to imageUrl field without Firebase Storage upload"
  artifacts:
    - path: "src/components/meals/AddMealModal.tsx"
      provides: "Image mode toggle, URL input with validation and preview"
      contains: "imageInputMode"
    - path: "src/components/meals/EditMealModal.tsx"
      provides: "Image mode toggle, URL input with validation and preview"
      contains: "imageInputMode"
  key_links:
    - from: "AddMealModal.tsx"
      to: "Firestore imageUrl field"
      via: "direct URL assignment when in URL mode"
      pattern: "imageUrl.*=.*imageUrlInput"
    - from: "EditMealModal.tsx"
      to: "Firestore imageUrl field"
      via: "direct URL assignment when in URL mode"
      pattern: "imageUrl.*=.*imageUrlInput"
---

<objective>
Add "Paste URL" option as alternative to file upload for recipe images in Add/Edit Meal modals.

Purpose: Allow users to quickly add recipe images by pasting URLs from Broma Bakery or other sources, without needing to download and re-upload.
Output: Both modals support toggling between "Upload File" and "Paste URL" modes with proper validation and preview.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/meals/AddMealModal.tsx
@src/components/meals/EditMealModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URL Input Mode to AddMealModal</name>
  <files>src/components/meals/AddMealModal.tsx</files>
  <action>
Add state and UI for paste URL mode in AddMealModal:

1. Add new state variables after existing image state (around line 46):
   - `imageInputMode: 'file' | 'url'` - default 'file'
   - `imageUrlInput: string` - the pasted URL
   - `urlPreviewLoading: boolean` - loading state while validating URL
   - `urlPreviewError: string | null` - error message for invalid URLs

2. Add URL validation function:
   - `validateImageUrl(url: string)` - checks if URL is valid format (starts with http/https)
   - Returns true/false for valid URL format
   - Does NOT check if image actually loads (that's handled by img onload/onerror)

3. Add URL input handler:
   - `handleUrlInputChange(url: string)` - sets imageUrlInput
   - `handleUrlInputBlur()` - on blur, if URL valid format, set urlPreviewLoading=true and attempt to load preview
   - When preview loads successfully: set imagePreview to the URL, urlPreviewLoading=false
   - When preview fails: set urlPreviewError="Unable to load image from URL", urlPreviewLoading=false

4. Update resetForm to also reset URL-related state

5. Update handleSave (around line 158-170):
   - If imageInputMode is 'url' AND imageUrlInput is valid AND preview loaded successfully:
     - Set imageUrl = imageUrlInput directly (no compression, no Firebase upload)
   - If imageInputMode is 'file' AND imageFile exists:
     - Keep existing compression and Firebase upload logic

6. Update Photo UI section (around line 295-344):
   - Add segmented toggle at top: "Upload File" | "Paste URL" (use two Buttons with variant based on active mode)
   - When mode is 'file': show existing file upload UI (hidden input, Add Photo button, preview with Change/Remove)
   - When mode is 'url': show text input for URL with:
     - Input placeholder: "https://example.com/image.jpg"
     - Loading spinner when urlPreviewLoading
     - Error message when urlPreviewError
     - Preview image when imagePreview is set (from successful URL load)
     - "Clear" button to reset URL input and preview

Style the toggle buttons with existing Tailwind classes:
- Active: variant="default" (solid terracotta)
- Inactive: variant="outline"
- Both: size="sm", wrapped in flex gap-2 container
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Manual test: Open Add Meal modal, verify toggle appears above photo section.
  </verify>
  <done>
AddMealModal shows file/URL toggle. Selecting "Paste URL" shows text input. Pasting valid URL shows preview. Saving meal with URL stores it directly in imageUrl field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add URL Input Mode to EditMealModal</name>
  <files>src/components/meals/EditMealModal.tsx</files>
  <action>
Apply same pattern from AddMealModal to EditMealModal:

1. Add new state variables after existing image state (around line 47):
   - `imageInputMode: 'file' | 'url'` - default 'file'
   - `imageUrlInput: string` - the pasted URL
   - `urlPreviewLoading: boolean` - loading state
   - `urlPreviewError: string | null` - error message

2. Add same URL validation and handlers as AddMealModal:
   - `validateImageUrl(url: string)`
   - `handleUrlInputChange(url: string)`
   - `handleUrlInputBlur()`

3. Update useEffect that re-initializes state (around line 107-121):
   - Reset imageInputMode to 'file'
   - Reset imageUrlInput to ''
   - Reset urlPreviewLoading to false
   - Reset urlPreviewError to null

4. Update handleSave (around line 159-196):
   - Add handling for URL mode similar to AddMealModal
   - When imageInputMode is 'url' AND valid URL preview loaded:
     - Set imageUrl = imageUrlInput (no upload)
     - If meal.imageUrl was a Firebase Storage URL (contains 'firebasestorage.googleapis.com'), attempt to delete old image
   - When imageInputMode is 'file' AND imageFile exists:
     - Keep existing compression, upload, and old image deletion logic
   - When removeImage is true:
     - Keep existing removal logic

5. Update Photo UI section (around line 321-370):
   - Add same segmented toggle and URL input UI as AddMealModal
   - Same styling and behavior

6. Edge case handling:
   - When meal already has an imageUrl that is NOT from Firebase Storage (external URL):
     - On modal open, could optionally set imageInputMode to 'url' and imageUrlInput to meal.imageUrl
     - Or just keep default 'file' mode - user can switch if they want to update URL
   - Decision: Keep default 'file' mode for simplicity, existing preview works regardless
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Manual test: Edit a meal with existing image, verify toggle works. Edit a meal without image, paste URL, save, verify URL stored.
  </verify>
  <done>
EditMealModal shows file/URL toggle. Can paste URL to add/change image. URLs save directly without Firebase upload. Replacing Firebase image with URL properly deletes old Firebase file.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Full Flow</name>
  <files>src/components/meals/AddMealModal.tsx, src/components/meals/EditMealModal.tsx</files>
  <action>
Test both modals end-to-end and fix any issues:

1. Build and run dev server:
   - `npm run build` - ensure no TypeScript errors
   - `npm run dev` - start dev server

2. Test AddMealModal:
   - Create new meal
   - Toggle to "Paste URL" mode
   - Paste: https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400 (food image)
   - Wait for preview to load
   - Fill in meal name and add one ingredient
   - Save
   - Verify meal appears in list with image

3. Test EditMealModal:
   - Edit the meal just created
   - Verify image displays
   - Toggle to "Paste URL" mode
   - Paste different URL: https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400
   - Save
   - Verify new image displays

4. Test error handling:
   - In Add modal, toggle to URL mode
   - Paste invalid URL: "not-a-url"
   - Verify error message appears
   - Paste URL that doesn't resolve to image: https://example.com/notanimage.txt
   - Verify error message appears after load attempt

5. Fix any issues found during testing
  </action>
  <verify>
All test scenarios pass. `npm run build` succeeds. Both modals work correctly with URL input.
  </verify>
  <done>
Complete paste URL feature working in both Add and Edit Meal modals. URL validation works. Preview loading works. Images save correctly without Firebase upload.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. AddMealModal shows file/URL toggle above photo section
3. EditMealModal shows file/URL toggle above photo section
4. Pasting valid image URL shows preview after brief loading
5. Pasting invalid URL shows error message
6. Saving meal with pasted URL stores URL directly in imageUrl field
7. Switching between file and URL modes clears the other mode's state
</verification>

<success_criteria>
- Both modals support toggle between "Upload File" and "Paste URL" modes
- Valid URLs show image preview after loading
- Invalid URLs show clear error message
- URLs save directly to imageUrl field (no Firebase Storage upload)
- File upload mode continues to work as before (compression + Firebase upload)
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22.1-paste-image-url/22.1-01-SUMMARY.md`
</output>

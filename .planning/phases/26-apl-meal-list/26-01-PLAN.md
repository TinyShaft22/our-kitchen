---
phase: 26-apl-meal-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - our-kitchen-alexa/lambda/apl/meal-list.json
  - our-kitchen-alexa/lambda/apl/meal-list-data.js
  - our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
  - our-kitchen-alexa/lambda/handlers/MealHandlers.js
  - our-kitchen-alexa/lambda/index.js
autonomous: true

must_haves:
  truths:
    - "Echo Show displays meal list with images when user says 'what's for dinner'"
    - "Meals without images show text-only card (no placeholder)"
    - "User can tap meal card to select it"
    - "Voice-only devices still work (hear meals list, no visual)"
    - "Touch selection stores mealId in session for Phase 27"
  artifacts:
    - path: "our-kitchen-alexa/lambda/apl/meal-list.json"
      provides: "AlexaImageList APL document with responsive layout"
      contains: "AlexaImageList"
    - path: "our-kitchen-alexa/lambda/apl/meal-list-data.js"
      provides: "DataSource builder for meal list"
      exports: ["buildMealListDataSource"]
    - path: "our-kitchen-alexa/lambda/handlers/AplEventHandlers.js"
      provides: "Touch event handler for meal selection"
      exports: ["MealSelectedEventHandler"]
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/MealHandlers.js"
      to: "apl/meal-list.json"
      via: "RenderDocument directive"
      pattern: "addDirective.*RenderDocument"
    - from: "our-kitchen-alexa/lambda/handlers/MealHandlers.js"
      to: "Alexa.Presentation.APL"
      via: "supportedInterfaces check"
      pattern: "getSupportedInterfaces.*Alexa\\.Presentation\\.APL"
    - from: "our-kitchen-alexa/lambda/apl/meal-list.json"
      to: "our-kitchen-alexa/lambda/handlers/AplEventHandlers.js"
      via: "SendEvent command with MealSelected argument"
      pattern: "MealSelected"
---

<objective>
Add visual APL templates to the BrowseMeals handler for Echo Show devices.

Purpose: Enable hands-free meal browsing with visual display on Echo Show 5/8/10/15 while maintaining full voice-only functionality on standard Echo devices.

Output:
- APL document using AlexaImageList responsive template
- DataSource builder for transforming meal data
- Touch event handler for meal card selection
- Updated MealHandlers with APL directive
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-apl-meal-list/26-RESEARCH.md
@.planning/phases/26-apl-meal-list/26-CONTEXT.md
@our-kitchen-alexa/lambda/handlers/MealHandlers.js
@our-kitchen-alexa/lambda/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create APL document and datasource builder</name>
  <files>
    our-kitchen-alexa/lambda/apl/meal-list.json
    our-kitchen-alexa/lambda/apl/meal-list-data.js
  </files>
  <action>
Create apl/ directory and add two files:

**meal-list.json** - APL document using AlexaImageList:
- APL version 2024.3
- Import alexa-layouts 1.7.0 and alexa-viewport-profiles 1.6.0
- Custom resources section with warm colors from PWA (terracotta #C4704B accent, dark background #1A1A1A)
- mainTemplate with parameter "mealListData"
- AlexaImageList component:
  - id: "mealListView"
  - headerTitle bound to "${mealListData.headerTitle}"
  - headerDivider: true
  - listItems bound to "${mealListData.listItems}"
  - imageAspectRatio: "square"
  - imageRoundedCorner: true
  - imageScale: "best-fill"
  - defaultImageSource: "" (empty = text-only for meals without images)
  - hideOrdinal: true
  - theme: "dark"
  - primaryAction: SendEvent with arguments ["MealSelected", "${ordinal}", "${data.mealId}"]

**meal-list-data.js** - DataSource builder:
- Export buildMealListDataSource(meals, headerTitle = 'Our Kitchen')
- Returns object with mealListData key containing:
  - type: 'object'
  - objectId: 'mealListDS'
  - headerTitle: from parameter
  - listItems: array mapped from meals with primaryText, imageSource, mealId
- Handle empty imageUrl gracefully (set to empty string)
  </action>
  <verify>
Files exist:
- ls our-kitchen-alexa/lambda/apl/meal-list.json
- ls our-kitchen-alexa/lambda/apl/meal-list-data.js

Syntax check:
- node -e "JSON.parse(require('fs').readFileSync('./our-kitchen-alexa/lambda/apl/meal-list.json'))"
- node -e "require('./our-kitchen-alexa/lambda/apl/meal-list-data.js')"
  </verify>
  <done>APL document and datasource builder exist with correct structure</done>
</task>

<task type="auto">
  <name>Task 2: Create APL event handler and update MealHandlers</name>
  <files>
    our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
    our-kitchen-alexa/lambda/handlers/MealHandlers.js
  </files>
  <action>
**AplEventHandlers.js** - New file:
- Import ask-sdk-core
- Create MealSelectedEventHandler:
  - canHandle: checks request.type === 'Alexa.Presentation.APL.UserEvent' AND arguments[0] === 'MealSelected'
  - handle:
    - Extract mealId from arguments[2]
    - Store selectedMealId in session attributes
    - Store navigationSource: 'mealList' in session
    - Respond with "Great choice! Ready for the recipe?" and reprompt
- Export { MealSelectedEventHandler }

**MealHandlers.js** - Update BrowseMealsIntentHandler.handle():
- Add imports at top:
  - const mealListDocument = require('../apl/meal-list.json');
  - const { buildMealListDataSource } = require('../apl/meal-list-data');
- After building speakOutput and before final return:
  - Check if device supports APL: Alexa.getSupportedInterfaces(handlerInput.requestEnvelope)['Alexa.Presentation.APL']
  - If supported, add directive to responseBuilder:
    ```
    handlerInput.responseBuilder.addDirective({
      type: 'Alexa.Presentation.APL.RenderDocument',
      token: 'mealListToken',
      document: mealListDocument,
      datasources: buildMealListDataSource(meals)
    });
    ```
- Keep all existing voice functionality unchanged (voice-only devices must still work)
  </action>
  <verify>
Files exist and valid:
- node -e "require('./our-kitchen-alexa/lambda/handlers/AplEventHandlers.js')"
- node -e "require('./our-kitchen-alexa/lambda/handlers/MealHandlers.js')"

Code patterns present:
- grep "getSupportedInterfaces" our-kitchen-alexa/lambda/handlers/MealHandlers.js
- grep "RenderDocument" our-kitchen-alexa/lambda/handlers/MealHandlers.js
- grep "MealSelected" our-kitchen-alexa/lambda/handlers/AplEventHandlers.js
  </verify>
  <done>APL event handler created, MealHandlers updated with APL directive</done>
</task>

<task type="auto">
  <name>Task 3: Register APL handler in index.js</name>
  <files>
    our-kitchen-alexa/lambda/index.js
  </files>
  <action>
Update index.js to register the APL event handler:

1. Add import at top with other handler imports:
   const { MealSelectedEventHandler } = require('./handlers/AplEventHandlers');

2. Add MealSelectedEventHandler to .addRequestHandlers() chain:
   - Place it BEFORE FallbackIntentHandler (APL UserEvents need priority)
   - After CheckOffGroceryIntentHandler, before HelloWorldIntentHandler is fine

The handler order should be:
- LaunchRequestHandler
- LinkHouseholdIntentHandler
- BrowseMealsIntentHandler, GetRecipeIntentHandler, BrowseCategoryIntentHandler
- ReadGroceryListIntentHandler, AddGroceryIntentHandler, etc.
- MealSelectedEventHandler (NEW)
- HelloWorldIntentHandler, HelpIntentHandler, etc.
- FallbackIntentHandler, SessionEndedRequestHandler
  </action>
  <verify>
Syntax check:
- cd our-kitchen-alexa/lambda && node -e "require('./index.js')"

Import present:
- grep "MealSelectedEventHandler" our-kitchen-alexa/lambda/index.js

Handler registered:
- grep -A 5 "addRequestHandlers" our-kitchen-alexa/lambda/index.js | grep "MealSelectedEventHandler"
  </verify>
  <done>APL event handler registered in SkillBuilder chain</done>
</task>

</tasks>

<verification>
All APL components integrated:

1. APL document exists with AlexaImageList template:
   - cat our-kitchen-alexa/lambda/apl/meal-list.json | grep -c "AlexaImageList"

2. DataSource builder exports correctly:
   - node -e "const {buildMealListDataSource} = require('./our-kitchen-alexa/lambda/apl/meal-list-data.js'); console.log(typeof buildMealListDataSource)"

3. MealHandlers checks for APL support:
   - grep "Alexa.Presentation.APL" our-kitchen-alexa/lambda/handlers/MealHandlers.js

4. Touch selection handler works:
   - grep "Alexa.Presentation.APL.UserEvent" our-kitchen-alexa/lambda/handlers/AplEventHandlers.js

5. Full Lambda validates:
   - cd our-kitchen-alexa/lambda && node -e "require('./index.js')"
</verification>

<success_criteria>
- APL document uses AlexaImageList with SendEvent for touch
- DataSource builder transforms meals array to APL format
- BrowseMealsIntentHandler adds APL directive only when device supports it
- Voice-only devices unaffected (same voice output, no APL)
- Touch selection stores mealId in session for Phase 27 recipe detail
- Lambda loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-apl-meal-list/26-01-SUMMARY.md`
</output>

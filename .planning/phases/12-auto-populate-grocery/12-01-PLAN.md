---
phase: 12-auto-populate-grocery
plan: 01
type: execute
---

<objective>
Add "already have" data model and hook method for excluding ingredients from grocery generation.

Purpose: Enable users to mark ingredients they already have at home, so they're excluded from the grocery list for this week.
Output: Updated WeeklyMeal type with alreadyHave field, hook method to toggle, and generation logic that excludes marked ingredients.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work:
@.planning/phases/11-simplify-ingredients/11-01-SUMMARY.md
@.planning/phases/06-grocery-generation/06-01-SUMMARY.md

# Key source files:
@src/types/index.ts
@src/hooks/useWeeklyPlan.ts
@src/utils/generateGroceryItems.ts

**Established patterns:**
- Firestore document updates via updateDoc
- generateGroceryItems pure function for transformation
- WeeklyMeal document keyed by `{householdCode}_{weekId}`

**Constraining decisions:**
- Phase 11: Simplified Ingredient to name/category/store only (no qty/unit)
- Phase 6: Deduplication by name (case-insensitive)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alreadyHave field to WeeklyMeal type</name>
  <files>src/types/index.ts</files>
  <action>Add optional `alreadyHave?: string[]` field to the WeeklyMeal interface. This array stores ingredient names (lowercase for consistent matching) that should be excluded from grocery generation for this week. Optional because existing documents won't have this field.</action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>WeeklyMeal type includes alreadyHave optional string array field</done>
</task>

<task type="auto">
  <name>Task 2: Add toggleAlreadyHave method to useWeeklyPlan hook</name>
  <files>src/hooks/useWeeklyPlan.ts</files>
  <action>Add `toggleAlreadyHave(ingredientName: string): Promise<void>` method that:
1. Takes an ingredient name
2. Normalizes to lowercase for consistent matching
3. If name is in alreadyHave array, removes it
4. If name is NOT in alreadyHave array, adds it
5. Updates the WeeklyMeal document
6. If document doesn't exist yet, creates it with empty meals array and the alreadyHave array

Use Firestore arrayUnion/arrayRemove for atomic array operations to avoid race conditions. Handle the case where currentWeek is null (create new document).</action>
  <verify>TypeScript compiles without errors. Hook exports toggleAlreadyHave in return type.</verify>
  <done>toggleAlreadyHave method added to hook, handles add/remove and document creation</done>
</task>

<task type="auto">
  <name>Task 3: Update generateGroceryItems to accept and exclude alreadyHave list</name>
  <files>src/utils/generateGroceryItems.ts</files>
  <action>Modify `generateGroceryItems` function signature to accept optional third parameter `alreadyHave?: string[]`. Before adding ingredient to uniqueMap, check if lowercase ingredient name is in alreadyHave array (also lowercase). Skip ingredient if it's in alreadyHave.

Updated signature: `generateGroceryItems(meals: Meal[], weeklyEntries: WeeklyMealEntry[], alreadyHave?: string[]): GroceryItemInput[]`

The alreadyHave parameter defaults to empty array if not provided (backward compatible).</action>
  <verify>TypeScript compiles without errors. Function signature updated.</verify>
  <done>generateGroceryItems excludes ingredients in alreadyHave list</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes with no TypeScript errors
- [ ] WeeklyMeal type includes alreadyHave field
- [ ] useWeeklyPlan hook exports toggleAlreadyHave method
- [ ] generateGroceryItems accepts and uses alreadyHave parameter
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Data model and hook ready for UI integration in 12-02
</success_criteria>

<output>
After completion, create `.planning/phases/12-auto-populate-grocery/12-01-SUMMARY.md`
</output>

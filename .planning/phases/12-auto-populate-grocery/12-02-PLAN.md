---
phase: 12-auto-populate-grocery
plan: 02
type: execute
---

<objective>
Add auto-sync grocery generation and "Already Have" UI for toggling ingredient exclusions.

Purpose: Grocery list automatically updates when weekly meals change, and users can easily mark ingredients they already have.
Output: Real-time grocery sync, toggle UI on grocery items, and "Already Have" section showing excluded ingredients.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase:
@.planning/phases/12-auto-populate-grocery/12-01-SUMMARY.md

# Key source files:
@src/pages/GroceryListPage.tsx
@src/components/grocery/GroceryItemCard.tsx
@src/hooks/useWeeklyPlan.ts

**From 12-01:**
- WeeklyMeal now has `alreadyHave?: string[]` field
- useWeeklyPlan has `toggleAlreadyHave(ingredientName: string)` method
- generateGroceryItems accepts `alreadyHave` parameter

**Established patterns:**
- Collapsible sections (Staples section in GroceryListPage)
- Real-time Firestore listeners via onSnapshot
- GroceryItemCard with action buttons (delete, store change)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-sync effect for grocery generation</name>
  <files>src/pages/GroceryListPage.tsx</files>
  <action>Replace manual "Generate" button approach with auto-sync:

1. Add a useEffect that watches: currentWeek?.meals (array of meal entries), currentWeek?.alreadyHave (array of excluded ingredients), enabledStaples, and meals (for ingredient lookup)
2. When any of these change and currentWeek exists, automatically call generateFromWeeklyPlan with:
   - `generateGroceryItems(meals, currentWeek.meals, currentWeek.alreadyHave || [])`
   - `enabledStaples`
3. Remove the "Generate" FAB button (the cart icon) since generation is now automatic
4. Keep the voice input FAB (microphone icon)
5. Handle loading state - don't auto-generate while still loading initial data

Use a ref to track if initial load is complete to avoid unnecessary regeneration on first render. Include a debounce using setTimeout (300ms) to avoid rapid-fire regeneration if multiple changes happen quickly. Clean up timeout in useEffect cleanup.</action>
  <verify>App compiles and runs: `npm run dev`. Adding/removing meals from Home page automatically updates grocery list.</verify>
  <done>Grocery list auto-updates when weekly meals or alreadyHave changes, no manual generate button needed</done>
</task>

<task type="auto">
  <name>Task 2: Add "Already Have" toggle to GroceryItemCard for meal-sourced items</name>
  <files>src/components/grocery/GroceryItemCard.tsx</files>
  <action>Modify GroceryItemCard to show an "already have" toggle button for meal-sourced items:

1. Add optional `onToggleAlreadyHave?: () => void` prop
2. For items where `source === 'meal'`, show a home/house icon button (üè†) next to delete button
3. When clicked, call onToggleAlreadyHave callback
4. Style: same button style as delete, muted gray color
5. Tooltip/aria-label: "Mark as already have"

Keep existing functionality (in-cart toggle, delete, store change) intact.</action>
  <verify>TypeScript compiles. GroceryItemCard shows house icon for meal-sourced items.</verify>
  <done>Meal-sourced grocery items have "already have" toggle button</done>
</task>

<task type="auto">
  <name>Task 3: Wire up "Already Have" toggle and add excluded items section</name>
  <files>src/pages/GroceryListPage.tsx</files>
  <action>Complete the "Already Have" feature:

1. Pass `onToggleAlreadyHave` to GroceryItemCard for meal-sourced items, calling `toggleAlreadyHave(item.name)` from useWeeklyPlan hook (add hook usage)
2. Add "Already Have" collapsible section (similar to Staples section):
   - Shows after Staples section, before grocery items
   - Header: "Already Have" with count badge (N items)
   - Collapsed: shows "N items excluded this week"
   - Expanded: lists each excluded ingredient name with a button to re-add (toggle back)
   - Uses currentWeek?.alreadyHave array for the list
3. When user clicks re-add button, call toggleAlreadyHave to remove from exclusion list
4. Style consistently with Staples section (collapsible, badge count)</action>
  <verify>App runs. Can toggle items to "already have" and see them in the section. Can re-add from section.</verify>
  <done>"Already Have" feature fully functional - toggle on items, section shows excluded, can re-add</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run dev` runs without errors
- [ ] Adding meal to weekly plan auto-adds ingredients to grocery list
- [ ] Removing meal from weekly plan auto-removes ingredients from grocery list
- [ ] Clicking "already have" on a grocery item moves it to "Already Have" section
- [ ] Items in "Already Have" section can be toggled back to grocery list
- [ ] "Already Have" persists per week (reloading page shows same excluded items)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No manual "Generate" button needed
- "Already Have" feature works end-to-end
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-auto-populate-grocery/12-02-SUMMARY.md`
</output>

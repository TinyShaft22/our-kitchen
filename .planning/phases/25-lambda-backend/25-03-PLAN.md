---
phase: 25-lambda-backend
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - our-kitchen-alexa/lambda/handlers/HouseholdHandlers.js
  - our-kitchen-alexa/lambda/index.js
autonomous: true

must_haves:
  truths:
    - "User can link device by saying 4-digit PIN"
    - "After 3 wrong PINs, user is told to check app and try later"
    - "Once linked, device remembers household forever"
    - "If user tries to access data before linking, they are prompted for PIN"
  artifacts:
    - path: "our-kitchen-alexa/lambda/handlers/HouseholdHandlers.js"
      provides: "PIN verification and household linking handlers"
      exports: ["LinkHouseholdIntentHandler"]
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/HouseholdHandlers.js"
      to: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      via: "verifyPin API call"
      pattern: "firebaseClient\\.verifyPin"
    - from: "our-kitchen-alexa/lambda/handlers/HouseholdHandlers.js"
      to: "DynamoDB persistence"
      via: "setPersistentAttributes + markPersistentDirty"
      pattern: "setPersistentAttributes.*householdCode"
---

<objective>
Implement household linking via voice PIN verification.

Purpose: Users must link their Echo device to a household before accessing meals, recipes, or grocery lists. This handler verifies the 4-digit PIN against Firebase and stores the household code in DynamoDB for future sessions.

Output: LinkHouseholdIntentHandler that verifies PIN, tracks attempts, and persists linking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-lambda-backend/25-CONTEXT.md
@.planning/phases/25-lambda-backend/25-RESEARCH.md
@.planning/phases/25-lambda-backend/25-02-SUMMARY.md
@our-kitchen-alexa/lambda/index.js
@our-kitchen-alexa/lambda/api/firebaseClient.js
@our-kitchen-alexa/lambda/util/sessionHelper.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LinkHouseholdIntentHandler</name>
  <files>
    our-kitchen-alexa/lambda/handlers/HouseholdHandlers.js
  </files>
  <action>
Create handlers/HouseholdHandlers.js with LinkHouseholdIntentHandler:

```javascript
/**
 * Household Handlers
 * PIN verification and household linking
 */
const Alexa = require('ask-sdk-core');
const { verifyPin } = require('../api/firebaseClient');
const { getPendingAction, clearPendingAction, markPersistentDirty } = require('../util/sessionHelper');

/**
 * LinkHouseholdIntentHandler
 * Handles voice PIN verification and household linking
 *
 * Flow (from CONTEXT.md):
 * 1. User says PIN (or gets prompted after trying to access data)
 * 2. Verify PIN against Firebase
 * 3. If valid: store householdCode in persistent attributes, resume pending action
 * 4. If invalid: track attempt (max 3), reprompt or exit
 */
const LinkHouseholdIntentHandler = {
  canHandle(handlerInput) {
    return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
      && Alexa.getIntentName(handlerInput.requestEnvelope) === 'LinkHouseholdIntent';
  },

  async handle(handlerInput) {
    const slots = handlerInput.requestEnvelope.request.intent.slots;
    const pinCode = slots.PinCode?.value;

    const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
    const attempts = sessionAttributes.pinAttempts || 0;

    // If no PIN provided, prompt for it
    if (!pinCode) {
      return handlerInput.responseBuilder
        .speak("What's your four-digit household PIN?")
        .reprompt("Say your four-digit PIN to link this device to your kitchen.")
        .getResponse();
    }

    try {
      // Verify PIN against Firebase
      const result = await verifyPin(pinCode);

      if (result.valid) {
        // Store household code in persistent attributes (device-scoped)
        const persistentAttributes = await handlerInput.attributesManager.getPersistentAttributes();
        persistentAttributes.householdCode = result.householdCode;
        persistentAttributes.linkedAt = new Date().toISOString();
        handlerInput.attributesManager.setPersistentAttributes(persistentAttributes);

        // Mark for save by response interceptor
        markPersistentDirty(handlerInput);

        // Update session attributes too
        sessionAttributes.householdCode = result.householdCode;
        sessionAttributes.isLinked = true;
        sessionAttributes.pinAttempts = 0;
        handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

        // Check if there was a pending action to resume
        const pending = getPendingAction(handlerInput);
        if (pending.action) {
          clearPendingAction(handlerInput);

          // Construct a helpful response based on pending action
          const actionPrompt = getPendingActionPrompt(pending.action);
          return handlerInput.responseBuilder
            .speak(`Got it! You're now linked. ${actionPrompt}`)
            .reprompt("What would you like to do?")
            .getResponse();
        }

        return handlerInput.responseBuilder
          .speak("Got it! You're now linked to your kitchen. What would you like to do?")
          .reprompt("Try asking what's for dinner, or what's on the grocery list.")
          .getResponse();

      } else {
        // Invalid PIN - track attempts
        const newAttempts = attempts + 1;
        sessionAttributes.pinAttempts = newAttempts;
        handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

        // After 3 attempts, suggest checking app and exit
        if (newAttempts >= 3) {
          sessionAttributes.pinAttempts = 0;
          handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

          return handlerInput.responseBuilder
            .speak("Hmm, that PIN didn't work. Check your PIN in the app and try again later.")
            .getResponse();
        }

        const triesLeft = 3 - newAttempts;
        return handlerInput.responseBuilder
          .speak(`That PIN didn't match. You have ${triesLeft} ${triesLeft === 1 ? 'try' : 'tries'} left. What's your PIN?`)
          .reprompt("Say your four-digit PIN.")
          .getResponse();
      }

    } catch (error) {
      console.log('PIN verification error:', error.message);

      // Network/API errors - be friendly
      return handlerInput.responseBuilder
        .speak("I'm having trouble verifying that PIN right now. Try again in a moment.")
        .reprompt("Say your four-digit PIN to try again.")
        .getResponse();
    }
  }
};

/**
 * Get a helpful prompt based on what the user was trying to do before linking
 */
function getPendingActionPrompt(action) {
  switch (action) {
    case 'BrowseMeals':
      return "Now, what would you like to know about your meals?";
    case 'GetRecipe':
      return "Now, which recipe did you want?";
    case 'ReadGroceryList':
      return "Now, let me check your grocery list.";
    case 'AddGrocery':
      return "Now, what did you want to add to the list?";
    default:
      return "What would you like to do?";
  }
}

/**
 * Utility function for other handlers to prompt for PIN
 * Returns a response that prompts for PIN and stores pending action
 */
function createPinPromptResponse(handlerInput, pendingAction, pendingParams = {}) {
  const { setPendingAction } = require('../util/sessionHelper');
  setPendingAction(handlerInput, pendingAction, pendingParams);

  return handlerInput.responseBuilder
    .speak("I don't know which household to use yet. What's your four-digit PIN?")
    .reprompt("Say your four-digit PIN to link this device.")
    .getResponse();
}

module.exports = {
  LinkHouseholdIntentHandler,
  createPinPromptResponse
};
```
  </action>
  <verify>
Run `node -e "require('./handlers/HouseholdHandlers.js')"` from lambda directory - no syntax errors.
Verify exports: LinkHouseholdIntentHandler, createPinPromptResponse.
  </verify>
  <done>
LinkHouseholdIntentHandler created with PIN verification, attempt tracking (max 3), persistence, and pending action resume.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register handler and update LaunchRequest</name>
  <files>
    our-kitchen-alexa/lambda/index.js
  </files>
  <action>
Update index.js to:
1. Import LinkHouseholdIntentHandler
2. Add it to request handlers
3. Update LaunchRequestHandler to mention PIN linking for new users

**Import the handler:**
```javascript
const { LinkHouseholdIntentHandler } = require('./handlers/HouseholdHandlers');
```

**Update LaunchRequestHandler** to check linking status and guide new users:

```javascript
const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'LaunchRequest';
    },
    handle(handlerInput) {
        const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
        const isLinked = sessionAttributes.isLinked;

        if (isLinked) {
            // Linked user - welcome back
            const speakOutput = "Welcome back to your kitchen! What would you like to do?";
            const repromptOutput = "Try asking what's for dinner, or what's on the grocery list.";

            return handlerInput.responseBuilder
                .speak(speakOutput)
                .reprompt(repromptOutput)
                .getResponse();
        } else {
            // New user - explain and prompt for PIN
            const speakOutput = "Welcome to Kitchen Helper! To get started, I need to connect to your household. What's your four-digit PIN from the app?";
            const repromptOutput = "Say your four-digit household PIN to link this device.";

            return handlerInput.responseBuilder
                .speak(speakOutput)
                .reprompt(repromptOutput)
                .getResponse();
        }
    }
};
```

**Add handler to SkillBuilder:**
```javascript
exports.handler = Alexa.SkillBuilders.custom()
    .addRequestHandlers(
        LaunchRequestHandler,
        LinkHouseholdIntentHandler,  // Add this
        HelloWorldIntentHandler,
        HelpIntentHandler,
        CancelAndStopIntentHandler,
        FallbackIntentHandler,
        SessionEndedRequestHandler
    )
    // ... rest unchanged
```

**Update HelpIntentHandler** to mention linking:

```javascript
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
            && Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.HelpIntent';
    },
    handle(handlerInput) {
        const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
        const isLinked = sessionAttributes.isLinked;

        let speakOutput;
        if (isLinked) {
            speakOutput = "You can ask me what's for dinner, show a recipe, or check your grocery list. What would you like to do?";
        } else {
            speakOutput = "To use Kitchen Helper, you need to link your device with your household PIN. Say your four-digit PIN to get started.";
        }

        return handlerInput.responseBuilder
            .speak(speakOutput)
            .reprompt(speakOutput)
            .getResponse();
    }
};
```
  </action>
  <verify>
Run `node -e "require('./index.js')"` from lambda directory - no syntax errors.
Verify LinkHouseholdIntentHandler is in the addRequestHandlers list.
  </verify>
  <done>
LinkHouseholdIntentHandler registered. LaunchRequestHandler guides new users to link. HelpIntentHandler provides context-aware help.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. handlers/HouseholdHandlers.js exists with LinkHouseholdIntentHandler
2. index.js imports and registers LinkHouseholdIntentHandler
3. LaunchRequestHandler checks isLinked and guides new users
4. HelpIntentHandler provides context-aware help
5. `node -e "require('./index.js')"` runs without errors
6. PIN verification flow: valid PIN saves householdCode, invalid PIN tracks attempts (max 3)
</verification>

<success_criteria>
- LinkHouseholdIntentHandler verifies PIN against Firebase API
- Valid PIN stores householdCode in persistent attributes
- Invalid PIN tracked (max 3 attempts before exit)
- Pending action resume works after successful linking
- LaunchRequest guides unlinked users to PIN flow
- Help provides context-aware assistance
- Casual friendly tone in all responses
</success_criteria>

<output>
After completion, create `.planning/phases/25-lambda-backend/25-03-SUMMARY.md`
</output>

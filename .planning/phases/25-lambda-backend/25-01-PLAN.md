---
phase: 25-lambda-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/index.ts
  - functions/src/alexa/index.ts
  - functions/src/alexa/verifyPin.ts
  - functions/src/alexa/meals.ts
  - functions/src/alexa/recipe.ts
  - functions/src/alexa/groceryList.ts
  - functions/src/alexa/addGroceryItem.ts
  - functions/src/alexa/removeGroceryItem.ts
autonomous: true

must_haves:
  truths:
    - "Alexa can verify a 4-digit PIN and get household code"
    - "Alexa can fetch weekly meal plan for a household"
    - "Alexa can fetch recipe details for a specific meal"
    - "Alexa can read, add, and remove grocery items"
  artifacts:
    - path: "functions/src/alexa/verifyPin.ts"
      provides: "PIN verification endpoint"
      exports: ["verifyPin"]
    - path: "functions/src/alexa/meals.ts"
      provides: "Weekly meals endpoint"
      exports: ["meals"]
    - path: "functions/src/alexa/recipe.ts"
      provides: "Recipe details endpoint"
      exports: ["recipe"]
    - path: "functions/src/alexa/groceryList.ts"
      provides: "Grocery list endpoint"
      exports: ["groceryList"]
    - path: "functions/src/alexa/addGroceryItem.ts"
      provides: "Add grocery item endpoint"
      exports: ["addGroceryItem"]
    - path: "functions/src/alexa/removeGroceryItem.ts"
      provides: "Remove grocery item endpoint"
      exports: ["removeGroceryItem"]
  key_links:
    - from: "functions/src/alexa/verifyPin.ts"
      to: "Firestore households collection"
      via: "alexaPin field lookup"
      pattern: "where\\(.*alexaPin.*==.*pin"
    - from: "functions/src/alexa/meals.ts"
      to: "Firestore weeklyMeals + meals collections"
      via: "householdCode query"
      pattern: "where\\(.*householdCode.*=="
---

<objective>
Create REST API endpoints in Firebase Cloud Functions for Alexa skill to access household data.

Purpose: Lambda handlers need HTTP endpoints to query Firebase. These endpoints provide PIN verification, meal/recipe access, and grocery list management.

Output: 6 Cloud Functions endpoints under `/alexa/*` path that Lambda can call.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-lambda-backend/25-CONTEXT.md
@.planning/phases/25-lambda-backend/25-RESEARCH.md
@functions/src/index.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PIN verification and meals endpoints</name>
  <files>
    functions/src/alexa/verifyPin.ts
    functions/src/alexa/meals.ts
    functions/src/alexa/recipe.ts
  </files>
  <action>
Create three Cloud Functions endpoints:

**verifyPin.ts** - POST /alexa/verifyPin
- Accept `{ pin: string }` body
- Query households collection for document where `alexaPin == pin`
- If found, return `{ valid: true, householdCode: docId }`
- If not found, return `{ valid: false }`
- Note: This requires adding `alexaPin` field to households. The field stores the 4-digit PIN as a string.

**meals.ts** - GET /alexa/meals
- Accept `householdCode` query param
- Query `weeklyMeals` collection for documents where `householdCode == param`
- For each weeklyMeal, fetch the meal name from `meals` collection
- Return `{ meals: [{ id, name, day? }] }` - include day if present
- If no meals, return empty array (not error)

**recipe.ts** - GET /alexa/recipe
- Accept `householdCode` and `mealId` query params
- Fetch meal document from `meals` collection
- Verify meal belongs to household (security check)
- Return `{ name, ingredients: [{ name }], instructions }`
- Parse instructions into array of steps (split on newlines or numbered list)

All endpoints:
- Use `onRequest` from firebase-functions/v2/https
- Set CORS headers for cross-origin access
- Validate required parameters (return 400 if missing)
- Handle errors gracefully (500 with generic message)
- Use same API key pattern as importRecipe (`X-API-Key: ourkitchen2024`)
  </action>
  <verify>
Run `npm run build` in functions/ directory - should compile without errors.
Check that all three functions are exported from index.ts.
  </verify>
  <done>
Three endpoints created and exported: verifyPin, meals, recipe. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create grocery list endpoints</name>
  <files>
    functions/src/alexa/groceryList.ts
    functions/src/alexa/addGroceryItem.ts
    functions/src/alexa/removeGroceryItem.ts
  </files>
  <action>
Create three grocery-related Cloud Functions endpoints:

**groceryList.ts** - GET /alexa/groceryList
- Accept `householdCode` query param
- Query `groceryItems` collection where `householdCode == param` AND `inCart == false`
- Return `{ items: [{ id, name, category, quantity? }] }`
- Sort by category for organized reading
- Cap at 20 items (Alexa can't reasonably read more)

**addGroceryItem.ts** - POST /alexa/addGroceryItem
- Accept `{ householdCode, item, quantity? }` body
- Create new document in `groceryItems` collection:
  - `name`: item
  - `householdCode`: householdCode
  - `category`: "pantry" (default, can be enhanced later)
  - `defaultStore`: "safeway" (default)
  - `quantity`: quantity or null
  - `inCart`: false
  - `createdAt`: server timestamp
- Return `{ success: true, itemId }`

**removeGroceryItem.ts** - POST /alexa/removeGroceryItem
- Accept `{ householdCode, item }` body
- Query `groceryItems` for document where name matches item (case-insensitive)
- Delete the matching document
- Return `{ success: true }` or `{ success: false, error: "Item not found" }`

All endpoints use same patterns as Task 1 (CORS, API key, error handling).
  </action>
  <verify>
Run `npm run build` in functions/ directory - should compile without errors.
All six Alexa endpoints are exported from index.ts.
  </verify>
  <done>
Six Alexa endpoints created and building: verifyPin, meals, recipe, groceryList, addGroceryItem, removeGroceryItem.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export endpoints and add alexaPin to household</name>
  <files>
    functions/src/index.ts
    functions/src/alexa/index.ts
  </files>
  <action>
**alexa/index.ts** - Create barrel export file:
```typescript
export { verifyPin } from './verifyPin';
export { meals } from './meals';
export { recipe } from './recipe';
export { groceryList } from './groceryList';
export { addGroceryItem } from './addGroceryItem';
export { removeGroceryItem } from './removeGroceryItem';
```

**index.ts** - Add exports at the end:
```typescript
// Alexa API endpoints
export { verifyPin, meals, recipe, groceryList, addGroceryItem, removeGroceryItem } from './alexa';
```

**Important:** The alexaPin field needs to exist on household documents. Document this requirement - users will set their PIN in the app UI (future phase) or manually in Firestore for now.

Document the API contract in a comment block at the top of alexa/index.ts:
```typescript
/**
 * Alexa REST API Endpoints
 *
 * All endpoints require X-API-Key header with value "ourkitchen2024"
 *
 * POST /verifyPin - Verify household PIN
 *   Body: { pin: string }
 *   Response: { valid: boolean, householdCode?: string }
 *
 * GET /meals - Get weekly meal plan
 *   Params: householdCode
 *   Response: { meals: [{ id, name, day? }] }
 *
 * GET /recipe - Get recipe details
 *   Params: householdCode, mealId
 *   Response: { name, ingredients: [{ name }], instructions: string[] }
 *
 * GET /groceryList - Get unchecked grocery items
 *   Params: householdCode
 *   Response: { items: [{ id, name, category, quantity? }] }
 *
 * POST /addGroceryItem - Add item to grocery list
 *   Body: { householdCode, item, quantity? }
 *   Response: { success: boolean, itemId?: string }
 *
 * POST /removeGroceryItem - Remove item from grocery list
 *   Body: { householdCode, item }
 *   Response: { success: boolean }
 */
```
  </action>
  <verify>
Run `npm run build` in functions/ directory.
Run `npm run lint` if available.
Verify all 7 functions are exported (6 Alexa + 1 importRecipe).
  </verify>
  <done>
All Alexa endpoints exported from functions/src/index.ts. API contract documented. Build and lint pass.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd functions && npm run build` passes with no errors
2. All 6 Alexa endpoints exist as named exports
3. Each endpoint handles missing params with 400 response
4. Each endpoint validates API key
5. API contract documentation exists in alexa/index.ts
</verification>

<success_criteria>
- 6 Cloud Functions endpoints created for Alexa
- verifyPin returns valid/invalid with householdCode
- meals returns weekly meal names
- recipe returns ingredients and instructions
- groceryList returns unchecked items
- addGroceryItem creates new grocery item
- removeGroceryItem deletes matching item
- All endpoints deployed (or ready to deploy) to Firebase
</success_criteria>

<output>
After completion, create `.planning/phases/25-lambda-backend/25-01-SUMMARY.md`
</output>

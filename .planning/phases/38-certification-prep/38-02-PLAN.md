---
phase: 38-certification-prep
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/alexa/testHousehold.ts
  - functions/src/index.ts
autonomous: false

must_haves:
  truths:
    - "Test household exists in Firestore with sample meals, recipes, and grocery items"
    - "Test PIN is known and documented for Amazon reviewers"
    - "All built-in intents (Stop, Cancel, Help, Fallback) behave correctly per certification rules"
  artifacts:
    - path: "functions/src/alexa/testHousehold.ts"
      provides: "Script/function to seed test household data"
      min_lines: 50
  key_links:
    - from: "functions/src/alexa/testHousehold.ts"
      to: "Firestore"
      via: "admin SDK writes"
      pattern: "firestore.*set|doc.*set"
---

<objective>
Create test household with sample data for Amazon certification reviewers, and audit existing handlers for certification compliance.

Purpose: Amazon reviewers need a working test account with data to verify the skill. Built-in intent compliance is a top certification failure reason.
Output: Seeded test household in Firestore, compliance audit results, updated testing instructions in skill.json.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-certification-prep/38-RESEARCH.md
@.planning/phases/38-certification-prep/38-01-SUMMARY.md
@our-kitchen-alexa/skill-package/skill.json
@functions/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test household seeding function and audit handler compliance</name>
  <files>functions/src/alexa/testHousehold.ts, functions/src/index.ts</files>
  <action>
    **Part A: Test Household Seeder**

    Create `functions/src/alexa/testHousehold.ts` that exports an HTTPS callable Cloud Function `seedTestHousehold` which:

    1. Creates a test household document with:
       - Known PIN: "9999" (easy for reviewers)
       - Name: "Test Kitchen"
       - A known household ID (e.g., "test-household-cert")

    2. Seeds 3-5 meals with recipes:
       - "Spaghetti Bolognese" (Main Dishes) with ingredients and cooking instructions
       - "Chicken Stir Fry" (Main Dishes) with ingredients and instructions
       - "Chocolate Chip Cookies" (Baking/Cookies) with ingredients and instructions
       - Each meal needs: name, category, subcategory, ingredients array, instructions markdown

    3. Seeds 3-5 grocery list items:
       - "Milk" (Dairy, Safeway)
       - "Bread" (Bakery, Safeway)
       - "Chicken breast" (Meat, Costco)
       - Each with: name, category, store, inCart: false

    4. Seeds 2 household items:
       - "Paper towels" (Household, Costco)
       - "Dish soap" (Household, Safeway)

    5. Adds 2 meals to weekly plan

    Use the existing Firestore data model patterns (check `src/types/` for type definitions). The function should be idempotent -- delete and recreate on each call.

    Register `seedTestHousehold` in `functions/src/index.ts`.

    **Part B: Handler Compliance Audit**

    Read through the Lambda handler files in `our-kitchen-alexa/lambda/` and verify:

    1. AMAZON.StopIntent: must set shouldEndSession=true (or not explicitly false)
    2. AMAZON.CancelIntent: must set shouldEndSession=true
    3. AMAZON.HelpIntent: must keep session open (shouldEndSession=false or reprompt)
    4. AMAZON.FallbackIntent: must provide helpful guidance and keep session open
    5. Error handler: must not leave session hanging -- should apologize and either prompt retry or end session
    6. LaunchRequest: must provide clear guidance on what user can do

    Document any issues found. Fix any non-compliant handlers directly. Common fixes:
    - StopIntent returning shouldEndSession=false (must be true)
    - HelpIntent closing session (must stay open)
    - Error handler with generic "sorry" that closes session (should prompt retry)

    After seeder is created and any compliance fixes applied, update the `testingInstructions` field in `skill.json` with the actual test PIN "9999" and household name.
  </action>
  <verify>
    - `cd functions && npm run build` succeeds with new function
    - `grep -r "seedTestHousehold" functions/src/index.ts` shows export
    - Review handler compliance notes in summary
  </verify>
  <done>Test household seeder function created and registered, handler compliance audited and any issues fixed, testing instructions updated with real test PIN</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Test household seeder function ready to deploy. Handler compliance audited. Privacy policy page and skill manifest metadata from Plan 01.
  </what-built>
  <how-to-verify>
    1. Review the test household data structure -- does it have enough sample data for reviewers?
    2. Review any handler compliance fixes
    3. Confirm test PIN "9999" is acceptable
    4. Confirm contact email in privacy policy (placeholder: ourkitchen.app@gmail.com)
    5. Deploy privacy policy: `firebase deploy --only hosting`
    6. Deploy seeder function: `firebase deploy --only functions:seedTestHousehold`
    7. Run seeder: call the seedTestHousehold function to populate Firestore
    8. Verify privacy policy is accessible at https://[project].web.app/privacy
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Test household seeder function builds without errors
- All built-in intents comply with certification requirements
- Testing instructions include real test PIN
- Privacy policy deployed and accessible (verified in checkpoint)
</verification>

<success_criteria>
- Test household can be seeded with sample data for Amazon reviewers
- All handlers pass certification compliance checks
- Skill is ready for Phase 39 submission
</success_criteria>

<output>
After completion, create `.planning/phases/38-certification-prep/38-02-SUMMARY.md`
</output>

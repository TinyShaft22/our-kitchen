---
phase: 08-voice-staples
plan: 03
type: execute
---

<objective>
Add voice input for quick grocery item capture using Web Speech API.

Purpose: Enable hands-free item entry, useful when cooking or with messy hands.
Output: useSpeechRecognition hook, voice capture button on GroceryListPage, quick-add flow.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/08-voice-staples/08-01-SUMMARY.md
@.planning/phases/08-voice-staples/08-02-SUMMARY.md

# Existing code:
@src/types/index.ts
@src/hooks/useGroceryList.ts
@src/pages/GroceryListPage.tsx

**Tech stack available:** React, TypeScript, Tailwind, Firebase/Firestore
**Established patterns:** Custom hooks, FAB buttons

**Web Speech API Research:**
- Use vendor prefix: `window.SpeechRecognition || window.webkitSpeechRecognition`
- Safari Mobile (14.1+) has partial support
- CRITICAL: Speech Recognition does NOT work when installed as PWA on iOS
- Requires internet connection (audio sent to Google servers)
- Must be progressive enhancement with graceful fallback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSpeechRecognition hook</name>
  <files>src/hooks/useSpeechRecognition.ts</files>
  <action>
Create custom hook for Web Speech API with browser detection and fallback.

Hook interface:
```typescript
interface UseSpeechRecognitionReturn {
  isSupported: boolean;      // Browser supports speech recognition
  isListening: boolean;      // Currently recording
  transcript: string;        // Current transcription result
  error: string | null;      // Error message if failed
  startListening: () => void;
  stopListening: () => void;
  resetTranscript: () => void;
}
```

Implementation:
1. Check for SpeechRecognition support on mount:
   - `const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition`
   - Set isSupported = !!SpeechRecognition
2. If not supported, return early with isSupported: false, noop functions
3. Create SpeechRecognition instance with options:
   - continuous: false (single phrase capture)
   - interimResults: true (show results as speaking)
   - lang: 'en-US'
4. Handle events:
   - onresult: Update transcript from event.results
   - onerror: Set error message, set isListening false
   - onend: Set isListening false
5. startListening: Start recognition, set isListening true, clear previous transcript
6. stopListening: Stop recognition
7. resetTranscript: Clear transcript string
8. Clean up recognition instance on unmount

Error handling:
- 'not-allowed': User denied microphone permission
- 'no-speech': No speech detected
- 'network': Network error (requires internet)
- Handle gracefully with user-friendly messages
  </action>
  <verify>TypeScript compiles clean, hook exports correctly</verify>
  <done>useSpeechRecognition hook handles browser detection, listening state, and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add voice capture button to GroceryListPage</name>
  <files>src/pages/GroceryListPage.tsx, src/components/grocery/VoiceInputModal.tsx</files>
  <action>
**VoiceInputModal (new file):**
Create modal for voice-to-grocery workflow:
- Full screen modal with dark overlay
- Large microphone button in center (terracotta when idle, pulsing sage when listening)
- Show transcript text below mic button as user speaks
- "Add Item" button appears when transcript has content
- "Cancel" button to close
- On "Add Item":
  - Parse transcript for item name
  - Create GroceryItem with: name=transcript, qty=1, unit='item', category='pantry' (default), store='safeway' (default), source='quick-add'
  - Call addItem from useGroceryList
  - Reset and close modal

If speech not supported:
- Show text input field instead of mic button
- Same add flow, just typed instead of spoken

**GroceryListPage updates:**
1. Import useSpeechRecognition hook and VoiceInputModal
2. Add state for showVoiceModal
3. Add microphone FAB button:
   - Position: bottom-24 left-4 (opposite side from generate button)
   - Only show when NOT in shopping mode (same as generate button)
   - Mic emoji icon
   - If !isSupported, still show but will use text fallback
4. Clicking mic FAB opens VoiceInputModal

Styling:
- Mic button uses same FAB styling as generate button
- When listening, show pulsing animation (animate-pulse class)
- Transcript text in large font for readability
  </action>
  <verify>npm run build passes, mic button appears on grocery page, modal opens</verify>
  <done>Voice input button visible, modal opens with mic/text input, can add items via voice or text</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Voice input for quick grocery capture with fallback to text input</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173 (or your dev port)
    3. Navigate to Grocery List page
    4. Verify: Microphone FAB button visible (bottom-left when not shopping)
    5. Click mic button - modal should open
    6. If browser supports speech:
       - Click mic to start listening
       - Say "milk" or another item
       - Transcript should appear
       - Click "Add Item"
       - Item should appear in grocery list
    7. If browser doesn't support speech:
       - Text input should appear instead
       - Type an item name and add
    8. Verify item appears with source 'quick-add'
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] useSpeechRecognition hook detects browser support
- [ ] Mic FAB button visible on grocery page (non-shopping mode)
- [ ] VoiceInputModal opens and shows appropriate input method
- [ ] Voice capture works in supported browsers
- [ ] Text fallback works in unsupported browsers
- [ ] Items are added to grocery list via voice/text
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Voice input works where supported, text fallback elsewhere
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-voice-staples/08-03-SUMMARY.md`
</output>

---
phase: 29-grocery-integration
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - our-kitchen-alexa/lambda/apl/grocery-list.json
  - our-kitchen-alexa/lambda/apl/grocery-list-data.js
  - our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
  - our-kitchen-alexa/lambda/index.js
autonomous: true

must_haves:
  truths:
    - "Echo Show displays grocery list grouped by store with section headers"
    - "Voice response includes store name ('eggs from Costco')"
    - "User can ask 'What do I need at Costco?' and only hear/see Costco items"
    - "Adding duplicate item prompts 'You already have X on the list. Add duplicate?'"
    - "Voice-only devices still work (hear list, no visual)"
  artifacts:
    - path: "our-kitchen-alexa/lambda/apl/grocery-list.json"
      provides: "APL document for grocery list with store grouping"
      contains: "AlexaTextList"
    - path: "our-kitchen-alexa/lambda/apl/grocery-list-data.js"
      provides: "DataSource builder for grocery list"
      exports: ["buildGroceryListDataSource"]
    - path: "our-kitchen-alexa/lambda/handlers/GroceryHandlers.js"
      provides: "Enhanced grocery handlers with APL and duplicate detection"
      exports: ["ReadGroceryListIntentHandler", "AddGroceryIntentHandler", "ConfirmDuplicateIntentHandler"]
  key_links:
    - from: "our-kitchen-alexa/lambda/handlers/GroceryHandlers.js"
      to: "apl/grocery-list.json"
      via: "RenderDocument directive"
      pattern: "addDirective.*RenderDocument"
    - from: "our-kitchen-alexa/lambda/handlers/GroceryHandlers.js"
      to: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      via: "checkDuplicateGrocery before add"
      pattern: "checkDuplicateGrocery"
---

<objective>
Add APL visual display for grocery list and enhance handlers with store info and duplicate detection.

Purpose: Echo Show users should see their grocery list grouped by store. Voice responses should include store names. Adding duplicate items should prompt for confirmation.

Output:
- APL document and datasource builder for grocery list display
- Enhanced ReadGroceryListIntentHandler with APL + store filter + store in voice
- Enhanced AddGroceryIntentHandler with duplicate detection and confirmation flow
- New ConfirmDuplicateIntentHandler for yes/no response
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-grocery-integration/29-CONTEXT.md
@.planning/phases/29-grocery-integration/29-01-SUMMARY.md
@our-kitchen-alexa/lambda/apl/meal-list.json
@our-kitchen-alexa/lambda/apl/meal-list-data.js
@our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
@our-kitchen-alexa/lambda/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create APL document and datasource builder for grocery list</name>
  <files>
    our-kitchen-alexa/lambda/apl/grocery-list.json
    our-kitchen-alexa/lambda/apl/grocery-list-data.js
  </files>
  <action>
Create APL files following the meal-list pattern:

**grocery-list.json** - APL document using AlexaTextList (read-only list per CONTEXT.md):
```json
{
  "type": "APL",
  "version": "2024.3",
  "description": "Our Kitchen grocery list display",
  "import": [
    { "name": "alexa-layouts", "version": "1.7.0" },
    { "name": "alexa-viewport-profiles", "version": "1.6.0" }
  ],
  "resources": [
    {
      "description": "Custom colors - default (dark theme)",
      "colors": {
        "colorBackground": "#1A1A1A",
        "colorAccent": "#C4704B"
      }
    }
  ],
  "mainTemplate": {
    "parameters": ["groceryListData"],
    "items": [
      {
        "type": "AlexaTextList",
        "id": "groceryListView",
        "headerTitle": "${groceryListData.headerTitle}",
        "headerSubtitle": "${groceryListData.headerSubtitle}",
        "headerDivider": true,
        "backgroundColor": "@colorBackground",
        "listItems": "${groceryListData.listItems}",
        "hideOrdinal": false,
        "theme": "dark"
      }
    ]
  }
}
```

**grocery-list-data.js** - DataSource builder:
```javascript
/**
 * Grocery List DataSource Builder
 * Groups items by store for visual display
 */

/**
 * Build datasource for grocery list APL template
 * @param {Array} items - Array of grocery items with name, store, category
 * @param {string} headerTitle - Title for the list header
 * @param {number} totalCount - Total items (for "X items" subtitle)
 * @returns {Object} APL datasource object
 */
function buildGroceryListDataSource(items, headerTitle = 'Grocery List', totalCount = null) {
  // Group items by store
  const storeGroups = {};
  items.forEach(item => {
    const store = item.store || 'Other';
    if (!storeGroups[store]) {
      storeGroups[store] = [];
    }
    storeGroups[store].push(item);
  });

  // Build list items with store headers
  const listItems = [];
  Object.entries(storeGroups).forEach(([store, storeItems]) => {
    // Add store header as a list item
    listItems.push({
      primaryText: `<b>${store}</b>`,
      secondaryText: `${storeItems.length} item${storeItems.length === 1 ? '' : 's'}`
    });

    // Add items under this store
    storeItems.forEach(item => {
      listItems.push({
        primaryText: item.name,
        secondaryText: item.category || ''
      });
    });
  });

  const count = totalCount || items.length;
  const subtitle = `${count} item${count === 1 ? '' : 's'}`;

  return {
    groceryListData: {
      type: 'object',
      objectId: 'groceryListDS',
      headerTitle: headerTitle,
      headerSubtitle: subtitle,
      listItems: listItems
    }
  };
}

module.exports = { buildGroceryListDataSource };
```

Note: AlexaTextList is simpler than AlexaImageList - no images needed for grocery items. Store headers are embedded as bold list items for visual grouping.
  </action>
  <verify>
Files exist:
- ls our-kitchen-alexa/lambda/apl/grocery-list.json
- ls our-kitchen-alexa/lambda/apl/grocery-list-data.js

Syntax check:
- node -e "JSON.parse(require('fs').readFileSync('./our-kitchen-alexa/lambda/apl/grocery-list.json'))"
- node -e "require('./our-kitchen-alexa/lambda/apl/grocery-list-data.js')"
  </verify>
  <done>APL document and datasource builder exist for grocery list display</done>
</task>

<task type="auto">
  <name>Task 2: Enhance ReadGroceryListIntentHandler with APL and store info</name>
  <files>
    our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
  </files>
  <action>
Update GroceryHandlers.js ReadGroceryListIntentHandler:

1. Add imports at top:
   ```javascript
   const Alexa = require('ask-sdk-core');
   const groceryListDocument = require('../apl/grocery-list.json');
   const { buildGroceryListDataSource } = require('../apl/grocery-list-data.js');
   ```

2. Add store filter support:
   - Check for StoreName slot: `const storeSlot = slots.StoreName?.value;`
   - Pass store to API: `await getGroceryList(householdCode, storeSlot)`

3. Update voice output to include store names:
   - When reading items aloud, format as "eggs from Costco, milk from Trader Joes"
   - Update formatList helper or create formatListWithStore helper:
     ```javascript
     function formatItemsWithStore(items) {
       return items.map(item => {
         if (item.store) {
           return `${item.name} from ${item.store}`;
         }
         return item.name;
       });
     }
     ```
   - Apply to first 5 items per existing cap

4. Add APL directive (same pattern as BrowseMealsIntentHandler):
   ```javascript
   // Check if device supports APL
   if (Alexa.getSupportedInterfaces(handlerInput.requestEnvelope)['Alexa.Presentation.APL']) {
     const headerTitle = storeSlot ? `${storeSlot} List` : 'Grocery List';
     handlerInput.responseBuilder.addDirective({
       type: 'Alexa.Presentation.APL.RenderDocument',
       token: 'groceryListToken',
       document: groceryListDocument,
       datasources: buildGroceryListDataSource(items, headerTitle, items.length)
     });
   }
   ```

5. Update header for store-filtered queries:
   - "At Costco: eggs, milk, and 3 more"
   - "On your list: eggs from Costco, milk from Trader Joes, and 3 more"
  </action>
  <verify>
Code patterns present:
- grep "groceryListDocument" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "buildGroceryListDataSource" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "StoreName" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "from.*store" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js

Lambda loads:
- cd our-kitchen-alexa/lambda && node -e "require('./handlers/GroceryHandlers.js')"
  </verify>
  <done>ReadGroceryListIntentHandler shows APL, supports store filter, includes store in voice</done>
</task>

<task type="auto">
  <name>Task 3: Enhance AddGroceryIntentHandler with duplicate detection</name>
  <files>
    our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
    our-kitchen-alexa/lambda/index.js
  </files>
  <action>
Update GroceryHandlers.js AddGroceryIntentHandler and add ConfirmDuplicateIntentHandler:

1. Import checkDuplicateGrocery:
   ```javascript
   const { getGroceryList, addGroceryItem, removeGroceryItem, checkDuplicateGrocery } = require('../api/firebaseClient');
   ```

2. Update AddGroceryIntentHandler.handle() to check for duplicates first:
   ```javascript
   async handle(handlerInput) {
     // ... existing linked check and slot extraction ...

     try {
       // Check for duplicate before adding
       const dupCheck = await checkDuplicateGrocery(householdCode, item);

       if (dupCheck.exists) {
         // Store pending add in session for confirmation
         const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
         sessionAttributes.pendingGroceryAdd = {
           item: item,
           quantity: quantity,
           existingItem: dupCheck.existingItem
         };
         handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

         const existingName = dupCheck.existingItem.name;
         return handlerInput.responseBuilder
           .speak(`You already have ${existingName} on the list. Would you like to add a duplicate?`)
           .reprompt("Say yes to add another, or no to cancel.")
           .getResponse();
       }

       // No duplicate - proceed with add (existing code)
       const result = await addGroceryItem(householdCode, item, quantity);
       // ... rest of existing add logic ...
     }
   }
   ```

3. Create ConfirmDuplicateIntentHandler:
   ```javascript
   /**
    * ConfirmDuplicateIntentHandler
    * Handles AMAZON.YesIntent / AMAZON.NoIntent after duplicate detection
    */
   const ConfirmDuplicateIntentHandler = {
     canHandle(handlerInput) {
       const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
       return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
         && (Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.YesIntent'
             || Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.NoIntent')
         && sessionAttributes.pendingGroceryAdd;
     },

     async handle(handlerInput) {
       const sessionAttributes = handlerInput.attributesManager.getSessionAttributes();
       const pending = sessionAttributes.pendingGroceryAdd;
       const isYes = Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.YesIntent';

       // Clear pending state
       sessionAttributes.pendingGroceryAdd = null;
       handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

       if (!isYes) {
         return handlerInput.responseBuilder
           .speak("Okay, I didn't add it. Anything else?")
           .reprompt("What would you like to do?")
           .getResponse();
       }

       // User confirmed - add the duplicate
       const householdCode = getHouseholdCode(handlerInput);
       try {
         const result = await addGroceryItem(householdCode, pending.item, pending.quantity);

         if (result.success) {
           // Store for undo
           sessionAttributes.lastAddedItem = {
             name: pending.item,
             id: result.itemId,
             timestamp: Date.now()
           };
           handlerInput.attributesManager.setSessionAttributes(sessionAttributes);

           return handlerInput.responseBuilder
             .speak(`Added another ${pending.item}. Say undo to remove.`)
             .reprompt("What else would you like to add?")
             .getResponse();
         }
       } catch (error) {
         console.log('Confirm duplicate add error:', error.message);
       }

       return handlerInput.responseBuilder
         .speak("I couldn't add that right now. Try again.")
         .reprompt("What would you like to do?")
         .getResponse();
     }
   };
   ```

4. Export ConfirmDuplicateIntentHandler in module.exports

5. Update index.js to register ConfirmDuplicateIntentHandler:
   - Add to import: `ConfirmDuplicateIntentHandler`
   - Add to .addRequestHandlers() BEFORE standard Yes/No handlers
   - Place after AddGroceryIntentHandler, before UndoGroceryIntentHandler
  </action>
  <verify>
Code patterns present:
- grep "checkDuplicateGrocery" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "pendingGroceryAdd" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "ConfirmDuplicateIntentHandler" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js
- grep "ConfirmDuplicateIntentHandler" our-kitchen-alexa/lambda/index.js

Lambda loads:
- cd our-kitchen-alexa/lambda && node -e "require('./index.js')"
  </verify>
  <done>AddGroceryIntent checks for duplicates, ConfirmDuplicateIntent handles yes/no</done>
</task>

</tasks>

<verification>
All grocery integration complete:

1. APL document exists for grocery list:
   - cat our-kitchen-alexa/lambda/apl/grocery-list.json | grep -c "AlexaTextList"

2. DataSource builder works:
   - node -e "const {buildGroceryListDataSource} = require('./our-kitchen-alexa/lambda/apl/grocery-list-data.js'); console.log(typeof buildGroceryListDataSource)"

3. ReadGroceryListIntentHandler has APL support:
   - grep "groceryListToken" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js

4. Store info in voice responses:
   - grep "from.*store\|from \${" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js

5. Duplicate detection works:
   - grep "checkDuplicateGrocery\|pendingGroceryAdd" our-kitchen-alexa/lambda/handlers/GroceryHandlers.js | wc -l

6. Full Lambda validates:
   - cd our-kitchen-alexa/lambda && node -e "require('./index.js')"
</verification>

<success_criteria>
- APL document uses AlexaTextList with store grouping
- DataSource builder groups items by store with headers
- ReadGroceryListIntentHandler adds APL directive on Echo Show
- Voice responses include store names ("eggs from Costco")
- Store filter works ("What do I need at Costco?" only returns Costco items)
- AddGroceryIntentHandler checks for duplicates before adding
- Duplicate detection prompts "You already have X. Add duplicate?"
- ConfirmDuplicateIntentHandler handles yes/no response
- Voice-only devices unaffected
- Lambda loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-grocery-integration/29-02-SUMMARY.md`
</output>

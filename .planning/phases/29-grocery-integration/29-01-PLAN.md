---
phase: 29-grocery-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/src/alexa/groceryList.ts
  - functions/src/alexa/checkDuplicateGrocery.ts
  - functions/src/alexa/index.ts
  - functions/src/index.ts
  - our-kitchen-alexa/lambda/api/firebaseClient.js
autonomous: true

must_haves:
  truths:
    - "User can ask 'What do I need at Costco?' and only hear Costco items"
    - "Grocery list response includes store name for each item"
    - "Before adding, system can check if item already exists on list"
  artifacts:
    - path: "functions/src/alexa/groceryList.ts"
      provides: "Enhanced grocery endpoint with store filter and store field"
      contains: "store"
    - path: "functions/src/alexa/checkDuplicateGrocery.ts"
      provides: "Duplicate check endpoint for add flow"
      exports: ["checkDuplicateGrocery"]
    - path: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      provides: "Client methods for store filter and duplicate check"
      exports: ["getGroceryList", "checkDuplicateGrocery"]
  key_links:
    - from: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      to: "functions/src/alexa/groceryList.ts"
      via: "HTTP GET with store param"
      pattern: "params.*store"
    - from: "our-kitchen-alexa/lambda/api/firebaseClient.js"
      to: "functions/src/alexa/checkDuplicateGrocery.ts"
      via: "HTTP GET with item param"
      pattern: "checkDuplicateGrocery"
---

<objective>
Enhance Cloud Functions backend to support store-filtered grocery queries and duplicate detection.

Purpose: Phase 25-05 built basic grocery handlers. This adds the backend support for CONTEXT.md requirements: store-filtered queries ("What do I need at Costco?"), store info in responses ("eggs from Costco"), and duplicate detection before adding.

Output:
- Enhanced groceryList endpoint with optional store filter and store field in response
- New checkDuplicateGrocery endpoint for add flow duplicate detection
- Updated firebaseClient with new capabilities
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-grocery-integration/29-CONTEXT.md
@functions/src/alexa/groceryList.ts
@functions/src/alexa/index.ts
@functions/src/index.ts
@our-kitchen-alexa/lambda/api/firebaseClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance groceryList endpoint with store filter and store field</name>
  <files>
    functions/src/alexa/groceryList.ts
  </files>
  <action>
Update groceryList.ts to:

1. Add optional `store` query parameter for filtering:
   - When provided, filter items to only that store (case-insensitive)
   - When not provided, return all items (current behavior)

2. Add `store` field to GroceryItemResponse interface:
   ```typescript
   interface GroceryItemResponse {
     id: string;
     name: string;
     category: string;
     store: string;  // ADD THIS
     quantity?: number;
     unit?: string;
   }
   ```

3. Include store in response mapping:
   - Map from Firestore `storeName` field (or fallback to empty string)
   - This enables "eggs from Costco" voice responses

4. Filter logic:
   ```typescript
   const storeFilter = req.query.store as string | undefined;
   // After fetching items...
   if (storeFilter) {
     items = items.filter(item =>
       item.store.toLowerCase() === storeFilter.toLowerCase()
     );
   }
   ```

Keep existing category sorting and 20-item cap after store filter is applied.
  </action>
  <verify>
Syntax check:
- cd functions && npm run build

Code patterns present:
- grep "store" functions/src/alexa/groceryList.ts | head -5
- grep "storeName\|store:" functions/src/alexa/groceryList.ts
  </verify>
  <done>groceryList endpoint returns store field and supports optional store filter parameter</done>
</task>

<task type="auto">
  <name>Task 2: Create checkDuplicateGrocery endpoint</name>
  <files>
    functions/src/alexa/checkDuplicateGrocery.ts
    functions/src/alexa/index.ts
    functions/src/index.ts
  </files>
  <action>
Create new endpoint to check if an item already exists on the grocery list:

**checkDuplicateGrocery.ts:**
```typescript
import { onRequest } from "firebase-functions/v2/https";
import { getApps, initializeApp } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore";

// Helper to ensure Firebase is initialized
function ensureInitialized() {
  if (getApps().length === 0) {
    initializeApp();
  }
}

const API_KEY = "ourkitchen2024";

/**
 * GET /checkDuplicateGrocery - Check if item exists on grocery list
 *
 * Params: householdCode (required), item (required)
 * Response: { exists: boolean, existingItem?: { id, name, store } }
 *
 * Uses case-insensitive partial match on item name.
 */
export const checkDuplicateGrocery = onRequest({ cors: true, invoker: "public" }, async (req, res) => {
  ensureInitialized();

  // CORS headers (same as other endpoints)
  res.set("Access-Control-Allow-Origin", "*");
  res.set("Access-Control-Allow-Methods", "GET, OPTIONS");
  res.set("Access-Control-Allow-Headers", "Content-Type, X-API-Key");

  if (req.method === "OPTIONS") {
    res.status(204).send("");
    return;
  }

  if (req.method !== "GET") {
    res.status(405).json({ exists: false, error: "Method not allowed" });
    return;
  }

  const apiKey = req.headers["x-api-key"] || req.query.apiKey;
  if (apiKey !== API_KEY) {
    res.status(401).json({ exists: false, error: "Invalid API key" });
    return;
  }

  try {
    const householdCode = req.query.householdCode as string;
    const itemName = req.query.item as string;

    if (!householdCode || !itemName) {
      res.status(400).json({ exists: false, error: "Missing householdCode or item parameter" });
      return;
    }

    const db = getFirestore();
    const groceryRef = db.collection("groceryItems");

    // Query for items on the list (not in cart)
    const snapshot = await groceryRef
      .where("householdCode", "==", householdCode)
      .where("status", "in", ["need", "out"])
      .get();

    if (snapshot.empty) {
      res.status(200).json({ exists: false });
      return;
    }

    // Case-insensitive partial match
    const searchLower = itemName.toLowerCase();
    const match = snapshot.docs.find((doc) => {
      const name = doc.data().name?.toLowerCase() || "";
      return name.includes(searchLower) || searchLower.includes(name);
    });

    if (match) {
      const data = match.data();
      res.status(200).json({
        exists: true,
        existingItem: {
          id: match.id,
          name: data.name,
          store: data.storeName || ""
        }
      });
    } else {
      res.status(200).json({ exists: false });
    }
  } catch (error) {
    console.error("checkDuplicateGrocery error:", error);
    res.status(500).json({ exists: false, error: "Internal server error" });
  }
});
```

**Update functions/src/alexa/index.ts:**
Add export: `export { checkDuplicateGrocery } from "./checkDuplicateGrocery";`

**Update functions/src/index.ts:**
Add to Alexa API exports: `checkDuplicateGrocery,`
  </action>
  <verify>
Build passes:
- cd functions && npm run build

Files exist and export:
- grep "checkDuplicateGrocery" functions/src/alexa/index.ts
- grep "checkDuplicateGrocery" functions/src/index.ts
  </verify>
  <done>checkDuplicateGrocery endpoint created and exported from Cloud Functions</done>
</task>

<task type="auto">
  <name>Task 3: Update firebaseClient with store filter and duplicate check</name>
  <files>
    our-kitchen-alexa/lambda/api/firebaseClient.js
  </files>
  <action>
Update firebaseClient.js:

1. Enhance getGroceryList to accept optional store filter:
   ```javascript
   async function getGroceryList(householdCode, store = null) {
     const params = { householdCode };
     if (store) {
       params.store = store;
     }
     const response = await client.get('/groceryList', { params });
     return response.data;
   }
   ```

2. Add checkDuplicateGrocery function:
   ```javascript
   async function checkDuplicateGrocery(householdCode, item) {
     const response = await client.get('/checkDuplicateGrocery', {
       params: { householdCode, item }
     });
     return response.data;
   }
   ```

3. Update module.exports to include checkDuplicateGrocery

Keep all existing functions unchanged.
  </action>
  <verify>
Syntax check:
- cd our-kitchen-alexa/lambda && node -e "require('./api/firebaseClient.js')"

Exports present:
- grep "checkDuplicateGrocery" our-kitchen-alexa/lambda/api/firebaseClient.js
- grep "getGroceryList" our-kitchen-alexa/lambda/api/firebaseClient.js | head -2
  </verify>
  <done>firebaseClient supports store filter and duplicate checking</done>
</task>

</tasks>

<verification>
Backend enhancements complete:

1. groceryList endpoint enhanced:
   - grep "store" functions/src/alexa/groceryList.ts | wc -l (should be > 3)

2. checkDuplicateGrocery endpoint exists:
   - cat functions/src/alexa/checkDuplicateGrocery.ts | head -10

3. Cloud Functions build passes:
   - cd functions && npm run build

4. firebaseClient updated:
   - node -e "const c = require('./our-kitchen-alexa/lambda/api/firebaseClient.js'); console.log(typeof c.checkDuplicateGrocery)"
</verification>

<success_criteria>
- groceryList endpoint returns store field for each item
- groceryList accepts optional store query param for filtering
- checkDuplicateGrocery endpoint returns {exists, existingItem?}
- firebaseClient.getGroceryList accepts optional store parameter
- firebaseClient.checkDuplicateGrocery method exists
- Cloud Functions build without errors
- Lambda loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-grocery-integration/29-01-SUMMARY.md`
</output>

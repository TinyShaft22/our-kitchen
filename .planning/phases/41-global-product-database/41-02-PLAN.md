---
phase: 41-global-product-database
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - scripts/bulk-load-products.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Script fetches ~5K popular US products from Open Food Facts search API"
    - "Products are written to globalProducts collection with barcode as document ID"
    - "Script uses Firebase Admin SDK to bypass client-side rate limits"
  artifacts:
    - path: "scripts/bulk-load-products.ts"
      provides: "Bulk product loader script"
      contains: "admin.firestore"
    - path: "package.json"
      provides: "Script entry point"
      contains: "bulk-load-products"
  key_links:
    - from: "scripts/bulk-load-products.ts"
      to: "globalProducts collection"
      via: "Firebase Admin SDK batch writes"
      pattern: "batch\\.set.*globalProducts"
---

<objective>
Create a Node.js script that bulk-loads ~5K popular US products from Open Food Facts into the globalProducts Firestore collection using Firebase Admin SDK.

Purpose: Pre-populate the global cache so most common barcode scans get instant results without OFF API calls
Output: Runnable script that populates globalProducts with US grocery staples
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/41-global-product-database/41-01-SUMMARY.md
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk load script</name>
  <files>scripts/bulk-load-products.ts, package.json</files>
  <action>
Create scripts/bulk-load-products.ts using tsx (already likely in devDependencies, check first):

1. Initialize Firebase Admin SDK using application default credentials (ADC). The user will run `gcloud auth application-default login` before executing. Use `initializeApp()` with no args (ADC auto-detects).

2. Fetch products from OFF Search API v2:
   - Base URL: `https://world.openfoodfacts.org/api/v2/search`
   - Query params: `countries_tags_en=united-states`, `fields=code,product_name,brands,image_front_small_url,categories_tags`, `page_size=100`, `sort_by=unique_scans_n` (most scanned first)
   - Paginate through pages 1-50 (100 per page = 5000 products max)
   - Add `User-Agent: OurKitchen-BulkLoad/1.0` header
   - Add 1-second delay between page fetches to be polite to OFF servers

3. For each product from OFF:
   - Skip if no `code` or no `product_name` (invalid data)
   - Skip if barcode length < 8 (not a real product barcode)
   - Map to GlobalProduct shape: `{ barcode: code, name: product_name, brand: brands, imageUrl: image_front_small_url, categories: categories_tags, source: 'bulk' }`

4. Write to Firestore using batch writes (max 500 per batch):
   - Document ID = barcode
   - Use `batch.set(doc(db, 'globalProducts', barcode), data, { merge: true })` to avoid overwriting manual edits
   - Add `createdAt` and `updatedAt` as Firestore Timestamp.now()

5. Log progress: "Page X/50 - Y products loaded (Z total)"
6. Log final summary: "Bulk load complete: N products loaded, M skipped"

Add npm script to package.json: `"bulk-load-products": "npx tsx scripts/bulk-load-products.ts"`

Important: This script is a ONE-TIME admin tool. It does NOT need to be production-quality. Keep it simple - single file, no error retry, just log and skip failures.
  </action>
  <verify>`npx tsc --noEmit scripts/bulk-load-products.ts` or `npx tsx --check scripts/bulk-load-products.ts` compiles without errors. Do NOT actually run the script (it would write to Firestore).</verify>
  <done>Script compiles, npm script registered, ready for user to run with `npm run bulk-load-products` after ADC login</done>
</task>

</tasks>

<verification>
- scripts/bulk-load-products.ts exists and compiles
- package.json has "bulk-load-products" script
- Script uses Firebase Admin SDK (not client SDK)
- Script fetches from OFF search API with US filter
- Script uses batch writes with barcode as document ID
- Script has progress logging
</verification>

<success_criteria>
- Bulk load script compiles and is ready to run
- Uses OFF search API sorted by popularity (unique_scans_n)
- Writes to globalProducts with barcode as document ID
- Handles pagination (50 pages x 100 = 5K products)
- Polite: 1s delay between API calls
</success_criteria>

<output>
After completion, create `.planning/phases/41-global-product-database/41-02-SUMMARY.md`
</output>

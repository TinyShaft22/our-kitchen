---
phase: 41-global-product-database
plan: 03
type: execute
wave: 3
depends_on: ["41-01"]
files_modified:
  - src/services/openFoodFacts.ts
  - src/components/scanner/ManualProductEntry.tsx
  - src/components/scanner/BarcodeScannerModal.tsx
autonomous: true

must_haves:
  truths:
    - "contributeProduct() makes a real POST to Open Food Facts API"
    - "ManualProductEntry has a share toggle to opt-in to OFF contribution"
    - "Products are contributed to OFF when user enables share toggle and submits"
  artifacts:
    - path: "src/services/openFoodFacts.ts"
      provides: "Real contributeProduct implementation"
      contains: "fetch.*cgi/product_jqm2.pl"
    - path: "src/components/scanner/ManualProductEntry.tsx"
      provides: "Share toggle UI"
      contains: "shareWithOFF"
  key_links:
    - from: "src/components/scanner/BarcodeScannerModal.tsx"
      to: "src/services/openFoodFacts.ts"
      via: "calls contributeProduct on manual submit when share enabled"
      pattern: "contributeProduct"
---

<objective>
Implement real Open Food Facts contribution via their simple POST API (no OAuth needed) and add a share toggle to ManualProductEntry so users can opt-in to contributing products they manually enter.

Purpose: Give back to the OFF community - products users enter manually get shared publicly
Output: Working contributeProduct(), share toggle in ManualProductEntry, wired through BarcodeScannerModal
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/41-global-product-database/41-01-SUMMARY.md
@src/services/openFoodFacts.ts
@src/components/scanner/ManualProductEntry.tsx
@src/components/scanner/BarcodeScannerModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement real contributeProduct</name>
  <files>src/services/openFoodFacts.ts</files>
  <action>
Replace the placeholder contributeProduct() with a real implementation using OFF's simple write API:

Endpoint: `https://world.openfoodfacts.org/cgi/product_jqm2.pl`
Method: POST with form-encoded body (NOT JSON)

Required fields:
- `code`: barcode string
- `product_name`: product name
- `brands`: brand name (if provided)
- `user_id`: "our-kitchen-app" (anonymous contributor ID)
- `password`: "our-kitchen-app" (OFF allows anonymous contributions with matching user_id/password)
- `comment`: "Contributed via Our Kitchen app"

Use FormData or URLSearchParams for the POST body. Set User-Agent header.

Return true on success (HTTP 200 with status=1), false on failure. Wrap in try/catch, log errors but don't throw. This is a best-effort contribution - if it fails, the product is still saved locally.

Note: OFF's write API does NOT require OAuth for basic product name/brand contributions. Only image uploads and advanced edits need authentication.
  </action>
  <verify>`npx tsc --noEmit` passes. contributeProduct no longer has underscore-prefixed params.</verify>
  <done>contributeProduct makes real POST to OFF API with barcode, name, and brand</done>
</task>

<task type="auto">
  <name>Task 2: Add share toggle and wire contribution</name>
  <files>src/components/scanner/ManualProductEntry.tsx, src/components/scanner/BarcodeScannerModal.tsx</files>
  <action>
1. In ManualProductEntry.tsx:
   - Add `shareWithOFF` boolean state, default true
   - Add a toggle/checkbox below the brand field: "Share with Open Food Facts" with a small description "Help others find this product"
   - Use a simple checkbox with label (no need for a Switch component)
   - Pass `shareWithOFF` in the onSubmit data: extend the onSubmit callback data to include `shareWithOFF: boolean`

2. In BarcodeScannerModal.tsx:
   - Update handleManualSubmit to accept the new `shareWithOFF` field
   - When shareWithOFF is true, call `contributeProduct(barcode, name, brand)` from openFoodFacts service AFTER caching locally (fire-and-forget, don't await)
   - Import contributeProduct from '../../services/openFoodFacts'

3. Update ManualProductEntryProps interface to include shareWithOFF in onSubmit data type.
  </action>
  <verify>`npx tsc --noEmit` passes. `npm run build` succeeds. ManualProductEntry renders the share checkbox.</verify>
  <done>Share toggle visible in ManualProductEntry, contribution fires on submit when enabled</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- contributeProduct() makes real POST to OFF API (no longer a placeholder)
- ManualProductEntry has share toggle checkbox defaulting to on
- BarcodeScannerModal calls contributeProduct fire-and-forget when share enabled
- No breaking changes to scan flow
</verification>

<success_criteria>
- Manually entered products can be contributed to Open Food Facts
- Share toggle defaults to on (opt-out rather than opt-in)
- Contribution is fire-and-forget (doesn't block the UI)
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-global-product-database/41-03-SUMMARY.md`
</output>

---
phase: 03-data-layer
plan: 01
type: execute
---

<objective>
Create TypeScript types for all data entities and enable Firestore offline persistence.

Purpose: Establish type safety foundation for all data operations and ensure offline-first capability.
Output: Types file with all entity interfaces, Firestore configured with persistence enabled.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/SPEC.md
@src/config/firebase.ts
@src/hooks/useHousehold.ts

**From Phase 2:**
- Firebase SDK initialized with modular imports
- db export available from src/config/firebase.ts
- Household-based security pattern established (householdCode field on documents)

**Data structures from SPEC.md:**
- Household: members array
- Meal: name, servings, ingredients array, isBaking flag
- Ingredient: name, qty, unit, category, defaultStore
- WeeklyMeal: weekId, meals array with mealId and servings
- GroceryItem: name, qty, unit, category, store, status, source
- Staple: name, store, category, enabled flag
- BakingEssential: name, qty, unit, status
- BoughtHistory: items array, date timestamp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types for all entities</name>
  <files>src/types/index.ts</files>
  <action>Create types file with interfaces for all data entities matching SPEC.md structure:

  1. Ingredient interface: name (string), qty (number), unit (string), category (Category), defaultStore (Store)
  2. Meal interface: id (string), name (string), servings (number), ingredients (Ingredient[]), isBaking (boolean), householdCode (string)
  3. WeeklyMealEntry interface: mealId (string), servings (number)
  4. WeeklyMeal interface: id (string), weekId (string), meals (WeeklyMealEntry[]), householdCode (string)
  5. GroceryItem interface: id (string), name (string), qty (number), unit (string), category (Category), store (Store), status ('need' | 'out' | 'in-cart' | 'bought'), source ('meal' | 'manual' | 'quick-add' | 'staple'), householdCode (string)
  6. Staple interface: id (string), name (string), store (Store), category (Category), enabled (boolean), householdCode (string)
  7. BakingEssential interface: id (string), name (string), qty (number), unit (string), status ('stocked' | 'low' | 'out'), householdCode (string)
  8. BoughtHistoryItem: same fields as GroceryItem but for historical tracking
  9. BoughtHistory interface: id (string), items (BoughtHistoryItem[]), date (Timestamp), householdCode (string)

  Also create:
  - Store type: 'costco' | 'trader-joes' | 'safeway' | 'bel-air'
  - Category type: 'produce' | 'meat' | 'dairy' | 'pantry' | 'frozen' | 'bakery' | 'snacks' | 'beverages' | 'baking'
  - STORES constant: array of {id, name} objects
  - CATEGORIES constant: array of {id, name} objects

  Import Timestamp from firebase/firestore for date fields.</action>
  <verify>npm run build succeeds, types file exports all interfaces</verify>
  <done>All entity interfaces defined with proper types, Store/Category types and constants exported</done>
</task>

<task type="auto">
  <name>Task 2: Enable Firestore offline persistence</name>
  <files>src/config/firebase.ts</files>
  <action>Update firebase.ts to enable Firestore offline persistence:

  1. Import enableIndexedDbPersistence from firebase/firestore
  2. After getFirestore(), call enableIndexedDbPersistence(db)
  3. Handle the promise - persistence may fail in some browsers, log warning but don't throw
  4. Catch and handle 'failed-precondition' (multiple tabs) and 'unimplemented' (browser lacks IndexedDB) errors gracefully

  Use .catch() pattern since enableIndexedDbPersistence returns a promise but we don't want to block app initialization. Log to console.warn on failure.

  Note: enableIndexedDbPersistence is deprecated in newer Firebase versions. Check if enableMultiTabIndexedDbPersistence exists in firebase@^11.x - if so, use that instead. If neither works in v12, use the newer persistentLocalCache pattern from firebase/firestore.</action>
  <verify>npm run build succeeds, dev server starts without errors, browser console shows no persistence errors on load</verify>
  <done>Offline persistence enabled, graceful fallback on unsupported browsers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] All entity types are exported from src/types/index.ts
- [ ] Store and Category types match SPEC.md exactly
- [ ] STORES and CATEGORIES constants are usable arrays
- [ ] App loads without console errors related to persistence
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Types ready for use in Firestore hooks
- Offline persistence configured
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-layer/03-01-SUMMARY.md`
</output>

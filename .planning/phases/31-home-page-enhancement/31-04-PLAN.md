---
phase: 31-home-page-enhancement
plan: 04
type: execute
wave: 4
depends_on: ["31-03"]
files_modified:
  - package.json
  - src/components/planning/DraggableMealCard.tsx
  - src/components/planning/DraggableSnackCard.tsx
  - src/components/planning/DayColumn.tsx
  - src/components/planning/UnassignedSection.tsx
  - src/components/planning/WeekView.tsx
  - src/pages/Home.tsx
autonomous: false

must_haves:
  truths:
    - "User can drag meals between days"
    - "User can drag snacks between days"
    - "User can drag items to/from unassigned section"
    - "Day changes persist to Firebase"
    - "Visual feedback during drag operation"
  artifacts:
    - path: "src/components/planning/DraggableMealCard.tsx"
      provides: "Draggable meal card component"
      min_lines: 40
    - path: "src/components/planning/DraggableSnackCard.tsx"
      provides: "Draggable snack card component"
      min_lines: 40
    - path: "package.json"
      provides: "@dnd-kit dependencies"
      contains: "@dnd-kit/core"
  key_links:
    - from: "src/pages/Home.tsx"
      to: "@dnd-kit/core"
      via: "DndContext wrapper"
      pattern: "DndContext"
    - from: "src/components/planning/DayColumn.tsx"
      to: "@dnd-kit/core"
      via: "useDroppable hook"
      pattern: "useDroppable"
    - from: "src/pages/Home.tsx"
      to: "src/hooks/useWeeklyPlan.ts"
      via: "calls updateMealDay/updateSnackDay on drag end"
      pattern: "updateMealDay|updateSnackDay"
---

<objective>
Add drag-and-drop functionality to week view.

Purpose: Enable intuitive meal planning by dragging items between days.

Output: @dnd-kit integrated with draggable cards, droppable day columns, and Firebase persistence on drop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/31-home-page-enhancement/CONTEXT.md

@src/pages/Home.tsx
@src/components/planning/WeekView.tsx
@src/components/planning/DayColumn.tsx
@src/components/planning/UnassignedSection.tsx
@src/hooks/useWeeklyPlan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @dnd-kit packages</name>
  <files>package.json</files>
  <action>
Install the @dnd-kit packages:

```bash
npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

This adds:
- @dnd-kit/core - Core drag-and-drop functionality
- @dnd-kit/sortable - Sortable preset (optional but useful)
- @dnd-kit/utilities - CSS utilities for transforms
  </action>
  <verify>
- `npm ls @dnd-kit/core` shows package installed
- `npx tsc --noEmit` passes
  </verify>
  <done>
@dnd-kit packages installed and available for import
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DraggableMealCard and DraggableSnackCard components</name>
  <files>src/components/planning/DraggableMealCard.tsx, src/components/planning/DraggableSnackCard.tsx</files>
  <action>
Create src/components/planning/DraggableMealCard.tsx:

```tsx
import { useDraggable } from '@dnd-kit/core';
import { CSS } from '@dnd-kit/utilities';
import type { WeeklyMealEntry, Meal } from '../../types';

interface DraggableMealCardProps {
  entry: WeeklyMealEntry;
  meal: Meal | null;
}

export function DraggableMealCard({ entry, meal }: DraggableMealCardProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `meal-${entry.mealId}`,
    data: {
      type: 'meal',
      entry,
    },
  });

  const style = {
    transform: CSS.Translate.toString(transform),
    opacity: isDragging ? 0.5 : 1,
    cursor: 'grab',
  };

  if (!meal) return null;

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={`
        p-2 bg-white rounded-soft shadow-soft text-sm
        ${isDragging ? 'ring-2 ring-terracotta z-50' : ''}
      `}
    >
      <div className="flex items-center gap-2">
        {meal.imageUrl ? (
          <img
            src={meal.imageUrl}
            alt=""
            className="w-8 h-8 rounded-soft object-cover flex-shrink-0"
          />
        ) : (
          <div className="w-8 h-8 rounded-soft bg-terracotta/10 flex items-center justify-center flex-shrink-0">
            <span className="text-sm">üçΩÔ∏è</span>
          </div>
        )}
        <div className="flex-1 min-w-0">
          <div className="font-medium text-charcoal truncate">{meal.name}</div>
          <div className="text-xs text-charcoal/50">
            {entry.servings} serving{entry.servings !== 1 ? 's' : ''}
          </div>
        </div>
      </div>
    </div>
  );
}
```

Create src/components/planning/DraggableSnackCard.tsx:

```tsx
import { useDraggable } from '@dnd-kit/core';
import { CSS } from '@dnd-kit/utilities';
import type { WeeklySnackEntry, Snack } from '../../types';

interface DraggableSnackCardProps {
  entry: WeeklySnackEntry;
  snack: Snack | null;
}

export function DraggableSnackCard({ entry, snack }: DraggableSnackCardProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `snack-${entry.snackId}`,
    data: {
      type: 'snack',
      entry,
    },
  });

  const style = {
    transform: CSS.Translate.toString(transform),
    opacity: isDragging ? 0.5 : 1,
    cursor: 'grab',
  };

  if (!snack) return null;

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={`
        p-2 bg-sage/10 rounded-soft text-sm
        ${isDragging ? 'ring-2 ring-sage z-50' : ''}
      `}
    >
      <div className="flex items-center gap-2">
        {snack.imageUrl ? (
          <img
            src={snack.imageUrl}
            alt=""
            className="w-8 h-8 rounded-soft object-cover flex-shrink-0"
          />
        ) : (
          <div className="w-8 h-8 rounded-soft bg-sage/20 flex items-center justify-center flex-shrink-0">
            <span className="text-sm">üçø</span>
          </div>
        )}
        <div className="flex-1 min-w-0">
          <div className="font-medium text-charcoal truncate">{snack.name}</div>
          <div className="text-xs text-charcoal/50">√ó{entry.qty}</div>
        </div>
      </div>
    </div>
  );
}
```

Both components use useDraggable from @dnd-kit with:
- Unique IDs prefixed with type (meal-/snack-)
- Data object containing type and entry for handler use
- Visual feedback (opacity, ring) during drag
  </action>
  <verify>
`npx tsc --noEmit` passes
  </verify>
  <done>
DraggableMealCard and DraggableSnackCard components created with @dnd-kit useDraggable
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DayColumn and UnassignedSection with droppable zones</name>
  <files>src/components/planning/DayColumn.tsx, src/components/planning/UnassignedSection.tsx</files>
  <action>
Update src/components/planning/DayColumn.tsx to use useDroppable and render draggable cards:

```tsx
import { useDroppable } from '@dnd-kit/core';
import type { DayOfWeek, WeeklyMealEntry, WeeklySnackEntry, Meal, Snack } from '../../types';
import { DAY_NAMES, DAY_ABBREVIATIONS } from '../../types';
import { DraggableMealCard } from './DraggableMealCard';
import { DraggableSnackCard } from './DraggableSnackCard';

interface DayColumnProps {
  day: DayOfWeek;
  meals: WeeklyMealEntry[];
  snacks: WeeklySnackEntry[];
  getMealById: (mealId: string) => Meal | null;
  getSnackById: (snackId: string) => Snack | null;
  isToday?: boolean;
}

export function DayColumn({
  day,
  meals,
  snacks,
  getMealById,
  getSnackById,
  isToday = false,
}: DayColumnProps) {
  const { isOver, setNodeRef } = useDroppable({
    id: `day-${day}`,
    data: { day },
  });

  const dayName = DAY_NAMES[day];
  const dayAbbr = DAY_ABBREVIATIONS[day];
  const totalItems = meals.length + snacks.length;

  return (
    <div
      ref={setNodeRef}
      className={`
        flex flex-col rounded-soft border min-h-[200px] transition-colors
        ${isToday
          ? 'border-terracotta/40 bg-terracotta/5'
          : 'border-charcoal/10 bg-white/50'
        }
        ${isOver ? 'border-terracotta border-2 bg-terracotta/10' : ''}
      `}
    >
      {/* Day Header */}
      <div
        className={`
          px-3 py-2 border-b text-center
          ${isToday
            ? 'border-terracotta/20 bg-terracotta/10'
            : 'border-charcoal/5 bg-charcoal/5'
          }
        `}
      >
        <div className="hidden md:block font-medium text-charcoal text-sm">
          {dayName}
        </div>
        <div className="md:hidden font-medium text-charcoal text-sm">
          {dayAbbr}
        </div>
        {totalItems > 0 && (
          <div className="text-xs text-charcoal/50">
            {totalItems} item{totalItems !== 1 ? 's' : ''}
          </div>
        )}
      </div>

      {/* Content Area (drop zone) */}
      <div className="flex-1 p-2 space-y-2">
        {/* Meals */}
        {meals.map((entry) => (
          <DraggableMealCard
            key={entry.mealId}
            entry={entry}
            meal={getMealById(entry.mealId)}
          />
        ))}

        {/* Snacks */}
        {snacks.map((entry) => (
          <DraggableSnackCard
            key={entry.snackId}
            entry={entry}
            snack={getSnackById(entry.snackId)}
          />
        ))}

        {/* Empty State / Drop hint */}
        {totalItems === 0 && (
          <div className={`
            flex-1 flex items-center justify-center py-4 rounded-soft border-2 border-dashed
            ${isOver ? 'border-terracotta bg-terracotta/5' : 'border-transparent'}
          `}>
            <span className="text-xs text-charcoal/30">
              {isOver ? 'Drop here' : 'No items'}
            </span>
          </div>
        )}
      </div>
    </div>
  );
}
```

Update src/components/planning/UnassignedSection.tsx to use useDroppable and render draggable cards:

```tsx
import { useDroppable } from '@dnd-kit/core';
import type { WeeklyMealEntry, WeeklySnackEntry, Meal, Snack } from '../../types';
import { DraggableMealCard } from './DraggableMealCard';
import { DraggableSnackCard } from './DraggableSnackCard';

interface UnassignedSectionProps {
  meals: WeeklyMealEntry[];
  snacks: WeeklySnackEntry[];
  getMealById: (mealId: string) => Meal | null;
  getSnackById: (snackId: string) => Snack | null;
}

export function UnassignedSection({
  meals,
  snacks,
  getMealById,
  getSnackById,
}: UnassignedSectionProps) {
  const { isOver, setNodeRef } = useDroppable({
    id: 'unassigned',
    data: { day: undefined },
  });

  const totalItems = meals.length + snacks.length;

  return (
    <div
      ref={setNodeRef}
      className={`
        mb-4 p-3 rounded-soft border-2 border-dashed transition-colors
        ${isOver
          ? 'border-charcoal/40 bg-charcoal/5'
          : totalItems > 0
            ? 'border-charcoal/20 bg-charcoal/5'
            : 'border-charcoal/10'
        }
      `}
    >
      <div className="flex items-center gap-2 mb-2">
        <span className="text-sm font-medium text-charcoal/60">Unassigned</span>
        {totalItems > 0 && (
          <span className="text-xs text-charcoal/40">({totalItems})</span>
        )}
      </div>

      {totalItems > 0 ? (
        <div className="flex flex-wrap gap-2">
          {/* Meals */}
          {meals.map((entry) => (
            <DraggableMealCard
              key={entry.mealId}
              entry={entry}
              meal={getMealById(entry.mealId)}
            />
          ))}

          {/* Snacks */}
          {snacks.map((entry) => (
            <DraggableSnackCard
              key={entry.snackId}
              entry={entry}
              snack={getSnackById(entry.snackId)}
            />
          ))}
        </div>
      ) : (
        <p className="text-xs text-charcoal/40">
          {isOver ? 'Drop here to unassign' : 'Drag items here to unassign from a day'}
        </p>
      )}
    </div>
  );
}
```

Key changes:
- Both use useDroppable with distinct IDs
- DayColumn has id `day-{N}` with data.day set to the day number
- UnassignedSection has id `unassigned` with data.day set to undefined
- Visual feedback when isOver (border/background changes)
- Render DraggableMealCard/DraggableSnackCard instead of static divs
  </action>
  <verify>
`npx tsc --noEmit` passes
  </verify>
  <done>
DayColumn and UnassignedSection updated with useDroppable and draggable card components
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire DndContext and handlers in Home.tsx</name>
  <files>src/pages/Home.tsx</files>
  <action>
Update src/pages/Home.tsx to wrap WeekView with DndContext and handle drag end:

1. Add imports at top:
```tsx
import { DndContext, DragEndEvent, DragOverlay, useSensor, useSensors, PointerSensor } from '@dnd-kit/core';
import type { DayOfWeek, WeeklyMealEntry, WeeklySnackEntry } from '../types';
```

2. Update the useWeeklyPlan destructuring to include updateMealDay and updateSnackDay:
```tsx
const {
  currentWeek,
  loading: weekLoading,
  weekId,
  addMealToWeek,
  removeMealFromWeek,
  updateServings,
  toggleAlreadyHave,
  addSnackToWeek,
  removeSnackFromWeek,
  updateSnackQty,
  updateMealDay,    // ADD
  updateSnackDay,   // ADD
} = useWeeklyPlan(householdCode);
```

3. Add sensor configuration (after the state declarations):
```tsx
// Configure drag sensors - require 10px movement before starting drag
const sensors = useSensors(
  useSensor(PointerSensor, {
    activationConstraint: {
      distance: 10,
    },
  })
);
```

4. Add handleDragEnd function (after other handlers):
```tsx
// Handle drag end - update meal/snack day assignment
const handleDragEnd = async (event: DragEndEvent) => {
  const { active, over } = event;

  if (!over) return;

  const activeData = active.data.current;
  const overData = over.data.current;

  if (!activeData || !overData) return;

  // Determine target day (undefined for unassigned)
  const targetDay = overData.day as DayOfWeek | undefined;

  // Handle meal drop
  if (activeData.type === 'meal') {
    const entry = activeData.entry as WeeklyMealEntry;
    // Only update if day changed
    if (entry.day !== targetDay) {
      await updateMealDay(entry.mealId, targetDay);
    }
  }

  // Handle snack drop
  if (activeData.type === 'snack') {
    const entry = activeData.entry as WeeklySnackEntry;
    // Only update if day changed
    if (entry.day !== targetDay) {
      await updateSnackDay(entry.snackId, targetDay);
    }
  }
};
```

5. Wrap the WeekView with DndContext in the render:
Find the `{/* Week View */}` section and replace with:
```tsx
) : (
  /* Week View with Drag and Drop */
  <DndContext sensors={sensors} onDragEnd={handleDragEnd}>
    <WeekView
      meals={weeklyMeals}
      snacks={weeklySnacks}
      getMealById={getMealById}
      getSnackById={getSnackById}
    />
  </DndContext>
)}
```

The full conditional block should look like:
```tsx
{!hasContent ? (
  <EmptyWeeklyPlan onAdd={() => setIsLoadMealsModalOpen(true)} />
) : viewMode === 'list' ? (
  /* List View */
  <div className="space-y-6">
    {/* ... existing list view code ... */}
  </div>
) : (
  /* Week View with Drag and Drop */
  <DndContext sensors={sensors} onDragEnd={handleDragEnd}>
    <WeekView
      meals={weeklyMeals}
      snacks={weeklySnacks}
      getMealById={getMealById}
      getSnackById={getSnackById}
    />
  </DndContext>
)}
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run dev` and test:
  - Can drag meal cards between day columns
  - Can drag snack cards between day columns
  - Can drag items to/from unassigned section
  - Day column highlights when dragging over
  - Firebase updates on drop (check Firestore console or reload to confirm persistence)
  </verify>
  <done>
DndContext wraps WeekView, handleDragEnd updates Firebase via updateMealDay/updateSnackDay
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete drag-and-drop week view for meal planning</what-built>
  <how-to-verify>
1. Open the app at http://localhost:5173
2. Ensure there are some meals/snacks in the weekly plan
3. Click the calendar/week toggle in header to switch to week view
4. Verify the unassigned section shows items without a day
5. Drag a meal from unassigned to Monday
6. Verify the meal moves to Monday column
7. Drag the meal from Monday to Friday
8. Verify the meal moves to Friday column
9. Drag the meal back to unassigned
10. Verify the meal returns to unassigned section
11. Repeat steps 5-10 with a snack
12. Refresh the page to confirm changes persist

Expected:
- Smooth drag with visual feedback (opacity change, ring highlight)
- Drop zones highlight when dragging over them
- Items snap to new location after drop
- Changes persist after refresh (Firebase updated)
  </how-to-verify>
  <resume-signal>Type "approved" if drag-and-drop works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- @dnd-kit packages in package.json
- Drag meals between days - updates Firebase
- Drag snacks between days - updates Firebase
- Drag to/from unassigned section works
- Visual feedback during drag (opacity, rings, drop zone highlights)
- Changes persist after page refresh
</verification>

<success_criteria>
- @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities installed
- DraggableMealCard and DraggableSnackCard render with useDraggable
- DayColumn and UnassignedSection use useDroppable
- Home.tsx wraps WeekView in DndContext
- handleDragEnd calls updateMealDay/updateSnackDay
- Visual feedback during drag operations
- Firebase persistence confirmed
</success_criteria>

<output>
After completion, create `.planning/phases/31-home-page-enhancement/31-04-SUMMARY.md`
</output>

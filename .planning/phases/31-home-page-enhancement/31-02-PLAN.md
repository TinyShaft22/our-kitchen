---
phase: 31-home-page-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/ui/WeekViewToggle.tsx
  - src/components/planning/LoadMealsModal.tsx
  - src/pages/Home.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Meals and Snacks buttons side-by-side"
    - "User can open LoadMealsModal from header or Meals button"
    - "LoadMealsModal shows meals organized by folder with search"
    - "FAB is removed from Home page"
    - "Week view toggle is visible in header"
  artifacts:
    - path: "src/components/ui/WeekViewToggle.tsx"
      provides: "List/Week toggle button component"
      min_lines: 20
    - path: "src/components/planning/LoadMealsModal.tsx"
      provides: "Folder-organized meal picker modal"
      min_lines: 100
    - path: "src/pages/Home.tsx"
      provides: "Updated Home page with new buttons and header"
      contains: "WeekViewToggle"
  key_links:
    - from: "src/pages/Home.tsx"
      to: "src/components/planning/LoadMealsModal.tsx"
      via: "imports and renders modal"
      pattern: "import.*LoadMealsModal"
    - from: "src/components/planning/LoadMealsModal.tsx"
      to: "src/utils/subcategoryUtils.ts"
      via: "uses buildFolderTree for folder organization"
      pattern: "buildFolderTree"
---

<objective>
Add UI controls for meal loading and view switching.

Purpose: Provide intuitive buttons for adding meals/snacks and prepare the toggle for week view.

Output: WeekViewToggle component, LoadMealsModal with folder navigation, updated Home.tsx header and buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/31-home-page-enhancement/CONTEXT.md

@src/pages/Home.tsx
@src/components/planning/AddSnackToWeekModal.tsx
@src/utils/subcategoryUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeekViewToggle component</name>
  <files>src/components/ui/WeekViewToggle.tsx</files>
  <action>
Create src/components/ui/WeekViewToggle.tsx:

```tsx
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';
import { List, Calendar } from 'lucide-react';

export type ViewMode = 'list' | 'week';

interface WeekViewToggleProps {
  viewMode: ViewMode;
  onToggle: (mode: ViewMode) => void;
}

export function WeekViewToggle({ viewMode, onToggle }: WeekViewToggleProps) {
  return (
    <ToggleGroup
      type="single"
      value={viewMode}
      onValueChange={(value) => value && onToggle(value as ViewMode)}
      className="bg-white/50 rounded-soft p-1"
    >
      <ToggleGroupItem
        value="list"
        aria-label="List view"
        className="px-2 py-1 rounded-soft data-[state=on]:bg-white data-[state=on]:shadow-soft"
      >
        <List className="h-4 w-4" />
      </ToggleGroupItem>
      <ToggleGroupItem
        value="week"
        aria-label="Week view"
        className="px-2 py-1 rounded-soft data-[state=on]:bg-white data-[state=on]:shadow-soft"
      >
        <Calendar className="h-4 w-4" />
      </ToggleGroupItem>
    </ToggleGroup>
  );
}
```

This component uses the existing ToggleGroup from shadcn/ui with list and calendar icons.
  </action>
  <verify>
`npx tsc --noEmit` passes
  </verify>
  <done>
WeekViewToggle component created with list/week mode toggle using icons
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LoadMealsModal component</name>
  <files>src/components/planning/LoadMealsModal.tsx</files>
  <action>
Create src/components/planning/LoadMealsModal.tsx based on AddSnackToWeekModal pattern but with folder organization:

```tsx
import { useState, useMemo } from 'react';
import type { Meal } from '../../types';
import { buildFolderTree, type FolderTreeNode } from '../../utils/subcategoryUtils';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { EmptyState, EmptySearch } from '@/components/ui/EmptyState';
import { ChevronRight, ChevronDown, Folder, FolderOpen } from 'lucide-react';

interface LoadMealsModalProps {
  isOpen: boolean;
  onClose: () => void;
  meals: Meal[];
  onAdd: (mealId: string, servings: number) => Promise<void>;
}

interface FolderSectionProps {
  node: FolderTreeNode;
  depth: number;
  onSelectMeal: (meal: Meal) => void;
}

function FolderSection({ node, depth, onSelectMeal }: FolderSectionProps) {
  const [expanded, setExpanded] = useState(depth === 0);
  const hasChildren = node.children.size > 0;
  const hasMeals = node.meals.length > 0;

  if (!hasChildren && !hasMeals) return null;

  const sortedMeals = [...node.meals].sort((a, b) => a.name.localeCompare(b.name));

  return (
    <div className={depth > 0 ? 'ml-4' : ''}>
      {/* Folder header (only show if not root) */}
      {depth > 0 && (
        <button
          onClick={() => setExpanded(!expanded)}
          className="w-full flex items-center gap-2 py-2 px-2 hover:bg-charcoal/5 rounded-soft text-left"
        >
          {expanded ? (
            <ChevronDown className="h-4 w-4 text-charcoal/60" />
          ) : (
            <ChevronRight className="h-4 w-4 text-charcoal/60" />
          )}
          {expanded ? (
            <FolderOpen className="h-4 w-4 text-terracotta" />
          ) : (
            <Folder className="h-4 w-4 text-terracotta" />
          )}
          <span className="font-medium text-charcoal">{node.name}</span>
          <span className="text-xs text-charcoal/50">({node.totalMealCount})</span>
        </button>
      )}

      {/* Content (meals and subfolders) */}
      {(expanded || depth === 0) && (
        <div className={depth > 0 ? 'ml-2 border-l border-charcoal/10 pl-2' : ''}>
          {/* Meals at this level */}
          {sortedMeals.map((meal) => (
            <button
              key={meal.id}
              onClick={() => onSelectMeal(meal)}
              className="w-full flex items-center gap-3 p-3 hover:bg-white rounded-soft transition-colors text-left"
            >
              {meal.imageUrl ? (
                <img
                  src={meal.imageUrl}
                  alt=""
                  className="w-10 h-10 rounded-soft object-cover flex-shrink-0"
                />
              ) : (
                <div className="w-10 h-10 rounded-soft bg-terracotta/10 flex items-center justify-center flex-shrink-0">
                  <span>{meal.isBaking ? 'üßÅ' : 'üçΩÔ∏è'}</span>
                </div>
              )}
              <span className="font-medium text-charcoal truncate">{meal.name}</span>
              <span className="text-terracotta text-sm ml-auto">‚Üí</span>
            </button>
          ))}

          {/* Child folders */}
          {Array.from(node.children.values()).map((child) => (
            <FolderSection
              key={child.fullPath}
              node={child}
              depth={depth + 1}
              onSelectMeal={onSelectMeal}
            />
          ))}
        </div>
      )}
    </div>
  );
}

export function LoadMealsModal({ isOpen, onClose, meals, onAdd }: LoadMealsModalProps) {
  const [search, setSearch] = useState('');
  const [selectedMeal, setSelectedMeal] = useState<Meal | null>(null);
  const [servings, setServings] = useState(1);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Filter meals that are not baking (main dishes only)
  const mainDishes = useMemo(
    () => meals.filter((m) => !m.isBaking),
    [meals]
  );

  // Build folder tree from main dishes
  const folderTree = useMemo(
    () => buildFolderTree(mainDishes),
    [mainDishes]
  );

  // Search-filtered meals (flat list when searching)
  const searchResults = useMemo(() => {
    if (!search.trim()) return null;
    const searchLower = search.toLowerCase();
    return mainDishes
      .filter((m) => m.name.toLowerCase().includes(searchLower))
      .sort((a, b) => a.name.localeCompare(b.name));
  }, [mainDishes, search]);

  const handleClose = () => {
    setSearch('');
    setSelectedMeal(null);
    setServings(1);
    setError(null);
    onClose();
  };

  const handleSelectMeal = (meal: Meal) => {
    setSelectedMeal(meal);
    setServings(meal.servings);
  };

  const handleBack = () => {
    setSelectedMeal(null);
    setServings(1);
  };

  const handleConfirm = async () => {
    if (!selectedMeal) return;

    setSaving(true);
    setError(null);

    try {
      await onAdd(selectedMeal.id, servings);
      handleClose();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to add meal');
    } finally {
      setSaving(false);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>
      <DialogContent
        showCloseButton={false}
        className="bg-cream rounded-softer max-w-lg max-h-[85vh] overflow-hidden flex flex-col p-0 gap-0"
      >
        {/* Header */}
        <DialogHeader className="sticky top-0 bg-cream border-b border-charcoal/10 px-4 py-3 flex flex-row items-center justify-between z-10 space-y-0">
          <Button
            variant="ghost"
            onClick={selectedMeal ? handleBack : handleClose}
            className="w-11 h-11 rounded-full hover:bg-charcoal/5 text-charcoal p-0"
            aria-label={selectedMeal ? 'Back' : 'Close'}
          >
            <span className="text-2xl">{selectedMeal ? '‚Üê' : '√ó'}</span>
          </Button>
          <DialogTitle className="text-lg font-semibold text-charcoal">
            {selectedMeal ? 'Set Servings' : 'Load Meals'}
          </DialogTitle>
          {selectedMeal ? (
            <Button
              onClick={handleConfirm}
              disabled={saving}
              className="w-11 h-11 rounded-full bg-terracotta text-white hover:bg-terracotta/90 disabled:opacity-50 p-0"
              aria-label="Confirm"
            >
              {saving ? (
                <span className="text-sm">...</span>
              ) : (
                <span className="text-lg font-bold">&#10003;</span>
              )}
            </Button>
          ) : (
            <div className="w-11" />
          )}
        </DialogHeader>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4">
          {error && (
            <div className="bg-red-100 text-red-700 px-4 py-2 rounded-soft text-sm mb-4">
              {error}
            </div>
          )}

          {selectedMeal ? (
            /* Servings Selection */
            <div className="space-y-4">
              {/* Meal Preview */}
              <div className="flex items-center gap-4 p-4 bg-white rounded-soft">
                {selectedMeal.imageUrl ? (
                  <img
                    src={selectedMeal.imageUrl}
                    alt=""
                    className="w-16 h-16 rounded-soft object-cover"
                  />
                ) : (
                  <div className="w-16 h-16 rounded-soft bg-terracotta/20 flex items-center justify-center">
                    <span className="text-2xl">üçΩÔ∏è</span>
                  </div>
                )}
                <div className="flex-1 min-w-0">
                  <h3 className="font-semibold text-charcoal truncate">
                    {selectedMeal.name}
                  </h3>
                  <p className="text-sm text-charcoal/60">
                    Recipe serves {selectedMeal.servings}
                  </p>
                </div>
              </div>

              {/* Servings Input */}
              <div className="space-y-2">
                <label className="text-sm font-medium text-charcoal">
                  How many servings?
                </label>
                <div className="flex items-center gap-4">
                  <Button
                    variant="outline"
                    onClick={() => setServings(Math.max(1, servings - 1))}
                    className="w-12 h-12 rounded-full border-charcoal/20 text-charcoal text-xl"
                    disabled={servings <= 1}
                  >
                    ‚àí
                  </Button>
                  <Input
                    type="number"
                    min={1}
                    max={99}
                    value={servings}
                    onChange={(e) => setServings(Math.max(1, parseInt(e.target.value) || 1))}
                    className="w-20 h-12 text-center text-xl font-medium"
                  />
                  <Button
                    variant="outline"
                    onClick={() => setServings(Math.min(99, servings + 1))}
                    className="w-12 h-12 rounded-full border-charcoal/20 text-charcoal text-xl"
                    disabled={servings >= 99}
                  >
                    +
                  </Button>
                </div>
              </div>
            </div>
          ) : (
            /* Meal List with Folders */
            <div className="space-y-4">
              {/* Search */}
              <Input
                type="text"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Search meals..."
                className="h-11"
              />

              {/* Content */}
              {mainDishes.length === 0 ? (
                <EmptyState
                  icon="üçΩÔ∏è"
                  title="No meals yet"
                  description="Add some meals to your library first!"
                  variant="terracotta"
                />
              ) : searchResults !== null ? (
                /* Search Results (flat list) */
                searchResults.length === 0 ? (
                  <EmptySearch />
                ) : (
                  <div className="space-y-1">
                    {searchResults.map((meal) => (
                      <button
                        key={meal.id}
                        onClick={() => handleSelectMeal(meal)}
                        className="w-full flex items-center gap-3 p-3 bg-white rounded-soft hover:shadow-soft transition-shadow text-left"
                      >
                        {meal.imageUrl ? (
                          <img
                            src={meal.imageUrl}
                            alt=""
                            className="w-10 h-10 rounded-soft object-cover"
                          />
                        ) : (
                          <div className="w-10 h-10 rounded-soft bg-terracotta/10 flex items-center justify-center">
                            <span>üçΩÔ∏è</span>
                          </div>
                        )}
                        <div className="flex-1 min-w-0">
                          <h3 className="font-medium text-charcoal truncate">
                            {meal.name}
                          </h3>
                          {meal.subcategory && (
                            <p className="text-xs text-charcoal/50 truncate">
                              {meal.subcategory}
                            </p>
                          )}
                        </div>
                        <span className="text-terracotta text-sm">‚Üí</span>
                      </button>
                    ))}
                  </div>
                )
              ) : (
                /* Folder Tree */
                <FolderSection node={folderTree} depth={0} onSelectMeal={handleSelectMeal} />
              )}
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

Key features:
- Uses buildFolderTree from subcategoryUtils to organize meals by folder
- FolderSection component renders expandable folder hierarchy
- Shows flat search results when user types in search box
- Filters out baking items (main dishes only)
- Two-step flow: select meal -> set servings -> confirm
- Same modal pattern as AddSnackToWeekModal
  </action>
  <verify>
`npx tsc --noEmit` passes
  </verify>
  <done>
LoadMealsModal component created with folder organization, search, and servings selection
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Home.tsx with new header and buttons</name>
  <files>src/pages/Home.tsx</files>
  <action>
Update src/pages/Home.tsx:

1. Update imports at top (add new imports, remove FloatingActionButton):
```tsx
import { useState } from 'react';
import { useHousehold } from '../hooks/useHousehold';
import { useWeeklyPlan } from '../hooks/useWeeklyPlan';
import { useMeals } from '../hooks/useMeals';
import { useSnacks } from '../hooks/useSnacks';
import { WeeklyMealCard } from '../components/planning/WeeklyMealCard';
import { WeeklySnackCard } from '../components/planning/WeeklySnackCard';
import { AddToWeekModal } from '../components/planning/AddToWeekModal';
import { AddSnackToWeekModal } from '../components/planning/AddSnackToWeekModal';
import { LoadMealsModal } from '../components/planning/LoadMealsModal';
import { EditServingsModal } from '../components/planning/EditServingsModal';
import { EditSnackQtyModal } from '../components/planning/EditSnackQtyModal';
import { ConfirmDialog } from '../components/ui/ConfirmDialog';
import { WeeklyPlanSkeleton, Skeleton } from '../components/ui/skeleton';
import { EmptyWeeklyPlan } from '../components/ui/EmptyState';
import { WeekViewToggle, type ViewMode } from '../components/ui/WeekViewToggle';
import { Button } from '../components/ui/button';
import { Plus } from 'lucide-react';
import type { WeeklyMealEntry, WeeklySnackEntry } from '../types';
```

2. Add viewMode state and LoadMealsModal state (around line 44):
```tsx
const [isAddModalOpen, setIsAddModalOpen] = useState(false);
const [isAddSnackModalOpen, setIsAddSnackModalOpen] = useState(false);
const [isLoadMealsModalOpen, setIsLoadMealsModalOpen] = useState(false);
const [viewMode, setViewMode] = useState<ViewMode>('list');
```

3. Update the hero section (around line 236) to include toggle and Load Meals button:
Replace the existing hero gradient div with:
```tsx
{/* Hero section with gradient */}
<div className="hero-gradient px-4 pt-6 pb-4 mb-4">
  <div className="flex items-start justify-between">
    <div>
      <h1 className="text-2xl font-display font-semibold text-charcoal">
        {formatWeekId(weekId)}
      </h1>
      <p className="text-charcoal/60 text-sm mt-1">
        {weeklyMeals.length} meal{weeklyMeals.length !== 1 ? 's' : ''} ‚Ä¢{' '}
        {weeklySnacks.length} snack{weeklySnacks.length !== 1 ? 's' : ''}
      </p>
    </div>
    <div className="flex items-center gap-2">
      <WeekViewToggle viewMode={viewMode} onToggle={setViewMode} />
      <Button
        onClick={() => setIsLoadMealsModalOpen(true)}
        size="sm"
        className="bg-terracotta text-white hover:bg-terracotta/90"
      >
        <Plus className="h-4 w-4 mr-1" />
        Load Meals
      </Button>
    </div>
  </div>
</div>
```

4. Replace the "Add Snack to Week" button (around line 303-311) with side-by-side Meals and Snacks buttons:
```tsx
{/* Quick Add Buttons */}
<div className="flex gap-3 mt-6">
  <button
    onClick={() => setIsLoadMealsModalOpen(true)}
    className="flex-1 py-3 border-2 border-dashed border-terracotta/40 rounded-soft text-terracotta hover:border-terracotta hover:bg-terracotta/5 transition-colors flex items-center justify-center gap-2"
  >
    <span>üçΩÔ∏è</span>
    <span>Meals</span>
  </button>
  {snacks.length > 0 && (
    <button
      onClick={handleAddSnackClick}
      className="flex-1 py-3 border-2 border-dashed border-sage/40 rounded-soft text-sage hover:border-sage hover:bg-sage/5 transition-colors flex items-center justify-center gap-2"
    >
      <span>üçø</span>
      <span>Snacks</span>
    </button>
  )}
</div>
```

5. REMOVE the FloatingActionButton (lines ~316-319):
Delete:
```tsx
<FloatingActionButton
  onClick={handleAddClick}
  ariaLabel="Add meal to week"
/>
```

6. Add LoadMealsModal after AddSnackToWeekModal (around line 333):
```tsx
<LoadMealsModal
  isOpen={isLoadMealsModalOpen}
  onClose={() => setIsLoadMealsModalOpen(false)}
  meals={meals}
  onAdd={handleAddMealToWeek}
/>
```

7. Also update the loading skeleton hero to include the header controls (around line 189-193):
```tsx
<div className="hero-gradient px-4 pt-6 pb-4 mb-4">
  <div className="flex items-start justify-between">
    <div>
      <h1 className="text-2xl font-display font-semibold text-charcoal">
        {formatWeekId(weekId)}
      </h1>
      <p className="text-charcoal/60 text-sm mt-1">Loading your week...</p>
    </div>
    <div className="flex items-center gap-2">
      <Skeleton className="h-8 w-16 rounded-soft" />
      <Skeleton className="h-8 w-24 rounded-soft" />
    </div>
  </div>
</div>
```

8. Move the Quick Add Buttons outside the hasContent conditional (they should always show when there are meals/snacks in library):
Move the quick add buttons div to after the conditional content block but still inside px-4.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run dev` and verify:
  - Header shows toggle and "Load Meals" button
  - Clicking "Load Meals" opens the modal
  - Meals and Snacks buttons appear side-by-side
  - FAB is gone
  </verify>
  <done>
Home.tsx updated with new header controls, side-by-side quick-add buttons, FAB removed, LoadMealsModal integrated
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Run dev server and verify:
  - Toggle shows in header (list icon selected by default)
  - "Load Meals" button in header opens modal
  - LoadMealsModal shows folder structure
  - Search filters meals in modal
  - "Meals" and "Snacks" buttons side-by-side
  - FAB is removed
  - Clicking "Meals" button also opens LoadMealsModal
</verification>

<success_criteria>
- WeekViewToggle renders with list/calendar icons
- LoadMealsModal displays folder hierarchy using buildFolderTree
- Header shows toggle and Load Meals button
- Quick-add buttons are side-by-side (Meals | Snacks)
- FAB no longer appears on page
</success_criteria>

<output>
After completion, create `.planning/phases/31-home-page-enhancement/31-02-SUMMARY.md`
</output>
